<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-FEDBM7F51Q"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-FEDBM7F51Q');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🍰 ⌨️ 🌰 Chattoの作成の歴史 🧜🏿 💇🏼 💭</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="私たちのチャットは時代遅れです：数年にわたる進化の過程で、誰にも分からない奇妙な修正が施された面倒なView Controllerになりました。 新しいタイプのメッセージを追加することは困難になりましたが、新しいバグは簡単に現れました。 そのため、Swiftのチャットをゼロから書き直して、 オープン...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="sitemap" type="application/xml" href="/sitemap.xml"/>

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

  <script>document.write('<script src="https://pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://tech-in-japan.github.io/index.html"></a>
    <div class="page-header-text">Clever Geek Handbook</div>
  </header>
  <section class="page js-page"><h1>Chattoの作成の歴史</h1><div class="post__text post__text-html js-mediator-article" id="post-content-body" data-io-article-url="https://habr.com/ru/company/badoo/blog/278581/"> 私たちのチャットは時代遅れです：数年にわたる進化の過程で、誰にも分からない奇妙な修正が施された面倒なView Controllerになりました。 新しいタイプのメッセージを追加することは困難になりましたが、新しいバグは簡単に現れました。 そのため、Swiftのチャットをゼロから書き直して、 <a href="https://github.com/badoo/Chatto">オープンソースに</a>配置することにしました。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     プロジェクトの作業を開始し、2つの目標を設定しました。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  <b>スケーラブルなアーキテクチャ</b> ：以前に記述されたコードを犠牲にすることなく、新しいタイプのメッセージを簡単に追加できる機能が必要でした。 </li><li>  <b>優れたパフォーマンス</b> ：メッセージのスムーズな読み込みとスクロールを保証したかった。 </li></ul>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     この記事では、目標をどのように達成したか、どの方法が使用され、最終的に何が行われたかについて詳しく説明します。  <a href="https://github.com/badoo/Chatto">GitHubのページに</a>は、アプリケーションアーキテクチャのかなり詳細な説明があります。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/files/67b/c7f/f27/67bc7ff27b1b4b5e8adbb6ecf5fe68ae.png">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2> どちらが良いですか：UICollectionViewまたはUITableView？ </h2>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     以前のチャットではUITableViewを使用していました。 これは非常に優れていますが、UICollectionViewは、設定（ <a href="https://www.objc.io/issues/12-animations/collectionview-animations/">アニメーション</a> 、 <a href="https://www.objc.io/issues/5-ios7/collection-views-and-uidynamics/">UIDynamics</a>など）および最適化（UICollectionViewLayoutおよびUICollectionViewLayoutInvalidationContext）のオプションを備えたより豊富なAPIを提供します。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     さらに、複数の既存のチャットアプリケーションを<a href="http://petersteinberger.com/blog/2013/how-to-inspect-the-view-hierarchy-of-3rd-party-apps/">調査</a>した結果、すべてが正確にUICollectionViewを使用していることがわかりました。 したがって、UICollectionViewの選択を支持する決定は当たり前のことでした。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2> テキストメッセージ </h2>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     テキストクラウドなしではチャットはできません。 実際、パフォーマンスの観点から、このタイプのメッセージは、テキストのレンダリングとスケーリングが遅いため、実装が最も困難です。  iMessageのように、チャットがリンクを自動的に検出し、定期的なアクティビティを実行することを望んでいました。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      UITextViewは当初これらすべての要件をサポートしているため、リンクを処理するために1行のコードを記述する必要はありません。 そのため、このクラスを選択しましたが、このソリューションは問題の原因になりました。 次に、理由を説明します。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2> 自動レイアウトとセルのサイズ変更 </h2>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     レイアウトとサイズの計算は常に困難を引き起こします。複製コードを書くのは非常に簡単で、維持するのがより難しく、バグの出現につながるので、これを避けようとしました。 当初からiOS 8のサポートを提供していたため、自動レイアウトとセルのサイズ変更を試してみることにしました。 このアプローチの実装の一般的な説明を<a href="https://github.com/diegosanchezr/Chatto/tree/badoo-blog-autolayout-try">含む</a>ブランチを<a href="https://github.com/diegosanchezr/Chatto/tree/badoo-blog-autolayout-try">次に示し</a>ます。 試したところ、2つの大きな問題が発生しました。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  <b>スクロール中にジャンプし</b>ます。 通常、チャットでは下から上にスクロールが行われるため、最初は下のセルのサイズがカウントされ、スクロール中は上から表示されるセルのサイズがカウントされます。 同時に、上部にあるセルの正確なサイズは事前にわからないため、UICollectionViewは指定されたtimatedItemSizeを使用してcontentSizeと下位セルの位置を計算します。 正確なセルサイズを取得するために、UICollectionViewFlowLayoutはUICollectionViewCellでpreferredLayoutAttributesFittingAttributes（_ :)メソッドを呼び出します。 次に、このサイズは指定されたtimatedItemSizeに対応していないため、以前に作成されたセルの位置が調整され、その結果、セルが下に移動します。  UICollectionViewとUICollectionViewCellsを180度回転させることでこのバグを回避できました（実際には下部のセルが上部のセルになります）が、別の問題、つまり... </li><li>  <b>スクロール性能が低い</b> 。 セルサイズを正確に計算しても、1秒あたり60フレームの速度でスクロールすることはできませんでした。 ボトルネックは、自動レイアウトとUITextViewのサイズ変更でした。  AppleがiMessageのセル内で自動レイアウトを使用しないことを知っていたので、私たちはそれほど驚いていませんでした。 このため、自動レイアウトを使用すべきではありません。 実際、Badooでは非常に広く使用されています。 ただし、パフォーマンスの問題があり、通常はUICollectionViewとUITableViewに影響します </li></ul>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2> 手動レイアウト </h2>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     そのため、自動レイアウトではなくレイアウトのために、従来のアプローチを使用することにしました。 空白セルを使用してサイズを計算し、レイアウトとサイズをカウントするために、できるだけ多くの一般的なコードを使用する古典的な方法に決めました。 このアプローチははるかに高速に動作しましたが、iPhone 4sにはまだ十分ではありませんでした。  <a href="https://yalantis.com/blog/mastering-uikit-performance/">プロファイリング</a>により、layoutSubviewsメソッド内の作業が多すぎることが判明しました。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     実際、同じジョブを2回実行しました。最初は空白のサイズをカウントしてから、layoutSubviews内の実際のセルで再度実行しました。 この問題を解決するために、UITextViewのsizeThatFits（_ :)値をキャッシュできますが、これは計算が非常に高価ですが、さらに進んで、すべてのサブビューのセルサイズとフレームが計算されてキャッシュされるレイアウトモデルを作成しました。 その結果、スクロール速度を大幅に向上させるだけでなく、sizeThatFits（_ :)とlayoutSubviewsの呼び出し間でコードを最大限の効率で再利用することができました。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     さらに、updateViewsメソッドが注目を集めました。 小さいサイズでは、これは、指定されたスタイルと表示されるデータのタイプに従ってセルを更新する主要なメソッドの1つであることが判明しました。  UIを更新するための1つの主な方法の存在により、将来のコードのロジックとメンテナンスが簡素化されましたが、同時に、セルのプロパティを変更するほとんどすべてのアクションに対して呼び出されました。 この問題に対処するために、最適化する2つの方法を考え出しました。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  <b>2つの異なるコンテキスト</b> ：.Normalと.Sizing。 空白セルに.Sizingコンテキストを使用して、いくつかの冗長なupdateViews呼び出しをスキップしました（たとえば、クラウドイメージの更新やUITextViewでのリンク検出の無効化）。 </li><li>  <b>バッチ更新</b> ：セルにperformBatchUpdates（_：animated：completion）関数を実装しました。 これにより、必要な回数だけセルのプロパティを更新できましたが、同時にupdateViewsを呼び出すのは一度だけです。 </li></ul>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2> さらに高速 </h2>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     すでに十分なスクロール速度を達成していますが、より多くのメッセージ（50単位のパッケージ）を読み込むと、メインスレッドが長時間ブロックされ、その結果、スクロールが一瞬停止しました。 もちろん、UITextView.sizeThatFits（_ :)関数もボトルネックでした。 リンクを検出して空白セルのテキストを選択する機能を無効にし、非連続レイアウトを有効にすることで、処理を大幅に高速化することができました。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="objectivec hljs">textView.layoutManager.allowsNonContiguousLayout = <span class="hljs-literal"><span class="hljs-literal">true</span></span> textView.dataDetectorTypes = .None textView.selectable = <span class="hljs-literal"><span class="hljs-literal">false</span></span></code>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
     </pre> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     その後、50個の新しいメッセージを同時に表示することは問題ではなくなりました。ただし、それ以前にはあまりメッセージがなかったことが前提です。 しかし、さらに先へ進むことができると判断しました。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     サイズと位置を計算するタスクを実行するためにレイアウトモデルをキャッシュして再利用することによって達成された抽象化のレベルを考慮すると、バックグラウンドスレッドで計算を実行するために必要なものがすべて揃いました。 しかし... ... UIKitはカウントしません。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     ご存知のように、UIKitはスレッドセーフではなく、元の戦略（単にこの事実を無視することでした）により、予想される多くのUITextViewクラッシュが発生しました。  NSString.boundingRectWithSize（_：options：attributes：context）メソッドをバックグラウンドで使用できることはわかっていましたが、返されるサイズはUITextView.sizeThatFits（_ :)から取得したサイズと一致しませんでした。 私たちは多くの時間を費やしましたが、それでも解決策を見つけることができました。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> <code class="objectivec hljs"> textView.textContainerInset = <span class="hljs-built_in"><span class="hljs-built_in">UIEdgeInsetsZero</span></span> textView.textContainer.lineFragmentPadding = <span class="hljs-number"><span class="hljs-number">0</span></span></code>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
     </pre>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      NSString.boundingRectWithSize（_：オプション：属性：コンテキスト）から取得したサイズの丸めを使用して、ピクセルをスクリーンします 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> <code class="objectivec hljs">extension <span class="hljs-built_in"><span class="hljs-built_in">CGSize</span></span> { func bma_round() -&gt; <span class="hljs-built_in"><span class="hljs-built_in">CGSize</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">CGSize</span></span>(width: ceil(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.width * scale) * (<span class="hljs-number"><span class="hljs-number">1.0</span></span> / scale), height: ceil(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.height * scale) * (<span class="hljs-number"><span class="hljs-number">1.0</span></span> / scale) ) } }</code>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
     </pre>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     したがって、キャッシュをバックグラウンドスレッドで準備し、レイアウトが5000メッセージを処理する必要がない限り、メインスレッドのすべてのサイズを非常に迅速に取得できます。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     この場合、UICollectionViewLayout.prepareLayout（）メソッドが呼び出されると、iPhone 4sの速度が低下し始めました。 主なボトルネックは、UICollectionViewLayoutAttributesの作成とNSCacheからの5,000メッセージのサイズ設定でした。 この問題をどのように解決しましたか？ セルと同じことを行いました。UICollectionViewLayoutAttributesの作成に関与するUICollectionViewLayoutのモデルを作成し、同様にその作成をバックグラウンドストリームに転送しました。 ここで、メインスレッドで、古いモデルを新しいモデルに単純に置き換えました。 そして、すべてが驚くほど速く動作し始めましたが、... 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2> 回転と分割ビュー </h2>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     デバイスの回転または分割ビューのサイズ変更中に、メッセージを表示するために使用可能な幅が変更されたため、メッセージのすべてのサイズと位置を再度読み取る必要がありました。 このアプリケーションは回転をサポートしていないため、これは特に問題になりませんでしたが、すでにChattoをオープンソースでリリースし、回転と分割ビューの適切なサポートがこれらの目的に大きなプラスになると判断しました。 そのときまでに、バックグラウンドスレッドでサイズの計算を既に実装しており、スムーズなスクロールと新しいメッセージの読み込みを行っていましたが、アプリケーションが10,000メッセージを処理しなければならない場合はあまり役に立ちませんでした。 バックグラウンドでのこのような多数のメッセージのサイズを計算するために、iPhone 4sは10〜20秒かかりました。もちろん、ユーザーをそれほど待たせることはできませんでした。 問題を解決する2つの方法を見ました。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li> 寸法を2回計算します。1回目は現在の幅で、2回目はデバイス上のメッセージが90度回転した後に受け入れる幅です。 </li><li>  10,000件のメッセージを処理する必要はありません。 </li></ul>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     最初のオプションは、ソリューション自体よりもハックです-スプリットビューモードでは実際には役に立たず、スケールしません。 したがって、2番目の方法を選択しました。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2> スライディングデータソース </h2>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      iPhone 4sでのいくつかのテストの後、高速ローテーションのサポートは500メッセージ以下の処理を意味するという結論に達しました。そこで、カスタマイズ可能な数のメッセージを同時に表示する移動データソースを実装しました。 したがって、チャットを開くと、最初に50のメッセージをロードする必要があり、その後、ユーザーがチャットをスクロールして以前のレコードを表示すると、50のメッセージの次の部分がロードされます。 ユーザーが十分な数のメッセージをスクロールバックすると、最初のメッセージがメモリから削除されました。 したがって、ページネーションは両方の方法で機能しました。 このメソッドの実装は非常に簡単なタスクでしたが、別のケースで問題が発生しました。データソースが既にいっぱいで、新しいメッセージが到着したときです。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     すでに500件のメッセージを受信して​​新しいメッセージを受信した場合、一番上のメッセージを削除し、他のすべてのメッセージを1つ上に移動して、到着したチャットに挿入する必要がありました。 これを解決するのに困難はありませんでしたが、UICollectionView.performBatchUpdates（_：completion :)メソッドはこのアプローチを好みませんでした。 主に2つの問題がありました（ <a href="https://github.com/diegosanchezr/Chatto/tree/badoo-blog-sliding-datasource-glitches">ここ</a>で再現でき<a href="https://github.com/diegosanchezr/Chatto/tree/badoo-blog-sliding-datasource-glitches">ます</a> ）。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li> 多数の新しいメッセージを受信したときの遅いスクロールとジャンプ。 </li><li>  contentOffsetの変更により、投稿を追加するときにアニメーションが壊れます。 </li></ul>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     これらの問題に対処するために、許可されるメッセージの最大数の制限を緩和することにしました。 これで、アプリケーションが新しいメッセージを挿入できるようになり、設定された制限に違反し、UICollectionViewのスムーズな更新が保証されました。 挿入を完了した後、更新キューに未処理の変更がない場合、データソースに到着するメッセージが多すぎるという警告を送信しました。 その後、performBatchUpdatesではなくreloadDataを使用して必要な調整を行いました。 これが起こる瞬間を実際に制御することはできず、ユーザーがチャットを任意の位置にスクロールできることを考慮して、現在表示されているメッセージを削除しないように、ユーザーがチャットをスクロールした場所をデータソースに伝える必要がありました： 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> <code class="objectivec hljs">public protocol ChatDataSourceProtocol: <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> { ... func adjustNumberOfMessages(preferredMaxCount preferredMaxCount: Int?, focusPosition: Double, completion:(didAdjust: Bool) -&gt; Void) }</code>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
     </pre>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2> カーキUITextView </h2>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     そのため、これまで、自動レイアウトのパフォーマンスとサイズ計算の問題だけでなく、NSString.boundingRectWithSize（_：options：attributes：context）を使用してバックグラウンドスレッドでサイズを計算する問題を解決するための障害のみを考慮してきました。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     リンク検出機能と他の利用可能なアクションを利用するには、UITextView.selectableプロパティをアクティブにする必要がありました。 これにより、雲に望ましくない副作用が発生しました（たとえば、テキストを選択する機会や虫眼鏡の外観）。 さらに、これらの機能をサポートするために、UITextViewはジェスチャ認識システムを使用して、テキストクラウドの選択やその内部での長いクリックの処理などのアクションを妨害します。 ハックの助けを借りてこれらの問題をどのように回避したかについては詳しく説明しませんが、 <a href="https://github.com/badoo/Chatto/blob/ea3dc6b79adb0df07ff3578a919a039a25eb4549/ChattoAdditions/Source/Chat%2520Items/TextMessages/Views/TextBubbleView.swift">ChatMessageTextView</a>と<a href="https://github.com/badoo/Chatto/blob/ea3dc6b79adb0df07ff3578a919a039a25eb4549/ChattoAdditions/Source/Chat%2520Items/BaseMessage/BaseMessagePresenter.swift">BaseMessagePresenterの</a>リンクをたどることで詳細を知ることができます。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2> インタラクティブキーボード </h2>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     前述の問題に加えて、UITextViewの操作もキーボードに影響しました。 理論的には、最近では対話型キーボードの非表示の実装は非常に簡単な作業になります。  <a href="https://robots.thoughtbot.com/input-accessorizing-uiviewcontroller">ここに</a>示すように、使用するコントローラーのinputAccessoryViewとcanBecomeFirstResponderをオーバーライドするだけで十分<a href="https://robots.thoughtbot.com/input-accessorizing-uiviewcontroller">です</a> 。 ただし、ユーザーが任意のリンクをクリックしているときにUITextViewからUIActionSheetを表示すると、このメソッドは非効率的に機能しました。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     問題の本質は、メニューがキーボードの下に表示され、まったく表示されないことでした。 この問題を<a href="https://openradar.appspot.com/radar%3Fid%3D4992538469466112">自分で操作</a>できる別の<a href="https://github.com/diegosanchezr/Chatto/tree/badoo-blog-uitextview-keyboard-bug">スレッドを</a>次に示し<a href="https://openradar.appspot.com/radar%3Fid%3D4992538469466112">ます</a> （ <a href="https://openradar.appspot.com/radar%3Fid%3D4992538469466112">rdar：// 23753306</a> ）。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     入力フィールドをView Controller階層の一部にし、キーボードからの通知を追跡し、UICollectionViewのcontentInsetsを手動で変更しようとしました。 ただし、ユーザーがキーボードを操作したとき、通知は受信されず、入力フィールドは画面の中央に表示され、ユーザーがキーボードを下に引いたときにユーザーとキーボードの間に隙間が残りました。 この問題は、ダミーのinputAccessoryView（入力フィールドの下にある）を使用し、KVOを使用してそれを観察するという特別なハックを使用して解決されます。 詳細については、 <a href="https://medium.com/ios-os-x-development/a-stickler-for-details-implementing-sticky-input-fields-in-ios-f88553d36dab">こちらをご覧ください</a> 。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2> まとめ </h2>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li> 自動レイアウトを使用しようとしましたが、パフォーマンスが不十分なため、手動レイアウトに切り替える必要がありました。 </li><li> 独自のポジショニングモデルに到達しました。これにより、layoutSubViewsとsizeThatFits（_ :)のコードを再利用でき、バックグラウンドでレイアウトの計算も実装できました。 私たちが見つけた解決策は、 <a href="http://asyncdisplaykit.org/">AsyncDisplayKit</a>プロジェクトのいくつかのアイデアと何らかの<a href="http://asyncdisplaykit.org/">形</a>で一致したことが<a href="http://asyncdisplaykit.org/">わかり</a>ました。 </li><li> ビューの更新回数を最小限に抑えるために、performBatchUpdates（_：animated：completion）メソッドと2つの個別のセルコンテキストを実装しました。 </li><li> コード内のメッセージの数を制限した移動データソースを実装しました。これにより、デバイスが回転し、Split Viewモードが切り替えられたときに高速スケーリングを実現します。 </li><li>  UITextViewは非常に使いにくいことが判明しましたが、リンク検出機能により、古いデバイス（iPhone 4s）でのスクロール中にパフォーマンスを低下させるボトルネックのままです。 それでも、リンクを操作するときに定期的なアクションを実行する機能が必要だったため、引き続き使用しました。 </li><li>  UITextViewのため、KVOでダミーのinputAccessoryViewを観察することで、手動で対話型キーボードの非表示を実装する必要がありました。 </li></ul>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <i>Badoo iOS開発チーム</i> </div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../J278573/index.html">iOS 9（Swift）のAdaptive Split View ControllerおよびPopover。 パート1</a></li>
<li><a href="../J278575/index.html">スーパースカラースタックプロセッサ：ヘビとハリネズミの交差</a></li>
<li><a href="../J278577/index.html">簡単な1Cデータベースリスト管理の自動化</a></li>
<li><a href="../J278579/index.html">クロスプラットフォームアプリケーションを開発するためのSDKとしてChromiumプロジェクトのコードベースを使用する</a></li>
<li><a href="../J27858/index.html">ノキア、Plazesのソーシャルネットワークを買収</a></li>
<li><a href="../J278583/index.html">1CからFireBirdを操作します。 実績のあるレシピ集</a></li>
<li><a href="../J278589/index.html">libuniset2-ACSを作成するためのライブラリ。 一度見たほうがいい...パート4（セットアップ）</a></li>
<li><a href="../J27859/index.html">実際の売上高によるタグライン評価</a></li>
<li><a href="../J278593/index.html">Web標準について知る。 オーディオを操作します。 -ビデオと作成ストーリー</a></li>
<li><a href="../J278595/index.html">SQLでレポートを作成するためのエンジン。 アイデア</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter70218013 = new Ya.Metrika({
                  id:70218013,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/70218013" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'G-FEDBM7F51Q', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Clever Geek | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <div class="company-info js-company-info" itemscope="" itemtype="http://schema.org/Organization">
      <span itemprop="name">Western Town Media (WTM)</span>
      <div itemprop="address" itemscope="" itemtype="http://schema.org/PostalAddress">
        <span itemprop="streetAddress">1968 Stoney Lonesome Road</span>
        <br>
        <span itemprop="postalCode">PA 18640</span>
        <span itemprop="addressLocality">Pittston, USA</span>
      </div>
      <span itemprop="telephone">570-362-1316</span>
    </div>
    <script type="application/ld+json">
      {
        "@context": "http://schema.org",
        "@type": "Organization",
        "address": {
          "@type": "PostalAddress",
          "addressLocality": "Pittston, USA",
          "postalCode": "PA 18640",
          "streetAddress": "1968 Stoney Lonesome Road"
        },
        "name": "Western Town Media (WTM)",
        "telephone": "570-362-1316"
      }
    </script>
  </div>
</footer>
  
</body>

</html>