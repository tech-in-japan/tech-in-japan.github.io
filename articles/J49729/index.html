<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-FEDBM7F51Q"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-FEDBM7F51Q');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🚴🏽 💇🏿 🏇🏿 CでフラッシュBluetoothソケットを作成する方法（Linux）？ 🧒🏿 🏜️ 🌊</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="昨日、ファイルを送信するときに、モバイルクライアント（Symbian 9.1、Series 60のMobile Python）と通信するサーバープログラム（Fedora 10、C）が失敗し始めたという事実に直面しました。 
  
 
  
 _____________________________...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="sitemap" type="application/xml" href="/sitemap.xml"/>

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

  <script>document.write('<script src="https://pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://tech-in-japan.github.io/index.html"></a>
    <div class="page-header-text">Clever Geek Handbook</div>
  </header>
  <section class="page js-page"><h1>CでフラッシュBluetoothソケットを作成する方法（Linux）？</h1><div class="post__text post__text-html js-mediator-article" id="post-content-body" data-io-article-url="https://habr.com/ru/post/49729/"> 昨日、ファイルを送信するときに、モバイルクライアント（Symbian 9.1、Series 60のMobile Python）と通信するサーバープログラム（Fedora 10、C）が失敗し始めたという事実に直面しました。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      _____________________________________________________ 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <i><b>PS：</b>誰もアドバイスをくれなかったのは残念です...しかし、彼女自身はそれを理解しました。</i>  <i>write（）関数によって返される値を制御する必要があることがわかりました。実際、プログラムが送信しようとしたバイト数よりも少ないバイト数を送信できます。</i>  <i>バイトの配列を送信しようとすると、実際に送信されたバイト数を確認する価値があります。</i> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      _____________________________________________________ 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a> 昨日まで失敗はありませんでした。 同時に、サーバープログラムのデバッグプリントは、ファイルが完全に送信されたことを示します。 クライアントアプリケーションのデバッグ印刷は、ファイルが完全に読み取られていないことを示しています。 クライアントとサーバーのコードは変更されず、コンピューターと電話のソフトウェアを更新しませんでした。新しいものをインストールしませんでした。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     他のファイルは、同じプログラムによってサーバーから電話に完全に送信され、その逆も同様です。 問題は、送信されたjarファイルの新しいバージョンにのみあります。20Kから38Kに増加しました。 送信されたファイルのコードを見て、FFのようなバイトの転送が中断されたかどうかを確認しました-いいえ、この時点でバイトのシーケンスは非常に普通でした：... 00 60 <b>39</b> 00 00 ...（39-最後に送信されたバイト）。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     問題はソケットへの出力のバッファリングにあると思われます。サーバーはすべての情報を送信しなかったため、クライアントは情報の全量が送信されるのを待ちます。 サーバーとクライアントを毎日継続的に使用していることは奇妙ですが、このエラーは初めて現れました。 しかし、私はまだフラッシュソケットを作成する方法を見つけていません（fflush（bt-&gt; socketClient）はセグメンテーションエラーを与えます-そして、私が理解するように、以下に説明する方法で作成されたソケットには適用できません）。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     ソケットを作成し、それを介してファイルを送信しようとするコードは次のとおりです。 <pre>  struct BT_SDESC {
  符号なし文字チャネル。
   unsigned int uuid;
   char * serviceName;
   char * serviceDescription;
   char * serviceProvider;
   void *セッション;
   int hciID;
 };

 // Bluetoothサーバー
 BT_SRV構造体{
   struct BT_SDESC * sd;
   int socketClient;
   int socketServer;
 };

 ...

 struct BT_SDESC * btBuildSDesc（intチャネル）{
   struct BT_SDESC * sd;
   sd =（struct BT_SDESC *）malloc（sizeof（struct BT_SDESC））;
   if（！sd）{
     NULLを返します。
   }
   memset（sd、0、sizeof（struct BT_SDESC））;
   sd-&gt; channel = channel;
   sd-&gt; uuid = 0xAFFF;  / * TODO：この値を確認してください* /
   if（！（sd-&gt; serviceName = strdup（ "TeleComp：W-Shell"））
     ||  ！（sd-&gt; serviceDescription = strdup（「ウェアラブルコンピューターのユーザーシェル」））
     ||  ！（sd-&gt; serviceProvider = strdup（ "kiborgov.net"））
     ）{
     btDestroySDesc（sd）;
     NULLを返します。
   }
   sdを返します。
 }

 int btSDescribe（struct BT_SDESC * sd）{
   uint32_t serviceUuidInt [] = {0,0,0、sd-&gt; uuid};
   uuid_t serviceUuid、rootUuid、l2capUuid、rfcommUuid;
   sdp_record_t * record = sdp_record_alloc（）;
   sdp_session_t * session = NULL;
   sdp_list_t * rootList = NULL、* svClassID = NULL、* profilesList = NULL、* l2capList = NULL、* protocolList = NULL、* rfcommList = NULL、* accessProtocolList = NULL;
   sdp_profile_desc_tプロファイル;
   sdp_data_t * channel = NULL;
   int ret = -2;

   / *一般サービスIDを設定* /
   sdp_uuid128_create（＆serviceUuid、＆serviceUuidInt）;
   sdp_set_service_id（レコード、serviceUuid）;

   / *公共サービスの記録* /
   sdp_uuid16_create（＆rootUuid、PUBLIC_BROWSE_GROUP）;
   rootList = sdp_list_append（0、＆rootUuid）;
   sdp_set_browse_groups（レコード、rootList）;

   / *ポート属性を設定* /
   sdp_uuid16_create（＆rootUuid、SERIAL_PORT_SVCLASS_ID）;
   svClassID = sdp_list_append（0、＆rootUuid）;
   sdp_set_service_classes（レコード、svClassID）;

   sdp_uuid16_create（＆profile.uuid、SERIAL_PORT_PROFILE_ID）;
   profile.version = 0x100;
   profilesList = sdp_list_append（0、＆profile）;
   sdp_set_profile_descs（レコード、profilesList）;

   / * l2cap情報を設定* /
   sdp_uuid16_create（＆l2capUuid、L2CAP_UUID）;
   l2capList = sdp_list_append（0、＆l2capUuid）;
   protocolList = sdp_list_append（0、l2capList）;

   / * rfcomm情報を設定* /
   sdp_uuid16_create（＆rfcommUuid、RFCOMM_UUID）;
   channel = sdp_data_alloc（SDP_UINT8、＆（sd-&gt; channel））;
   rfcommList = sdp_list_append（0、＆rfcommUuid）;
   sdp_list_append（rfcommList、チャンネル）;
   sdp_list_append（protocolList、rfcommList）;

   / *サービスレコードにプロトコル情報を添付* /
   accessProtocolList = sdp_list_append（0、protocolList）;
   sdp_set_access_protos（レコード、accessProtocolList）;

   / *名前、プロバイダー、説明を設定* /
   sdp_set_info_attr（レコード、sd-&gt; serviceName、sd-&gt; serviceProvider、sd-&gt; serviceDescription）;

   / *ローカルSDPサーバーを接続し、サービスレコードを登録してから切断します* /
   if（（session = sdp_connect（BDADDR_ANY、BDADDR_LOCAL、SDP_RETRY_IF_BUSY）））{
     ret = sdp_record_register（セッション、レコード、0）;
   }

   / *割り当てられたリソースを解放* /
   sdp_data_free（チャネル）;
   sdp_list_free（l2capList、0）;
   sdp_list_free（rfcommList、0）;
   sdp_list_free（rootList、0）;
   sdp_list_free（accessProtocolList、0）;
   sdp_list_free（svClassID、0）;
   sdp_list_free（profilesList、0）;

   sd-&gt; session =（void *）session;

   return ret;
 }

 int btBuildSocket（unsigned intチャネル、struct BT_SDESC * sd）{
   struct sockaddr_rc localAddr;
   int s = -1、res = -1;

   if（（sd-&gt; hciID = btCheckDevice（））==-1）{
     return -1;
   }
   if（hci_open_dev（sd-&gt; hciID）&lt;0）{
     return -1;
   }
   hci_close_dev（sd-&gt; hciID）;
   memset（＆localAddr、0、sizeof（struct sockaddr_rc））;
   if（（s = socket（AF_BLUETOOTH、SOCK_STREAM、BTPROTO_RFCOMM））==-1）{
     return -1;
   }

   / * TODO：以下のコードをSDPを使用するコードに置き換えてください* /
   localAddr.rc_family = AF_BLUETOOTH;
   localAddr.rc_bdaddr = * BDADDR_ANY;
   localAddr.rc_channel =（uint8_t）チャネル;
   if（（res = bind（s、（struct sockaddr *）＆localAddr、sizeof（localAddr）））==-1）{
    閉じる（s）;
     return -1;
   }

   return s;
 }

 struct BT_SRV * btStartServer（intチャネル）{
   struct BT_SRV * bt = malloc（sizeof（struct BT_SRV））;
   if（！bt）{
     btErr = BT_ERR_START_SERVER;
     btKillServer（bt）;
     NULLを返します。
   }
   memset（bt、0、sizeof（struct BT_SRV））;
   bt-&gt; socketServer = bt-&gt; socketClient = -1;
   btErr = BT_OK;

   if（btCheckDevice（）&lt;0）{
     btErr = BT_ERR_NO_DEVICE;
     btKillServer（bt）;
     NULLを返します。
   }

   if（！（bt-&gt; sd = btBuildSDesc（channel）））{
     btErr = BT_ERR_SDESC_CREATION;
     btKillServer（bt）;
     NULLを返します。
   }

   if（btSDescribe（bt-&gt; sd）==-1）{
     btErr = BT_ERR_SDESC_REGISTRATION;
     btKillServer（bt）;
     NULLを返します。
   }

   if（（bt-&gt; socketServer = btBuildSocket（channel、bt-&gt; sd））==-1）{
     btErr = BT_ERR_BUILD_SOCKET;
     btKillServer（bt）;
     NULLを返します。
   }

   if（listen（bt-&gt; socketServer、10））{
     btErr = BT_ERR_SOCKET_LISTENING;
     btKillServer（bt）;
     NULLを返します。
   }
   return bt;
 }

 ...

 struct BT_SRV * bt = NULL;

 int sendFileToClient（char * fname）{
   static char buf [1024];
   int h;
   long int bufsize = 1024;
   long int sent = 0;
   long intがロードされました。
   struct stat stbuf;
 logPrint（ "ファイルの送信\"％s \ "クライアントへ。"、fname）;
   if（stat（fname、＆stbuf）==-1）{
 logPrint（ "エラー：ファイル情報を取得できません。"）;
     return -1;
   }
   if（（h = open（fname、O_RDWR））&lt;1）{
 logPrint（ "エラー：ファイルを開けません。"）;
     return -2;
   }
   sprintf（buf、「％010ld」、stbuf.st_size）;
 logPrint（ "Sending％ld bytes of data ..."、stbuf.st_size）;
  書き込み（bt-&gt; socketClient、buf、10）;
   while（送信済み&lt;stbuf.st_size）{
     loaded =（stbuf.st_size&gt; bufsize）？bufsize：stbuf.st_size;
     loaded = read（h、＆buf、loaded）;
     if（loaded &lt;1）{
      休憩;
     }
    送信済み= =ロード済み。
    書き込み（bt-&gt; socketClient、buf、loaded）;
 logPrint（ "送信済み：％ld"、送信済み）;
   }
  閉じる（h）;
 logPrint（「ファイルが送信されました。％ldバイトが送信されました。」、送信）;
  返送済み;
 }

 ...

   bt = btStartServer（cfgBtChannel）;
   ...
   bt-&gt; socketClient = accept（bt-&gt; socketServer、NULL、NULL）;
   fcntl（bt-&gt; socketClient、F_SETFL、O_NONBLOCK）;
   sendFileToClient（ "./ projects / cloud / bin / Cloud.jar"）;
</pre>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     クラッシュが発生するファイル転送は、1つの（場合の80％で）ファイルの場所で中断し、2番目（残りの20％で）で中断します。 </div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../J49717/index.html">OS使用統計</a></li>
<li><a href="../J49718/index.html">MVCフレームワーク：初心者向けの優れた入門書</a></li>
<li><a href="../J49720/index.html">Windows 7の試用期間を120日間に延長する方法</a></li>
<li><a href="../J49723/index.html">地球人のための関数型プログラミング-関数</a></li>
<li><a href="../J49724/index.html">EntroPay-インターネット上のクレジットカードで支払う</a></li>
<li><a href="../J49734/index.html">HTML 5のセマンティクス</a></li>
<li><a href="../J49735/index.html">AviSynthの紹介</a></li>
<li><a href="../J49738/index.html">第6回StartApers国際会議（1月25日、モスクワ、ケルトクラブ）</a></li>
<li><a href="../J49744/index.html">Microsoft Web Platform Installerリリース</a></li>
<li><a href="../J49747/index.html">今日、私はガールフレンドをクイップに感染させました;-)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter70218013 = new Ya.Metrika({
                  id:70218013,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/70218013" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'G-FEDBM7F51Q', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Clever Geek | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <div class="company-info js-company-info" itemscope="" itemtype="http://schema.org/Organization">
      <span itemprop="name">Western Town Media (WTM)</span>
      <div itemprop="address" itemscope="" itemtype="http://schema.org/PostalAddress">
        <span itemprop="streetAddress">1968 Stoney Lonesome Road</span>
        <br>
        <span itemprop="postalCode">PA 18640</span>
        <span itemprop="addressLocality">Pittston, USA</span>
      </div>
      <span itemprop="telephone">570-362-1316</span>
    </div>
    <script type="application/ld+json">
      {
        "@context": "http://schema.org",
        "@type": "Organization",
        "address": {
          "@type": "PostalAddress",
          "addressLocality": "Pittston, USA",
          "postalCode": "PA 18640",
          "streetAddress": "1968 Stoney Lonesome Road"
        },
        "name": "Western Town Media (WTM)",
        "telephone": "570-362-1316"
      }
    </script>
  </div>
</footer>
  
</body>

</html>