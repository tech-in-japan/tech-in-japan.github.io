<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-FEDBM7F51Q"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-FEDBM7F51Q');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🙇 👰🏽 🎅🏽 Linux上のZFS-それほど単純ではない 🔂 🥋 😿</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="「Linux上のZFS-簡単でシンプル」という記事を読んだ後、LinuxサーバーのペアでこのFSを使用するささやかな経験を共有することにしました。 
  
 
  
 最初は-余談。 ZFSはクールです。 これは非常にクールで、イデオロギー的に異なるプラットフォームから移植されたFSのすべての欠点を...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="sitemap" type="application/xml" href="/sitemap.xml"/>

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

  <script>document.write('<script src="https://pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://tech-in-japan.github.io/index.html"></a>
    <div class="page-header-text">Clever Geek Handbook</div>
  </header>
  <section class="page js-page"><h1>Linux上のZFS-それほど単純ではない</h1><div class="post__text post__text-html js-mediator-article" id="post-content-body">  <a href="http://habrahabr.ru/post/152853/">「Linux上のZFS-簡単でシンプル」</a>という記事を読んだ後、LinuxサーバーのペアでこのFSを使用するささやかな経験を共有することにしました。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     最初は-余談。  ZFSはクールです。 これは非常にクールで、イデオロギー的に異なるプラットフォームから移植されたFSのすべての欠点をカバーしています。  SolarisカーネルはLinux以外のプリミティブと連携するため、開発者はSolarisコードを使用してZFSを移行できるようにするために、Solaris Porting Layer SPL互換性レイヤーを作成しました。 このレイヤーは正常に機能するように見えますが、カーネルモードでは追加のコードであり、クラッシュの原因になる可能性があります。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a>  ZFSはLinux VFSと完全には互換性がありません。 たとえば、アクセス制御リストをPOSIX APIおよびSambaが気に入らないgetfacl / setfaclコマンドを使用して管理することはできません。getfacl/ setfaclコマンドはACLにNTFSアクセス許可を保存します。 したがって、Sambaフォルダーおよびファイルへの通常のアクセス許可の設定は失敗します。 理論的には、SambaはZFS ACLをサポートしていますが、Linux用のこのモジュールはまだ構築する必要があります...しかし、Linux上のZFSの拡張FS属性は存在し、正常に動作します。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     さらに、32ビット版のSolarisは、Linuxとは異なるメモリ割り当てメカニズムを使用します。 したがって、x86_64ではなくx86アーキテクチャ上のLinuxでZFSを試してみることにした場合は、グリッチに備えてください。 初歩的な操作のためのCPU使用率が100％になり、dmesgで何キロメートルものエラーが発生するのを待っています。  Linux開発者のZFSは次のように書いています。「64ビットカーネルを使用することを強くお勧めします。 現時点では、zfsは32ビット環境でビルドされますが、安定して実行されません。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      ZFSは一種の「それ自体」であり、Linuxには一般的ではないメタデータパラメーターに格納されます。 たとえば、FSのマウントポイントの名前はその設定で設定され、FS自体はzfs mountコマンドでマウントされます。これにより、/ etc / fstabおよびLinuxでFSをマウントする他の方法と自動的に互換性がなくなります。 もちろん、mountpoint = legacyを設定してマウントを使用することもできますが、これは認めなくてはならないことです。  Ubuntuでは、ZFS固有のマウントスクリプトとパッチが適用されたマウントコマンドを含むmountallパッケージによって問題が解決されます。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     次の問題は、システムのスナップショット、いわゆるスナップショットです。 一般に、ZFSには非常に効果的なスナップショットの実装が含まれており、これにより「タイムマシン」を作成できます。たとえば、1か月間のスナップショットのセットで、15分で1スナップショットの解像度です。  Ubuntuのメンテナーはもちろん、この機能をzfs-auto-snapshotパッケージに含めました。これにより、スナップショットのセットが作成されますが、より時間がかかります。 問題は、各スナップショットが/ devディレクトリにブロックデバイスとして表示されることです。 スナップショットを作成するサイクルでは、1か月でプールの各ボリュームに対して4 + 24 + 4 + 31 + 1 = 64ブロックデバイスが取得されます。 つまり、たとえば20のボリュームがある場合（仮想化にサーバーを使用する場合は完全に正常な値）、1か月あたり64 * 20 = 1280デバイスになります。 再起動したい場合、大きな驚きがあります-ダウンロードが非常に遅れます。 理由-起動時にblkidユーティリティが実行され、ファイルシステムの存在についてすべてのブロックデバイスがポーリングされます。  FS検出メカニズムが不正に実装されているか、ブロックデバイスがゆっくり開いていますが、タイムアウトによって120秒後にblkidプロセスがカーネルによって強制終了されます。 言うまでもなく、blkidとそれに基づくすべてのスクリプトは、ダウンロードが完了した後でも動作しませんか？ 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div class="spoiler">  <b class="spoiler_title">ホットニュース</b> <div class="spoiler_text">  zfs-auto-stapshotパッケージをインストールして、より完全にテストしようとしました。 結果-ローテーションが機能せず、スナップショットの古いバージョンは削除されません（エラー134）。 したがって、1か月間で、1つのボリュームに対して4 * 24 + 24 * 31 + 4 + 31 + 1 = 876のスナップショット、または20のボリュームに対して18,396のスナップショットを取得します。 スナップショットを担当するスクリプトはおそらく何らかの形で修正できます... 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     パッケージバージョン-1.0.8-0ubuntu1〜oneric1、OS-Debian Sid x86_64 </div></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     これらの問題をすべて解決し、新しく作成したパーティションを、iSCSI、FC、またはカーネルに組み込まれた<a href="http://linux-iscsi.org/index.php/LIO-Target">LIO-Target</a>システムを介して他の方法で他のマシンに提供したいとします。 あった！  zfsモジュールは、起動時に、ベース番号230を使用して/ devディレクトリにブロックデバイスを作成します。 最新のパッチが適用されていないLIO-Target（より正確には、targetcliユーティリティ）は、この番号のデバイスがエクスポートの準備ができているとは見なしません。 解決策は、/ usr / lib / python2.7 / dist-packages / rtslib / utils.pyファイルの1行を修正するか、/ etc / modprobe.d / zfs.confファイルにzfsモジュールロードオプションを追加することです。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="bash hljs">options zfs zvol_major=240</code>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
     </pre> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     結論として、ご存じのとおり、カーネル内のZFSとGPL v2がCDDLの非互換性により、カーネル内にzfsモジュールが含まれることが妨げられています。 したがって、カーネルが更新されるたびに、モジュールはDKMSを介して再構築されます。 モジュールがこれを行うこともあれば、カーネルがあまりにも新しい場合もあります-いいえ。 したがって、最新のカーネルからの最新のチップ（およびKVMとLIO-Targetのバグ修正）は、少し遅れて届きます。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     結論は何ですか？ 本番環境では注意してZFSを使用してください。 おそらく、他のFSで問題なく機能した構成は機能せず、LVMで安全に実行したコマンドは<a href="https://github.com/zfsonlinux/zfs/issues/935">デッドロック</a>を引き起こします。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     しかし、Linuxの実稼働環境では、すべてのZFS volチップにアクセスできます。  28-重複排除、オンライン圧縮、フォールトトレランス、柔軟なボリュームマネージャー（ちなみに、個別に使用できます）など。一般に、幸運と成功をお祈りします。 </div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../J153451/index.html">Yandex.Browserのプレゼンテーション</a></li>
<li><a href="../J153453/index.html">Windows Azure上のSharePoint 2013ファーム SQL Server 2012</a></li>
<li><a href="../J153455/index.html">ObjectScript-PHPおよびJSよりも高速な新しいプログラミング言語</a></li>
<li><a href="../J153457/index.html">Doppio-JVM、JavaScriptコンパイラー、および逆アセンブラー</a></li>
<li><a href="../J15346/index.html">ブリヂストンA3カラー電子ペーパー</a></li>
<li><a href="../J153463/index.html">フロントエンドGLDを使用したPostfix外部アクセスルール</a></li>
<li><a href="../J153465/index.html">55年前、宇宙時代が始まりました</a></li>
<li><a href="../J153467/index.html">社会の11人の友人：民間アプリケーションの著者とのインタビュー</a></li>
<li><a href="../J15347/index.html">Eye Wi-Fi 2GB SDフラッシュカードFCC認定</a></li>
<li><a href="../J153473/index.html">Coursera Algorithmsコース（4〜6週間の学習）</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter70218013 = new Ya.Metrika({
                  id:70218013,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/70218013" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'G-FEDBM7F51Q', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Clever Geek | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <div class="company-info js-company-info" itemscope="" itemtype="http://schema.org/Organization">
      <span itemprop="name">Western Town Media (WTM)</span>
      <div itemprop="address" itemscope="" itemtype="http://schema.org/PostalAddress">
        <span itemprop="streetAddress">1968 Stoney Lonesome Road</span>
        <br>
        <span itemprop="postalCode">PA 18640</span>
        <span itemprop="addressLocality">Pittston, USA</span>
      </div>
      <span itemprop="telephone">570-362-1316</span>
    </div>
    <script type="application/ld+json">
      {
        "@context": "http://schema.org",
        "@type": "Organization",
        "address": {
          "@type": "PostalAddress",
          "addressLocality": "Pittston, USA",
          "postalCode": "PA 18640",
          "streetAddress": "1968 Stoney Lonesome Road"
        },
        "name": "Western Town Media (WTM)",
        "telephone": "570-362-1316"
      }
    </script>
  </div>
</footer>
  
</body>

</html>