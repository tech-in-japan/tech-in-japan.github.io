<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-FEDBM7F51Q"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-FEDBM7F51Q');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>📕 🍚 👏🏽 環境変数に関するストーリーの継続、またはPEBの置き換え ✌🏼 📪 🙍🏼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="今夜、私は初めてilya314の欠点についてこのトピックを書くためにHabréに登録することを決めましたが、私は名誉あるhabro-userではないので、何にもコメントできないことに非常に驚きました。 なんて恐ろしいことでしょう。 
  
 
  
 したがって、PEBプロセスからSyshnyランタ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="sitemap" type="application/xml" href="/sitemap.xml"/>

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

  <script>document.write('<script src="https://pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://tech-in-japan.github.io/index.html"></a>
    <div class="page-header-text">Clever Geek Handbook</div>
  </header>
  <section class="page js-page"><h1>環境変数に関するストーリーの継続、またはPEBの置き換え</h1><div class="post__text post__text-html js-mediator-article" id="post-content-body"> 今夜、私は初めて<a href="https://habrahabr.ru/users/ilya314/" class="user_link">ilya314の</a>欠点について<a href="http://habrahabr.ru/blogs/system_programming/136779/">このトピック</a>を書くためにHabréに登録することを決めましたが、私は名誉ある<s>habro-userで</s>はないので、何にもコメントできないことに非常に驚きました。 なんて恐ろしいことでしょう。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     したがって、PEBプロセスからSyshnyランタイムにデータを複製する問題についての考えを表すために、コードを書き留めることにしました。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     実際、作成者が抱えている問題を解決するには、いくつかの方法があります-最も簡単な方法は、getenvランタイムのライブラリ関数を放棄し、 <b>kernel32.GetEnvironmentVariableW</b>または<b>kernel32.GetEnvironmentStringsW</b>インターフェイスを使用することです。 しかし、トピックをさらに開発して、環境変数を見つけて、特定のプロセスに合わせて環境変数を置き換えることを試みました。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     文書化されていないPEB広告を片目で見てみましょう（もちろん、M $はプロパティのかかとを提供しますが、Googleまたはデバッガーを適切に使用すると、すべてが適切に配置されます）。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="hljs pgsql">typedef struct _PEB { <span class="hljs-type"><span class="hljs-type">BOOLEAN</span></span> InheritedAddressSpace; <span class="hljs-type"><span class="hljs-type">BOOLEAN</span></span> ReadImageFileExecOptions; <span class="hljs-type"><span class="hljs-type">BOOLEAN</span></span> BeingDebugged; <span class="hljs-type"><span class="hljs-type">BOOLEAN</span></span> Spare; HANDLE Mutant; PVOID ImageBaseAddress; PPEB_LDR_DATA LoaderData; PRTL_USER_PROCESS_PARAMETERS ProcessParameters; PVOID SubSystemData; PVOID ProcessHeap; PVOID FastPebLock; PPEBLOCKROUTINE FastPebLockRoutine; PPEBLOCKROUTINE FastPebUnlockRoutine; ULONG EnvironmentUpdateCount; PPVOID KernelCallbackTable; PVOID EventLogSection; PVOID EventLog; PPEB_FREE_BLOCK FreeList; ULONG TlsExpansionCounter; PVOID TlsBitmap; ULONG TlsBitmapBits[<span class="hljs-number"><span class="hljs-number">0x2</span></span>]; PVOID ReadOnlySharedMemoryBase; PVOID ReadOnlySharedMemoryHeap; PPVOID ReadOnlyStaticServerData; PVOID AnsiCodePageData; PVOID OemCodePageData; PVOID UnicodeCaseTableData; ULONG NumberOfProcessors; ULONG NtGlobalFlag; BYTE Spare2[<span class="hljs-number"><span class="hljs-number">0x4</span></span>]; LARGE_INTEGER CriticalSectionTimeout; ULONG HeapSegmentReserve; ULONG HeapSegmentCommit; ULONG HeapDeCommitTotalFreeThreshold; ULONG HeapDeCommitFreeBlockThreshold; ULONG NumberOfHeaps; ULONG MaximumNumberOfHeaps; PPVOID *ProcessHeaps; PVOID GdiSharedHandleTable; PVOID ProcessStarterHelper; PVOID GdiDCAttributeList; PVOID LoaderLock; ULONG OSMajorVersion; ULONG OSMinorVersion; ULONG OSBuildNumber; ULONG OSPlatformId; ULONG ImageSubSystem; ULONG ImageSubSystemMajorVersion; ULONG ImageSubSystemMinorVersion; ULONG GdiHandleBuffer[<span class="hljs-number"><span class="hljs-number">0x22</span></span>]; ULONG PostProcessInitRoutine; ULONG TlsExpansionBitmap; BYTE TlsExpansionBitmapBits[<span class="hljs-number"><span class="hljs-number">0x80</span></span>]; ULONG SessionId; } PEB, *PPEB;</code>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
     </pre> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      CommandParameterを含むProcessParametersプロパティに興味があり<b>ます。</b>  <b>環境;</b> また、ring0からring3に複製され、ここからすぐにSyshnomランタイムによってキャッシュされるその他のグッズ。 おそらく、ランタイムは標準のkernel32-&gt; ntdllインターフェイスを使用しており、フックするだけでしたが、セグメントレジスタを介してPEBをプルし、メモリ内の厚かましいものとデータを置き換えることにしました。 置き換えて、Windowsがこれにどのように反応するかを確認してください。 最近、AMD64の下で使用する予定なので、このプラットフォーム専用にコンパイルします。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      64ビットプラットフォーム用のインラインasm挿入の可能性を排除したすばらしいM $ソリューションのおかげで、プロジェクト内のアセンブラー関数を<s>ピックアップ</s>する興味深い探求と、別のオブジェクトリストとのリンクを待っています（これについては記事全体を書くことができます。すべてが正常に機能する一方で、私はちょうどそれに飽きました。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> <code class="hljs css">; ; <span class="hljs-selector-tag"><span class="hljs-selector-tag">Utils</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.asm</span></span> ; <span class="hljs-selector-tag"><span class="hljs-selector-tag">INCLUDE</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Utils</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.inc</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.code</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">GetCurrentUserProcessParameters</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">PROC</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">rax</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">gs</span></span>:<span class="hljs-selector-attr"><span class="hljs-selector-attr">[60h]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">rax</span></span>, <span class="hljs-selector-attr"><span class="hljs-selector-attr">[rax + 20h]</span></span>; <span class="hljs-selector-tag"><span class="hljs-selector-tag">ret</span></span>; <span class="hljs-selector-tag"><span class="hljs-selector-tag">GetCurrentUserProcessParameters</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ENDP</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">END</span></span></code>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
     </pre>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     ちなみに、32ビットバージョンのWindows OSファミリとは異なり、64ビットPEBではgsレジスタを基準としたオフセットによってマッピングされますが、32ビットバージョンでは次のように取得できます。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> <code class="hljs objectivec">__declspec(naked) PVOID GetCurrentUserProcessParameters() { __<span class="hljs-keyword"><span class="hljs-keyword">asm</span></span> { mov eax, fs:[<span class="hljs-number"><span class="hljs-number">30</span></span>h]; mov eax, [eax + <span class="hljs-number"><span class="hljs-number">10</span></span>h]; ret; } }</code>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
     </pre>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      PEBを見ると、32ビットのProcessParametersのオフセットを簡単に計算できます。  4バイトのアライメントでは、16バイトに収まります。  64ビットの場合、8バイトのポインターと4バイトに揃えられた最初のブール値を考慮して、28 + 4バイトが解放されます。 これを確認するには、デバッガを使用してプロセスメモリを調べます。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="http://desmond.imageshack.us/Himg6/scaled.php?server=6&amp;filename=raxp.png&amp;res=medium" alt="画像">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="http://img513.imageshack.us/img513/1361/envpointer.png" alt="画像">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     次に、強度を収集し、プロセスのPEB内のProcessParameters、より具体的には環境変数を置き換えます。 しかし、最初に、Environmentブロックに文字列を保存するためのフォーマットを見てみましょう。  M $は、行がVAR = VALUEの形式であり、ゼロバイトで区切られていることを主張します。ブロックの終わりの符号は、2つのゼロバイトが連続しています。 これを自分の目で確認し、落とし穴を強調します。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li> 現在のページのメモリ保護を監視し、なりすましやサービス構造への書き込み後にそれらを復元する必要があります </li><li> イメージの実行可能コード、または挿入されたコードは同じページに配置できるため、実行権を割り当てる必要があることを常に想定する必要があります。 もちろん、これは画像の配置とメモリ割り当ての粒度を考慮して可能性は低いですが、特にマルチスレッド環境で悪い/代替品である場合、安全にプレイすることは不要ではありません </li><li> 作業が終了したら、事前に保存された元のテーブル（テーブルへのポインタ）を復元し、偽のテーブルのメモリを解放することを忘れないでください。 </li><li> この例は、変更時にシステムが（別のワークフローから）PEBにアクセスするのを避けるために、エントリポイントで最初の1つでなければならないため、純粋に学術的な例です。 良い場合は、プロセス内のすべてのスレッドを「破棄」し、変更時にそれらを中断する価値があります。 </li></ul>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> <code class="hljs rust">#include &lt;windows.h&gt; #include &lt;stdio.h&gt; #include &lt;conio.h&gt; #include <span class="hljs-string"><span class="hljs-string">"Utils.h"</span></span> typedef <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_LSA_UNICODE_STRING</span></span></span></span> { USHORT Length; USHORT MaximumLength; PWSTR Buffer; } LSA_UNICODE_STRING, *PLSA_UNICODE_STRING, UNICODE_STRING, *PUNICODE_STRING; typedef <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_RTL_USER_PROCESS_PARAMETERS</span></span></span></span> { ULONG MaximumLength; ULONG Length; ULONG Flags; ULONG DebugFlags; PVOID ConsoleHandle; ULONG ConsoleFlags; HANDLE StdInputHandle; HANDLE StdOutputHandle; HANDLE StdErrorHandle; UNICODE_STRING CurrentDirectoryPath; HANDLE CurrentDirectoryHandle; UNICODE_STRING DllPath; UNICODE_STRING ImagePathName; UNICODE_STRING CommandLine; PVOID Environment; ULONG StartingPositionLeft; ULONG StartingPositionTop; ULONG Width; ULONG Height; ULONG CharWidth; ULONG CharHeight; ULONG ConsoleTextAttributes; ULONG WindowFlags; ULONG ShowWindowFlags; UNICODE_STRING WindowTitle; UNICODE_STRING DesktopName; UNICODE_STRING ShellInfo; UNICODE_STRING RuntimeData; PVOID DLCurrentDirectory; } RTL_USER_PROCESS_PARAMETERS, *PRTL_USER_PROCESS_PARAMETERS; PVOID ReplacePEBEnvironmentTableAndAddValue(LPCWSTR Variable, LPCWSTR Value) { PRTL_USER_PROCESS_PARAMETERS ProcessParams; MEMORY_BASIC_INFORMATION MemoryInformation; PBYTE NewEnvironment; PWCHAR Token; size_t EnvironmentSize; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!Variable || !Value || !*Variable || !*Value) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> NULL; <span class="hljs-comment"><span class="hljs-comment">/*    RTL_USER_PROCESS_PARAMETERS  PEB   */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*   Environment   */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*     ,   ,    */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*  L'\0' L'\0',   MSDN */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*  4   */</span></span> ProcessParams = GetCurrentUserProcessParameters(); Token = (PWCHAR)ProcessParams-&gt;Environment; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (!(!*Token &amp;&amp; !*(Token + <span class="hljs-number"><span class="hljs-number">1</span></span>))) ++Token; EnvironmentSize = (ULONG_PTR)Token - (ULONG_PTR)ProcessParams-&gt;Environment; <span class="hljs-comment"><span class="hljs-comment">/*      Environment   ,    */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*  ,   */</span></span> MemoryInformation.AllocationProtect = PAGE_EXECUTE_READWRITE; VirtualQuery(ProcessParams-&gt;Environment, &amp;MemoryInformation, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(MEMORY_BASIC_INFORMATION)); <span class="hljs-comment"><span class="hljs-comment">/*       Environment +  */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*          */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*  ,      Environment, */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*       */</span></span> NewEnvironment = (PBYTE)VirtualAlloc(<span class="hljs-number"><span class="hljs-number">0</span></span>, EnvironmentSize + <span class="hljs-number"><span class="hljs-number">0x1000</span></span>, MEM_RESERVE | MEM_COMMIT, PAGE_EXECUTE_READWRITE); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (NewEnvironment) { <span class="hljs-comment"><span class="hljs-comment">/*           */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*  Var=Value (+ 2 widechar  L'='   ) */</span></span> DWORD OldProtect = PAGE_EXECUTE_READWRITE, OldProtect2 = PAGE_EXECUTE_READWRITE; size_t Size = (wcslen(Variable) + wcslen(Value)) * <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(WCHAR) + <span class="hljs-number"><span class="hljs-number">2</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(WCHAR); PWCHAR EnvironmentString = malloc(Size); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (EnvironmentString) { <span class="hljs-comment"><span class="hljs-comment">/*         */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*      */</span></span> PVOID OldEnvironment = ProcessParams-&gt;Environment; UINT EndOfEnvironment = <span class="hljs-number"><span class="hljs-number">0</span></span>; _snwprintf_s(EnvironmentString, Size / <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(WCHAR), _TRUNCATE, L<span class="hljs-string"><span class="hljs-string">"%ws=%ws"</span></span>, Variable, Value); memcpy(NewEnvironment, ProcessParams-&gt;Environment, EnvironmentSize); <span class="hljs-comment"><span class="hljs-comment">/*     -      MSDN */</span></span> *((PWCHAR)(NewEnvironment + EnvironmentSize)) = L<span class="hljs-string"><span class="hljs-string">'\0'</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*        */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*    4   */</span></span> memcpy(NewEnvironment + EnvironmentSize + <span class="hljs-number"><span class="hljs-number">2</span></span>, EnvironmentString, Size - <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(WCHAR)); memcpy(NewEnvironment + EnvironmentSize + <span class="hljs-number"><span class="hljs-number">2</span></span> + Size - <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(WCHAR), &amp;EndOfEnvironment, <span class="hljs-number"><span class="hljs-number">4</span></span>); <span class="hljs-comment"><span class="hljs-comment">/*         */</span></span> VirtualProtect(NewEnvironment, EnvironmentSize + <span class="hljs-number"><span class="hljs-number">0x1000</span></span>, MemoryInformation.AllocationProtect, &amp;OldProtect); <span class="hljs-comment"><span class="hljs-comment">/*     RTL_USER_PROCESS_PARAMETERS  PEB */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*       */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*  Environment block       */</span></span> VirtualProtect(ProcessParams, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(RTL_USER_PROCESS_PARAMETERS), PAGE_EXECUTE_READWRITE, &amp;OldProtect); ProcessParams-&gt;Environment = NewEnvironment; VirtualProtect(ProcessParams, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(RTL_USER_PROCESS_PARAMETERS), OldProtect, &amp;OldProtect2); <span class="hljs-comment"><span class="hljs-comment">/*           */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*     Environment block */</span></span> free(EnvironmentString); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> OldEnvironment; } VirtualFree(NewEnvironment, <span class="hljs-number"><span class="hljs-number">0</span></span>, MEM_RELEASE); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> NULL; } void RestorePEBEnvironmentTable(PVOID OriginalEnvironment) { PRTL_USER_PROCESS_PARAMETERS ProcessParams; DWORD OldProtect = PAGE_EXECUTE_READWRITE, OldProtect2; PVOID OldEnvironment; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!OriginalEnvironment) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*  PEB          */</span></span> ProcessParams = GetCurrentUserProcessParameters(); VirtualProtect(ProcessParams, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(RTL_USER_PROCESS_PARAMETERS), PAGE_EXECUTE_READWRITE, &amp;OldProtect); OldEnvironment = ProcessParams-&gt;Environment; ProcessParams-&gt;Environment = OriginalEnvironment; VirtualProtect(ProcessParams, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(RTL_USER_PROCESS_PARAMETERS), OldProtect, &amp;OldProtect2); <span class="hljs-comment"><span class="hljs-comment">/*       ,   */</span></span> VirtualFree(OldEnvironment, <span class="hljs-number"><span class="hljs-number">0</span></span>, MEM_RELEASE); } void main(int argc, <span class="hljs-built_in"><span class="hljs-built_in">char</span></span> *argv[]) { PVOID OriginalEnvironment; UNREFERENCED_PARAMETER(argc); UNREFERENCED_PARAMETER(argv); OriginalEnvironment = ReplacePEBEnvironmentTableAndAddValue(L<span class="hljs-string"><span class="hljs-string">"NewVar"</span></span>, L<span class="hljs-string"><span class="hljs-string">"NewValue"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (OriginalEnvironment) { WCHAR Buff[<span class="hljs-number"><span class="hljs-number">1024</span></span>] = {<span class="hljs-number"><span class="hljs-number">0</span></span>}; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (GetEnvironmentVariableW(L<span class="hljs-string"><span class="hljs-string">"NewVar"</span></span>, Buff, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(Buff))) wprintf_s(L<span class="hljs-string"><span class="hljs-string">"GetEnvironmentVariableW(): NewVar == %ws\n"</span></span>, Buff); printf_s(<span class="hljs-string"><span class="hljs-string">"Restoring PEB Environment Table...\n"</span></span>); RestorePEBEnvironmentTable(OriginalEnvironment); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!GetEnvironmentVariableW(L<span class="hljs-string"><span class="hljs-string">"NewVar"</span></span>, Buff, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(Buff))) printf_s(<span class="hljs-string"><span class="hljs-string">"GetEnvironmentVariableW(): NewVar not found\n"</span></span>); } _getch(); }</code>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
     </pre>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     その後、結論は次のとおりです。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="http://img96.imageshack.us/img96/2692/valwf.png" alt="画像">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      「ネイティブ」テーブルに戻っても、キャッシュは再構築されません。 したがって、適切なkernel32インターフェースを使用して環境変数のブロックを操作することにより、dllに関する著者の問題は解決されます。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     最も興味深いのは、サードパーティのプロセスでデータを変更するときにこのメソッドが機能することです。これは後で表示できます。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b>更新：</b> <a href="https://habrahabr.ru/users/clevermouse/" class="user_link">CleverMouseが</a>正しく指摘したように、Cライブラリを介した環境変数の操作は、特定の例では意味を持ちません。メイン関数の場合、_wenvironではなく_environキャッシュがいっぱいになるため、これをデバッグ出力として検討することをお勧めします。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     永遠にあなたのもの 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      rwx64 </div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../J137472/index.html">15分で電動機を作る方法</a></li>
<li><a href="../J137473/index.html"><1000ルーブルの電話の寿命はありますか？</a></li>
<li><a href="../J137474/index.html">Qt SDK 1.2アプリケーション開発ソフトウェアがリリースされました</a></li>
<li><a href="../J137475/index.html">匿名性と匿名化</a></li>
<li><a href="../J137476/index.html">ucarpを使用したフォールトトレラントIP</a></li>
<li><a href="../J137480/index.html">マイクロチップは、体内の腫瘍の状態を監視するためにドイツで作成されました</a></li>
<li><a href="../J137482/index.html">素晴らしい中国の金色の盾。 パート2</a></li>
<li><a href="../J137484/index.html">インターネットで購入し、詐欺師のネットワークに入らない方法</a></li>
<li><a href="../J137485/index.html">Firefox：Emacsスタイルのキーボードショートカット、およびマウスの中ボタンをクリックしてクリップボードの内容を読み込む</a></li>
<li><a href="../J137492/index.html">カスペルスキー：データベースの更新に関する問題、ウイルス対策が無効になっています</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter70218013 = new Ya.Metrika({
                  id:70218013,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/70218013" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'G-FEDBM7F51Q', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Clever Geek | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <div class="company-info js-company-info" itemscope="" itemtype="http://schema.org/Organization">
      <span itemprop="name">Western Town Media (WTM)</span>
      <div itemprop="address" itemscope="" itemtype="http://schema.org/PostalAddress">
        <span itemprop="streetAddress">1968 Stoney Lonesome Road</span>
        <br>
        <span itemprop="postalCode">PA 18640</span>
        <span itemprop="addressLocality">Pittston, USA</span>
      </div>
      <span itemprop="telephone">570-362-1316</span>
    </div>
    <script type="application/ld+json">
      {
        "@context": "http://schema.org",
        "@type": "Organization",
        "address": {
          "@type": "PostalAddress",
          "addressLocality": "Pittston, USA",
          "postalCode": "PA 18640",
          "streetAddress": "1968 Stoney Lonesome Road"
        },
        "name": "Western Town Media (WTM)",
        "telephone": "570-362-1316"
      }
    </script>
  </div>
</footer>
  
</body>

</html>