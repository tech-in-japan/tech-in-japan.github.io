<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-FEDBM7F51Q"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-FEDBM7F51Q');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👬 🍠 🌬️ DiscordがGoとC ++で毎日1億5千万の画像をリサイズする方法 👏🏽 📧 🥪</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Discordはボイス＆テキストチャットアプリケーションですが、毎日1億枚​​以上の画像が通過します。 もちろん、すべてのチャンネルで友人に写真をリダイレクトするだけで、タスクはシンプルになります。 しかし実際には、これらの画像の配信は非常に大きな技術的問題を引き起こします。 写真への直接リンクは、...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="sitemap" type="application/xml" href="/sitemap.xml"/>

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

  <script>document.write('<script src="https://pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://tech-in-japan.github.io/index.html"></a>
    <div class="page-header-text">Clever Geek Handbook</div>
  </header>
  <section class="page js-page"><h1>DiscordがGoとC ++で毎日1億5千万の画像をリサイズする方法</h1><div class="post__text post__text-html js-mediator-article" id="post-content-body" data-io-article-url="https://habr.com/ru/post/343414/"><img src="https://habrastorage.org/getpro/habr/post_images/201/bce/32b/201bce32b07895b92f2cb2026ae6c708.png">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Discordはボイス＆テキストチャットアプリケーションですが、毎日1億枚​​以上の画像が通過します。 もちろん、すべてのチャンネルで友人に写真をリダイレクトするだけで、タスクはシンプルになります。 しかし実際には、これらの画像の配信は非常に大きな技術的問題を引き起こします。 写真への直接リンクは、写真を持つホストにユーザーのIPアドレスを提供し、大きな画像は多くのトラフィックを消費します。 これらの問題を回避するには、ユーザーの画像を受信し、トラフィックを節約するために画像のサイズを変更する中間サービスが必要です。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h1> 画像プロキシに会う </h1>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     これを行うために、Pythonサービスを作成し、創造的に<i>Image Proxy</i>という名前を付けました。 リモートURLから画像をダウンロードしてから、 <a href="https://github.com/uploadcare/pillow-simd">pillow-simdパッケージを使用</a>して、リソースを大量に消費するサイズ変更タスクを実行し<a href="https://github.com/uploadcare/pillow-simd">ます</a> 。 このパッケージは驚くほど高速で、可能な限り<a href="https://en.wikipedia.org/wiki/Streaming_SIMD_Extensions">x86 SSE命令の</a>サイズ変更を高速化し<a href="https://en.wikipedia.org/wiki/Streaming_SIMD_Extensions">ます</a> 。 画像プロキシは、最終画像をアップロード、サイズ変更、および最終的に表示するURLを含むHTTPリクエストを受信します。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     さらに、サイズ変更された画像をメモリに保存するキャッシュレイヤーを設定し、可能であれば、メモリから直接発行しようとします。  <a href="http://www.haproxy.org/">HAProxy</a>レイヤーは、URLハッシュに基づいてリクエストをNginxキャッシングレイヤーにリダイレクトします。 キャッシュは<a href="http_proxy_module.html">クエリのマージ</a>を<a href="http_proxy_module.html">実行し</a>て、画像のサイズ変更に必要な変換の数を最小限にします。 キャッシュとプロキシの組み合わせにより、サイズ変更サービスを数百万人のユーザーに拡張できました。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/getpro/habr/post_images/473/584/1c4/4735841c4ffba2edd3827803156205d4.png">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Discordが成長するにつれて、Image Proxyは過負荷の兆候を示し始めました。 最大の問題は、負荷が不均等に分散され、帯域幅が低下することでした。 リクエストは、最大数秒まで、まったく異なる時間に実行されました。 既存のImage Proxyでこの問題を解決することはできましたが、当時はGoの追加使用を試していましたが、ここではGoを使用するのに最適な場所のように思えました。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h1> だからメディアプロキシがありました </h1>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     すでに実行中のサービスを書き換えることは<a href="https://www.joelonsoftware.com/2000/04/06/things-you-should-never-do-part-i/">難しい決断に</a>なりました。 幸いなことに、Image Proxyは比較的単純であり、Image Proxyと新しい代替の結果を簡単に比較できました。 クエリ実行の高速化に加えて、新しいサービスには、.mp4および.webmビデオの最初のフレームを抽出する機能など、いくつかの新機能もあります。したがって、Media Proxyと呼びましょう。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Goで画像のサイズを変更するため<a href="https://gist.github.com/b1naryth1ef/7a7c06d210ee4a56ed253c89925ed978">に</a>既存のパッケージ<a href="https://gist.github.com/b1naryth1ef/7a7c06d210ee4a56ed253c89925ed978">のパフォーマンスを測定すること</a>から始め、すぐにがっかりしました。  Goは一般的にPythonよりも高速な言語ですが、パッケージのどれもが確実にPillow-simdの速度を上回っていません。  Image Proxyの作業の主な部分は、画像のトランスコードとサイズ変更でした。したがって、Media Proxyのパフォーマンスのボトルネックになることは間違いありません。  Go言語は、HTTPを処理するときに少し速くなる場合がありますが、写真のサイズをすばやく変更できない場合は、サイズ変更のための追加の時間によって速度の向上が平準化されます。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Goで<a href="http://wiki.c2.com/%3FNotInventedHere">賭け</a>を<a href="http://wiki.c2.com/%3FNotInventedHere">2倍にし、</a>独自の画像サイズ変更ライブラリを構築することにしました。  <a href="https://opencv.org/">OpenCV</a>に基づく1つのGoパッケージによっていくつかの有望な結果が示されましたが、必要なすべての機能をサポートしていませんでした。  OpenCVの上に独自のCgo <a href="https://blog.golang.org/c-go-cgo">ラッパー</a>を備えた<a href="https://github.com/discordapp/lilliput">Lilliput</a>というGoリサイザーを作成しました。 作成時に、Goで余分なゴミが生成されないように注意して監視しました。  Lilliputラッパーは、必要に応じて<a href="https://github.com/opencv/opencv/pull/8511">OpenCV</a>を少し<a href="https://github.com/opencv/opencv/pull/8511">フォーク</a>しましたが、必要なほぼすべてを実行します。 特に、画像を解凍するかどうかを決定する前にヘッダーをチェックできるようにしたかったのです。この方法では、大きすぎる画像のサイズ変更を即座に拒否できます。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Lilliputは、既存および実績のあるCライブラリ（たとえば、JPEGのlibjpeg-turbo、PNGのlibpng）、および圧縮と解凍のサイズをすばやく変更するためのベクトル化されたOpenCVコードを使用します。  HTTPクライアントとサーバーを同時に<a href="http">使用</a>するための要件を満たすために、 <a href="http">fasthttp</a>を追加しました。 その結果、この組み合わせにより、合成ベンチマークでImage Proxyを着実に上回るサービスを開始できました。 加えて、リリプットは私たちが必要とするタスクでpillow-simdより<a href="https://gist.github.com/brian-armstrong-discord/1eb10046edb91167b7187513cc306d65">悪くも良く</a>も働き<a href="https://gist.github.com/brian-armstrong-discord/1eb10046edb91167b7187513cc306d65">ません</a>でした。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/getpro/habr/post_images/d92/ac2/5d3/d92ac25d3c25611c117cada259360d73.png">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     最初のコードには問題がなかったわけではありません。 最初、Media Proxyはリクエストごとに16バイトをリークしました。 これは、特に少量のリクエストでテストする場合にすぐに気付くほど小さいです。 この問題を解決するために、Media Proxyはサイズ変更のために大きな静的ピクセルバッファーをインストールしました。  CPUごとにこのようなバッファを2つ使用するため、32コアのマシンではすぐに32ギガバイトのメモリを消費します。 テスト中、メディアプロキシはすべてのメモリを使用するため、メディアプロキシの再起動には数時間かかりました。 これは、状況を明確にするのを困難にするのに十分な時間です：本当にメモリリークがあるか、または動作中に単純に制限を超えています。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     最終的に、何らかの種類のメモリリークがまだあると判断しました。 このリークがGoにあるのかC ++にあるのかはわかりませんでした。コードを調べても答えが得られませんでした。 幸いなことに、Xcodeには優れたメモリプロファイラーが付属してい<a href="https://developer.apple.com/library/content/documentation/DeveloperTools/Conceptual/InstrumentsUserGuide/FindingLeakedMemory.html">ます</a> 。これ<a href="https://developer.apple.com/library/content/documentation/DeveloperTools/Conceptual/InstrumentsUserGuide/FindingLeakedMemory.html">は、[ <i>機器</i> ]メニューの</a> [ <a href="https://developer.apple.com/library/content/documentation/DeveloperTools/Conceptual/InstrumentsUserGuide/FindingLeakedMemory.html"><i>リーク]</i>ツールです</a> 。 このツールは、リークのサイズと、リークが発生するおおよその場所を示しました。 このようなヒントは、ソースを特定し、リークを修正するためのより徹底的な調査に十分でした。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     メディアプロキシでは、別のバグが発生したため、中断しました。 時々、彼は奇妙に甘やかされて育った写真を配りました。その半分は通常のままで、残りの半分は「バギー」でした。 どこかで画像を部分的にエンコードしているのか、OpenCVを間違って呼び出しているのではないかと考えました。 バグはめったに現れず、診断が困難でした。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     調査を進めるために、シミュレータ内のHTTPサーバーへのリンクを含むURLを返す高性能クエリシミュレーターを開発し、このシミュレーターが要求クライアントとホストサーバーの両方として機能するようにしました。 彼は、Media Proxyでこのような画像の破損を引き起こすために、応答にランダムに遅延を挿入しました。 問題を確実に再現したため、Media Proxyのコンポーネントを分離し、サイズ変更された画像を含む出力バッファーで競合状態を見つけることができました。 最初のイメージがシステムに返される前に、1つのイメージがこのバッファーに書き込まれ、次に別のイメージが書き込まれました。 実際には、グリッチな写真は2つのJPEGであり、一方が他方の上に記録されました。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div style="text-align:center;"><img src="https://habrastorage.org/webt/tq/jf/pp/tqjfppxnggvjk7yli0fi_od69ks.png"></div>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <i><font color="gray">Media Proxyによって生成される実際のバグのあるJPEG</font></i> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     複雑なシステムのバグを探す別の方法は、ランダムな入力データが生成されてシステムに送信されるときのファジングです。 この場合、システムは奇妙な動作または崩壊を示す可能性があります。 私たちのシステムは入力データに対して耐性がなければならないため、この重要な手法をテストプロセスに適用することにしました。  <a href="http://lcamtuf.coredump.cx/afl/">AFL</a>は<a href="http://lcamtuf.coredump.cx/afl/">非常に優れたファザー</a>であるため、それを選択してLilliputに設定しました。これにより、初期化されていない変数によるいくつかの失敗を識別できました。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     これらのバグを修正した後、Media Proxyを本番環境に導入するのに十分な自信が生まれました。そして、私たちの努力がそれだけの価値があることを嬉しく思いました。  Media Proxyは、Image Proxyと同じ数のリクエストを処理するために必要な<b>サーバーインスタンスが60％少なく</b> 、これらのリクエストをはるかに少ない時間分散で実行します。 プロファイリングにより、新しいサービスのCPU時間の90％以上が解凍、サイズ変更、および圧縮に費やされていることが示されました。 これらのライブラリはすでに大幅に最適化されています。つまり、追加の成長は容易ではありません。 さらに、サービスはプロセスでガベージをほとんど生成しませんでした。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     現在、Media Proxyは中央値25ミリ秒で画像サイズ変更を実行し、応答遅延は中央値85ミリ秒です。 毎日1億5,000万枚以上の写真のサイズを変更します。 メディアプロキシは、 <a href="https://cloud.google.com/compute/docs/machine-types">n1-standard-16</a>自動スケーラブルGCE <a href="https://cloud.google.com/compute/docs/machine-types">ホスト</a>グループで実行され、通常は12インスタンスのピークを迎えます。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h1> メディアプロキシでメディアをダウンロードする </h1>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     サービスが静止画像で正常に機能した後、アニメーションGIFのサイズ変更のサポートを接続したかったため、OpenCVはこの作業を行いません。  LilliputがアニメーションGIF全体のサイズを変更し、PNG形式で最初のフレームを提供できるように、 <a href="http://giflib.sourceforge.net/gif_lib.html">giflibの</a>上に別のCgoラッパーをLilliputに追加することにしました。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <a href="https://www.w3.org/Graphics/GIF/spec-gif89a.txt">GIF標準で</a>は各フレームで256色のパレットを使用できるようになっており、サイズ変更モジュールは<a href="https://en.wikipedia.org/wiki/RGB_color_model">RGBスペースで</a>機能するため<a href="https://www.w3.org/Graphics/GIF/spec-gif89a.txt">、GIF</a>のサイズ変更はそれほど簡単ではありませんでした。 新しいパレットを計算するのではなく、各フレームのパレットを保存することにしました。  RGBをパレットインデックスに戻すために、Lilliputに単純なルックアップテーブルを提供しました。このテーブルは、RGBビットを受け取り、その結果をパレットインデックステーブルのキーとして使用しました。 これはうまく機能し、元の色を維持しましたが、このアプローチは、Lilliputがこの形式のソースファイルからのみGIFを作成できることを意味しません。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     また、 <a href="https://sourceforge.net/p/giflib/patches/28/">giflib</a>に<a href="https://sourceforge.net/p/giflib/patches/28/">パッチを適用</a>して、一度に1つのフレームのみをデコードしやすくしました。 これにより、フレームをデコードし、サイズを変更してから、次のフレームに進む前にエンコードおよび圧縮できます。 これにより、GIFサイズ変更モジュールのメモリ消費が削減されます。 フレームごとにいくつかのGIF状態を保存する必要があるため、これはLilliputを少し複雑にしますが、Media Proxyのより予測可能なメモリ使用量は明らかな利点のようです。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      giflibはサイズ変更プロセスを完全に制御できるため、LilliputのgiflibラッパーはImage Proxy GIFリサイザーにあった問題の一部を修正します。 かなりの数の<a href="https://discordapp.com/nitro">Nitroユーザーが、</a> GIFアニメーションアバターをアップロードし<a href="https://discordapp.com/nitro">ます。これらの</a>アバターは、Image Proxyでサイズを変更した後、バグがあるか透明度エラーがありますが、Media Proxyを処理した後は正常に動作します。 一般に、判明したように、サイズ変更プログラムにはGIF形式のいくつかの側面に問題があるため、透明なフレームまたは部分的なフレームの視覚的な不具合が発生します。 独自のラッパーを作成することで、発生した問題を解決できました。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     最後に、 <a href="https://ffmpeg.org/libavcodec.html">libavcodecの</a> CgoラッパーがLilliput <a href="https://ffmpeg.org/libavcodec.html">に</a>追加され、ビデオを停止し、MP4およびWEBMクリップの最初のフレームを受信できるようになりました。 この機能により、Media Proxyはユーザーが投稿したビデオファイルのプレビューを生成できるため、このプレビューに基づいて他のユーザーがビデオを開始するかどうかを決定できます。 最初のフレームの抽出は、公開されたファイルおよびリンク用にクライアントに組み込みのビデオプレーヤーを追加することを妨げる最後の要因の1つであり続けました。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h1> もっとオープンソース </h1>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Media Proxyの作業に満足したので、MITライセンスの下で<a href="https://github.com/discordapp/lilliput">Lilliput</a>を公​​開します。 このパッケージが、生産的な画像サイズ変更サービスを必要とする人々に役立つことを願っています。この記事では、他の人が新しいGoパッケージを作成することをお勧めします。 </div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../J343396/index.html">これは新しい工夫ですか？ 教育学からアンドラゴジー、アンドラゴジーからウタゴジーへ</a></li>
<li><a href="../J343402/index.html">これを定式化する：欠員のテキストを書き直し、数学的不平等を解決するためにロールダウンする方法</a></li>
<li><a href="../J343404/index.html">コードの再利用-実際に起こること</a></li>
<li><a href="../J343406/index.html">チームDNAに複数の成長を埋め込む</a></li>
<li><a href="../J343410/index.html">Firebird、MySQL、PostgreSQLのコード品質の比較</a></li>
<li><a href="../J343416/index.html">サーバーを操作する重要なケース</a></li>
<li><a href="../J343418/index.html">12月9日に開催されるハイアースクールオブエコノミクスでのゲーム業界に関する展示会および会議にご招待します。</a></li>
<li><a href="../J343420/index.html">Splunkを使用したCisco CDRおよびMicrosoft Exchange Serverログの分析</a></li>
<li><a href="../J343430/index.html">Boxするかどうか それが問題です</a></li>
<li><a href="../J343432/index.html">チュートリアル：watchOS 4用のシンプルなアプリケーションの作成</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter70218013 = new Ya.Metrika({
                  id:70218013,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/70218013" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'G-FEDBM7F51Q', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Clever Geek | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <div class="company-info js-company-info" itemscope="" itemtype="http://schema.org/Organization">
      <span itemprop="name">Western Town Media (WTM)</span>
      <div itemprop="address" itemscope="" itemtype="http://schema.org/PostalAddress">
        <span itemprop="streetAddress">1968 Stoney Lonesome Road</span>
        <br>
        <span itemprop="postalCode">PA 18640</span>
        <span itemprop="addressLocality">Pittston, USA</span>
      </div>
      <span itemprop="telephone">570-362-1316</span>
    </div>
    <script type="application/ld+json">
      {
        "@context": "http://schema.org",
        "@type": "Organization",
        "address": {
          "@type": "PostalAddress",
          "addressLocality": "Pittston, USA",
          "postalCode": "PA 18640",
          "streetAddress": "1968 Stoney Lonesome Road"
        },
        "name": "Western Town Media (WTM)",
        "telephone": "570-362-1316"
      }
    </script>
  </div>
</footer>
  
</body>

</html>