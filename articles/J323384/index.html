<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-FEDBM7F51Q"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-FEDBM7F51Q');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ†“ ğŸ¬ â›¹ğŸ¿ Node.jsä¸Šã®Qiwiã®IPN ğŸ§šğŸ¾ ğŸ ğŸ–¤</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Qiwiæ”¯æ‰•ã„ã‚²ãƒ¼ãƒˆã‚¦ã‚§ã‚¤ã‚’ä»‹ã—ãŸæ”¯æ‰•ã„ã®å¯èƒ½æ€§ã‚’å®Ÿç¾ã™ã‚‹ã«ã¯ã€ãƒ­ã‚·ã‚¢èªã®é–‹ç™ºè€…å‘ã‘ã‚¬ã‚¤ãƒ‰ã‚’èª­ã‚€ã ã‘ã§ååˆ†ã§ã™ã€‚ ã—ã‹ã—ã€æœŸé™ãŒã‚ã‚Šã€é–‹ç™ºã«å¤šãã®æ™‚é–“ã‚’è²»ã‚„ã—ãŸããªã„äººã®ãŸã‚ã«ã€ã‚³ãƒ¼ãƒ‰ã‚’ä½¿ç”¨ã—ã¦è‡ªåˆ†ã®è¨ˆç®—ã§é–‹ç™ºãƒ—ãƒ­ã‚»ã‚¹ã‚’ä¿ƒé€²ã—ã‚ˆã†ã¨ã—ã¾ã™ã€‚ 
  
  
  
 åˆæœŸãƒ‡ãƒ¼ã‚¿-Node.js-0.12...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="sitemap" type="application/xml" href="/sitemap.xml"/>

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

  <script>document.write('<script src="https://pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://tech-in-japan.github.io/index.html"></a>
    <div class="page-header-text">Clever Geek Handbook</div>
  </header>
  <section class="page js-page"><h1>Node.jsä¸Šã®Qiwiã®IPN</h1><div class="post__text post__text-html js-mediator-article" id="post-content-body" data-io-article-url="https://habr.com/ru/post/323384/">  Qiwiæ”¯æ‰•ã„ã‚²ãƒ¼ãƒˆã‚¦ã‚§ã‚¤ã‚’ä»‹ã—ãŸæ”¯æ‰•ã„ã®å¯èƒ½æ€§ã‚’å®Ÿç¾ã™ã‚‹ã«ã¯ã€ãƒ­ã‚·ã‚¢èªã®é–‹ç™ºè€…å‘ã‘ã‚¬ã‚¤ãƒ‰ã‚’èª­ã‚€ã ã‘ã§ååˆ†ã§ã™ã€‚ ã—ã‹ã—ã€æœŸé™ãŒã‚ã‚Šã€é–‹ç™ºã«å¤šãã®æ™‚é–“ã‚’è²»ã‚„ã—ãŸããªã„äººã®ãŸã‚ã«ã€ã‚³ãƒ¼ãƒ‰ã‚’ä½¿ç”¨ã—ã¦è‡ªåˆ†ã®è¨ˆç®—ã§é–‹ç™ºãƒ—ãƒ­ã‚»ã‚¹ã‚’ä¿ƒé€²ã—ã‚ˆã†ã¨ã—ã¾ã™ã€‚ 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     åˆæœŸãƒ‡ãƒ¼ã‚¿-Node.js-0.12.4ã€Sails-v0.12.11 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     é–‹ç™ºã‚’é–‹å§‹ã™ã‚‹ã«ã¯ã€ <a href="https://ishop.qiwi.com/">https://ishop.qiwi.com</a>ã§ç™»éŒ²ã—ã¦ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ç¢ºèªã‚’å¾…ã¤å¿…è¦ãŒã‚ã‚Š<a href="https://ishop.qiwi.com/">ã¾ã™</a> ã€‚ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ç¢ºèªã—ãŸã‚‰ã€[è¨­å®š]â†’[ãƒ—ãƒ­ãƒˆã‚³ãƒ«]â†’[RESTãƒ—ãƒ­ãƒˆã‚³ãƒ«]ã«ç§»å‹•ã—ã€[èªè¨¼ãƒ‡ãƒ¼ã‚¿]ã‚¿ãƒ–ã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆID-ã‚¹ãƒˆã‚¢IDï¼ˆSHOP_IDï¼‰ã‚’ç¢ºèªã—ã¦RESTå¿œç­”ã‚’ç¢ºèªã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ ã•ã‚‰ã«ã€ã€Œæ–°ã—ã„IDã‚’ç”Ÿæˆã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã€Qiwi APIã¸ã®RESTãƒªã‚¯ã‚¨ã‚¹ãƒˆã®API_IDã‚’ç”Ÿæˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆAPI_PWDï¼‰ã‚’æ›¸ãç•™ã‚ã¦ãŠãå¿…è¦ãŒã‚ã‚‹ã“ã¨ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚ãã†ã™ã‚Œã°ã€ãã‚Œã‚’è¦‹ã‚‹å ´æ‰€ãŒãªããªã‚Šã¾ã™ã€‚ 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     æœ€åˆã«ã€ãƒ—ãƒ­ã‚°ãƒ©ãƒã‚’æ··ä¹±ã•ã›ã€Qiwiã«ã¯Paypalãªã©ã®ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹ãŒãªã„ã“ã¨ã‚’é€šçŸ¥ã—ã¾ã™ã€‚ã™ã¹ã¦ã®ä½œæ¥­ã¯ã€æœ€åˆã¯å®Ÿéš›ã®ãŠé‡‘ã¨ã‚«ãƒ¼ãƒ‰ã‚’ä½¿ç”¨ã—ã¦ãƒ©ã‚¤ãƒ–ã‚µãƒ¼ãƒãƒ¼ã§è¡Œã‚ã‚Œã¾ã™ã€‚ 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     ã¾ãšã€è«‹æ±‚æ›¸ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã™ã‚‹æ–¹æ³•ã‚’å­¦ã³ã¾ã™ã€‚ ç°¡å˜ã«è¨€ã†ã¨ã€æ”¯æ‰•ã„ãƒ—ãƒ­ã‚»ã‚¹å…¨ä½“ã¯ã€è«‹æ±‚ã€æ”¯æ‰•ã„ç”¨ãƒªãƒ³ã‚¯ã®å—ä¿¡ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒã‚µãƒ¼ãƒ“ã‚¹ã®æ”¯æ‰•ã„ã‚’è¡Œã†ã‚µã‚¤ãƒˆã¸ã®ç§»å‹•ã€Qiwi IPNã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®å¿œç­”ã‚µãƒ¼ãƒãƒ¼ã®å¾…æ©Ÿã§æ§‹æˆã•ã‚Œã¾ã™ã€‚ 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// AccountController.js module.exports = { // action for payment request qw_activate: function (req, res) { var user_id = user.id; var bill_id = user_id +'_'+ Date.now(), order_lifetime_days = 1, successUrl = req.param('success_return_url'), // redirect URL in case of success payment failUrl = req.param('fail_return_url'); // redirect URL in case of payment is failed var url = sails.config.custom_config.QIWI.API_URL+sails.config.custom_config.QIWI.SHOP_ID+'/bills/'+bill_id, request = require('request'), querystring = require('querystring'); var request_data = {headers: { "Accept": "text/json", "Authorization": 'Basic '+new Buffer( sails.config.custom_config.QIWI.API_ID +':'+ sails.config.custom_config.QIWI.API_PWD ).toString('base64'), "Content-Type": "application/x-www-form-urlencoded; charset=utf-8" }}; request_data.url = url; var lifetime = new Date(); lifetime.setHours(lifetime.getHours() + 24 * order_lifetime_days); request_data.body = querystring.stringify({ user: 'tel:'+req.param('phone').replace(/[\(\)]/g, ""), amount: sails.config.custom_config.QIWI.member_pro_membership_cost, ccy: sails.config.custom_config.QIWI.CURRENCY, // RUB || USD comment: "Payment for service by "+user.email, lifetime: lifetime.toISOString(), pay_source: 'qw', // 'mobile' prv_name: 'email@mail.ru' }); request.put(request_data, function (err, data) { if(err) return res.badRequest(err); // q if(JSON.parse(data.body).response.result_code == 0) { return res.ok({ url: 'https://qiwi.com/order/external/main.action?shop='+sails.config.custom_config.QIWI.SHOP_ID+'&amp;transaction='+bill_id+'&amp;successUrl='+successUrl+'&amp;failUrl='+failUrl+'&amp;iframe=false' }); } res.badRequest({ message: JSON.parse(data.body).response.description }); }); } }</span></span></code>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
     </pre> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     æ¬¡ã«ã€ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆã™ã‚‹ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ã¾ã™-æ”¯æ‰•ã„ã®ãƒªãƒ³ã‚¯ã‚’å–å¾—ã—ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’Qiwiã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆã«é€ä¿¡ã—ã¾ã™ã€‚ ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒQiwi Webã‚µã‚¤ãƒˆã§æ”¯æ‰•ã„ã‚’è¡Œã£ãŸå¾Œã€æ”¯æ‰•ã„ã®çµæœã«å¿œã˜ã¦ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¯æ”¯æ‰•ã„ãƒªãƒ³ã‚¯ã«ç¤ºã•ã‚ŒãŸsuccessUrlã¾ãŸã¯failUrlãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã—ã¾ã™ã€‚ æ”¯æ‰•ã„ã®çµæœï¼ˆã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€æˆåŠŸã€é…å»¶ã€ã‚¨ãƒ©ãƒ¼ãªã©ï¼‰ã«é–¢ä¿‚ãªãã€å½“ç¤¾ã®ã‚µãƒ¼ãƒãƒ¼ã¯Qiwi IPNã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®å¿œç­”ã‚’å—ä¿¡ã™ã‚‹ãŸã‚ã«é–‹ã„ã¦ã„ã¾ã™ã€‚ å›ç­”ã¯httpsã¨httpã®ä¸¡æ–¹ã«ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚  APIã‚µãƒ¼ãƒãƒ¼ã‚’httpsã«è»¢é€ã§ãã‚‹å ´åˆ-ã“ã®ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™-ã‚ˆã‚Šå®‰å…¨ã§ã™ã€‚ 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     ã‚³ãƒ¼ãƒ‰ã«ã¯ã€httpsçµŒç”±ã§å¿œç­”ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã‚³ãƒ¼ãƒ‰ã®ä¸€éƒ¨ãŒã‚ã‚Šã¾ã™ãŒã€æ¤œè¨¼ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã“ã®ã‚³ãƒ¼ãƒ‰ã¯ã€ç§ã®åŸºç¤ã¨ã—ã¦ä½¿ç”¨ã§ãã¾ã™ã€‚ ã‚µãƒ¼ãƒãƒ¼ã¸ã®httpã¾ãŸã¯httpsã‚’ä»‹ã—ã¦æ”¯æ‰•ã„ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«é–¢ã™ã‚‹å›ç­”ã‚’å—ã‘å–ã‚‹ã«ã¯ã€Qiwiå€‹äººã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¨­å®šã®ã€Œãƒ—ãƒ«ï¼ˆRESTï¼‰ãƒ—ãƒ­ãƒˆã‚³ãƒ«è¨­å®šã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’æ§‹æˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ é€šçŸ¥ã‚’æœ‰åŠ¹ã«ã—ã€é€šçŸ¥ã®URLã‚’æä¾›ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚  httpã®ãƒãƒ¼ãƒˆã¯80ã®ã¿ã€httpsã®å ´åˆã¯443ã§ã™ã€‚ä»–ã®ãƒãƒ¼ãƒˆã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚  ã€Œé€šçŸ¥ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®å¤‰æ›´ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã€é€šçŸ¥ç”¨ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ ãã®å¾Œã€ã‚³ãƒ¼ãƒ‰ã®è¨˜è¿°ã‚’é–‹å§‹ã§ãã¾ã™ã€‚ 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// AccountController.js module.exports = { // ipn action qw_ipn: function (req, res) { var Q = require('q'), THIS = this; (function (req, res) { var deferred = Q.defer(); var reqParams = req.allParams(); var UID = reqParams.bill_id ? reqParams.bill_id.split('_')[0] : null, payment_date = reqParams.bill_id ? new Date(parseInt(reqParams.bill_id.split('_')[1])) : null, txn_id = "txn_" + reqParams.bill_id, txn_status = reqParams.status; (function() { var deferred2 = Q.defer(); if (typeof req.headers.authorization !== 'undefined') { // Basic authorization if (req.headers.authorization == 'Basic ' + new Buffer(sails.config.custom_config.QIWI.SHOP_ID + ':' + sails.config.custom_config.QIWI.NOTIFICATION_PWD).toString('base64')) { deferred2.resolve(); } else { deferred2.reject(150); // Error in password verification } } else if (typeof req.headers['x-api-signature'] !== 'undefined') { // digital sign // </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">TODO:</span></span></span><span class="hljs-comment"> code not verified var crypto = require('crypto'), hexHash, signature = req.headers['x-api-signature'], encoded_signature, reqString = ""; var sortedIndexes = Object.keys(reqParams).sort(); // sort keys // generate string from values of sorted request for (var i in sortedIndexes) { reqString += "|" + reqParams[sortedIndexes[i]]; } reqString = THIS._convertUTF16ToUTF8ToByteStr(reqString.substring(1)); // convert UTF16 string to UTF8 and then to string of bytes hexHash = crypto.createHmac('sha1', THIS._convertUTF16ToUTF8ToByteStr(sails.config.custom_config.QIWI.SHOP_ID)).update(reqString).digest('hex'); // hashed string hexadecimal encoded_signature = new Buffer(THIS._convertUTF16ToUTF8ToByteStr(hexHash)).toString('base64'); // base64 encoded if (encoded_signature == signature) { // compare encoded signature with signature from header deferred2.resolve(); } else { deferred2.reject(151); // Error in sign verification } } return deferred2.promise; })().then(function() { if(parseFloat(reqParams.amount) !== sails.config.custom_config.QIWI.member_pro_membership_cost) return deferred.resolve(0); // ignore creating transactions for commission Transaction.findOne({txn_id: txn_id, payment_status: txn_status}).exec(function (err, found) { if (err) return deferred.reject('Invalid updating payment status. Error: ' + err); (function() { var deferred3 = Q.defer(); if (!found) { var params = { txn_id: txn_id, txn_type: reqParams.command, // "bill" mc_gross: reqParams.amount, mc_currency: reqParams.ccy, payment_date: payment_date, payment_status: reqParams.status, business: reqParams.prv_name, receiver_email: reqParams.prv_name, payer_id: UID, payer_email: reqParams.user, custom: JSON.stringify({error: reqParams.error}), gateway_type: Transaction.attributes.gateway_type.in[1] // qiwi gateway }; // first payment Transaction.create(params).then(function (created) { if (created) { deferred3.resolve(); } }).catch(function (err) { if (err) deferred3.reject('Invalid transaction creation. Error: ' + err); }); } else { // already exists deferred.resolve(0); } return deferred3.promise; })().then(function() { if (parseFloat(reqParams.amount) == sails.config.custom_config.QIWI.member_pro_membership_cost &amp;&amp; reqParams.ccy == sails.config.custom_config.QIWI.CURRENCY) { Model.findOne({id: UID}).then(function (found_user) { if(found_user) { switch(reqParams.status) { case 'paid': // mark user as paid ... break; case 'rejected': // mark user as unpaid if he was rejected payment ... break; } } else { if (err) return deferred.reject('User not found. Error: ' + err); } }).catch(function (err) { if (err) return deferred.reject('Error while searching user. Error: ' + err); }); } else { deferred.reject('Not valid currency or payment amount.'); } }, function(err) { deferred.reject('Error while transaction creation. Error: ' + err); }); }); }, function(err) { deferred.reject(err); }); return deferred.promise; })(req, res).then(function (result_code) { res.setHeader("Content-type", "text/xml"); var xml = '&lt;?xml version="1.0"?&gt;\ &lt;result&gt;\ &lt;result_code&gt;' + result_code + '&lt;/result_code&gt;\ &lt;/result&gt;'; return res.send(xml); }, function (error) { console.log(error); res.setHeader("Content-type", "text/xml"); var errNum = typeof error == 'number' ? error : 13; var xml = '&lt;?xml version="1.0"?&gt;\ &lt;result&gt;\ &lt;result_code&gt;' + errNum + '&lt;/result_code&gt;\ &lt;/result&gt;'; return res.send(xml); }); }, /** * Convert UTF16 string to UTF8 and then to bytes * @param str * @returns {string} * @private */ _convertUTF16ToUTF8ToByteStr: function (str) { var utf8 = unescape(encodeURIComponent(str)); var byteString = ""; for (var i = 0; i &lt; utf8.length; i++) { byteString += utf8.charCodeAt(i); } return byteString; } }</span></span></code>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
     </pre>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     ã‚³ãƒ¼ãƒ‰ã¯è¤‡é›‘ã§ã¯ã‚ã‚Šã¾ã›ã‚“ãŒã€ã„ãã¤ã‹ã®è³ªå•ãŒç™ºç”Ÿã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã«ã¤ã„ã¦ã¯ã€ä»¥ä¸‹ã§äºˆæ¸¬ã—ã¦å›ç­”ã‚’ç¤ºã—ã¾ã™ã€‚ 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Qiwi IPNã‚µãƒ¼ãƒãƒ¼ã¯ã€å¿œç­”ãŒçµæœã‚³ãƒ¼ãƒ‰0ã¨HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰200ã‚’è¿”ã™ã¾ã§ã€æ—¥ä¸­ã«é–“éš”ã‚’ç©ºã‘ã¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ç¹°ã‚Šè¿”ã—ã¾ã™ï¼ˆè©¦è¡Œå›æ•°50å›ã®ã¿ï¼‰ã€‚æ”¯æ‰•ã„ã®é‡è¤‡ã‚’é¿ã‘ã‚‹ãŸã‚ã€æœ€åˆã®é€šçŸ¥ã‚’å—ã‘å–ã£ãŸã¨ãã«ã€å°†æ¥ã€ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãŒã‚¢ã‚«ã‚¦ãƒ³ãƒˆç•ªå·ã§ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä½œæˆã—ã¾ã™ã“ã®ã‚ˆã†ãªã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒå­˜åœ¨ã™ã‚‹-ç§ã¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¾ã™ã€‚ ã¾ãŸã€æ”¯æ‰•ã„ã¨æ‰•ã„æˆ»ã—ã€ã¤ã¾ã‚Šã€Œæ”¯æ‰•ã„æ¸ˆã¿ã€ã¨ã€Œæ‹’å¦æ¸ˆã¿ã€ã®æ”¯æ‰•ã„ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«ã‚‚èˆˆå‘³ãŒã‚ã‚Šã¾ã™ã€‚ 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ã‚¿ã‚¤ãƒ—ã‚’ç†è§£ã™ã‚‹ãŸã‚ã«ã€ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã¸ã®ãƒ«ãƒ¼ãƒˆã‚’æŠ•ç¨¿ã—ã¾ã™ã€‚ 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// routes.js module.exports.routes = { 'POST /qw_ipn': 'AccountController.qw_ipn', 'POST /qw_activate': 'AccountController.qw_activate' }</span></span></code>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
     </pre>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     ã“ã‚Œã§ç§ã®çŸ­ã„æœ€åˆã®æŠ•ç¨¿ã¯çµ‚ã‚ã‚Šã§ã™ã€‚  Qiwi APIã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ã‚³ãƒ¼ãƒ‰ã‚’èª­ã‚€ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚ã™ã¹ã¦ã®ã‚¨ãƒ©ãƒ¼ç•ªå·ã€ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ãªã©ãŒè¨˜è¿°ã•ã‚Œã¦ã„ã¾ã™ã€‚ ã©ã‚“ãªã‚³ãƒ¡ãƒ³ãƒˆã§ã‚‚å–œã‚“ã§ã„ã¾ã™ã€‚ æ‰¹åˆ¤ãŒå¤§å¥½ãã§ã™ã€‚ </div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../J323372/index.html">ãƒ–ãƒ©ã‚¦ã‚¶ã§é€šçŸ¥ã‚’ãƒ—ãƒƒã‚·ãƒ¥ã—ã€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãƒˆãƒ©ãƒƒã‚¯ã‚’æ“ä½œã™ã‚‹</a></li>
<li><a href="../J323376/index.html">ãƒ–ãƒ©ã‚¦ã‚¶ãŠã‚ˆã³ãƒ¢ãƒã‚¤ãƒ«ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‹ã‚‰ã®ãƒ©ã‚¤ãƒ–ãƒ“ãƒ‡ã‚ªã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ç”¨ã«Amazon EC2ã‚¯ãƒ©ã‚¦ãƒ‰ã§WebRTCãƒ¡ãƒ‡ã‚£ã‚¢ã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã™ã‚‹</a></li>
<li><a href="../J323378/index.html">ãƒ­ã‚·ã‚¢ã®ãƒ“ãƒƒãƒˆã‚³ã‚¤ãƒ³ï¼šèª°ãŒä½¿ç”¨ã—ã¦ã„ã¾ã™ã‹ï¼Ÿ</a></li>
<li><a href="../J323380/index.html">ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚µãƒ‹ã‚¿ã‚¤ã‚¶ãƒ¼ã€ã¾ãŸã¯valgrindãŒæ©Ÿèƒ½ã—ãªã„å ´åˆã®å¯¾å‡¦æ–¹æ³•</a></li>
<li><a href="../J323382/index.html">ã‚¹ãƒãƒ¼ãƒˆã‚·ãƒ†ã‚£ã€ã¾ãŸã¯ã‚¹ãƒãƒ¼ãƒˆã‚·ãƒ†ã‚£=å¹¸ã›ãªå¸‚æ°‘</a></li>
<li><a href="../J323386/index.html">ç®¡ç†ã®æ¦‚è¦ï¼šãƒ–ãƒ¬ãƒ¼ãƒ‰ã‚·ã‚¹ãƒ†ãƒ ã®è¼ãã¨è²§å›°</a></li>
<li><a href="../J323388/index.html">JavaScriptã‚’ä½¿ç”¨ã—ãŸActionScript2.0ã®å¾©æ´»</a></li>
<li><a href="../J323390/index.html">é’ã„ãƒã‚¹ãƒ­ãƒ¼ãƒ–ã‚’æŒã£ã¦ãã¦</a></li>
<li><a href="../J323392/index.html">Yandexæ¤œç´¢ã€‚ ãã—ã¦ã€ã“ã‚Œã‚‰ã®äººã€…ã¯ç§ãŸã¡ã®é¼»ã‚’æ‘˜ã‚€ã“ã¨ã‚’ç¦ã˜ã¦ã„ã¾ã™</a></li>
<li><a href="../J323394/index.html">äººå£100ä¸‡äººä»¥ä¸Šã§å¥¥åœ°ã®ã‚ã‚‹éƒ½å¸‚ã§ã®ãƒªã‚¢ãƒªãƒ†ã‚£ã‚¯ã‚¨ã‚¹ãƒˆã®æ¨é€²</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter70218013 = new Ya.Metrika({
                  id:70218013,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/70218013" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'G-FEDBM7F51Q', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Clever Geek | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <div class="company-info js-company-info" itemscope="" itemtype="http://schema.org/Organization">
      <span itemprop="name">Western Town Media (WTM)</span>
      <div itemprop="address" itemscope="" itemtype="http://schema.org/PostalAddress">
        <span itemprop="streetAddress">1968 Stoney Lonesome Road</span>
        <br>
        <span itemprop="postalCode">PA 18640</span>
        <span itemprop="addressLocality">Pittston, USA</span>
      </div>
      <span itemprop="telephone">570-362-1316</span>
    </div>
    <script type="application/ld+json">
      {
        "@context": "http://schema.org",
        "@type": "Organization",
        "address": {
          "@type": "PostalAddress",
          "addressLocality": "Pittston, USA",
          "postalCode": "PA 18640",
          "streetAddress": "1968 Stoney Lonesome Road"
        },
        "name": "Western Town Media (WTM)",
        "telephone": "570-362-1316"
      }
    </script>
  </div>
</footer>
  
</body>

</html>