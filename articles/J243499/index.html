<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-FEDBM7F51Q"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-FEDBM7F51Q');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🙋 🚠 🚲 あなたのポケットの中の電子ケーキ：開発日記 🕌 👲🏾 ⬛️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="約1年前、公式のArduino Starter Kitで遊んでいたときに、妻に「サーキットケーキ」、つまり吹き飛ばすことができるLEDキャンドルの付いたボードを渡すようになりました。 このタスクは、マイクロコントローラーのプログラミング方法とプログラムを問題に変換する方法を理解するための良い教育プロ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="sitemap" type="application/xml" href="/sitemap.xml"/>

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

  <script>document.write('<script src="https://pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://tech-in-japan.github.io/index.html"></a>
    <div class="page-header-text">Clever Geek Handbook</div>
  </header>
  <section class="page js-page"><h1>あなたのポケットの中の電子ケーキ：開発日記</h1><div class="post__text post__text-html js-mediator-article" id="post-content-body"><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/2aa/ef1/4ee/2aaef14eee265914d196ce6bdb2a33b8.jpg" alt="秋の電子ケーキ"></div>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     約1年前、公式の<b>Arduino Starter Kit</b>で遊んでいたときに、妻に「サーキットケーキ」、つまり吹き飛ばすことができるLEDキャンドルの付いたボードを渡すようになりました。 このタスクは、マイクロコントローラーのプログラミング方法とプログラムを問題に変換する方法を理解するための良い教育プロジェクトのように思えました（結局、私は比較的最近エレクトロニクスに関与し始め、学校でプログラミングを始めたので、教育に大きなギャップを感じました）。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     このようなシンプルなデバイスをゼロから開発した経験を共有し、同時にそのスキームとプログラムをレイアウトして、自宅でプレイできるようにしたいと思います。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h1> 物語 </h1>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     最初のプロトタイプは、 <b>Arduino Unoで</b>作成され、ろうそくを吹き消すための検出器として圧電素子が取り付けられました。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/02b/fa0/edb/02bfa0edb6ba58042b92447d7354b940.jpg" alt="Arduino Unoのプロトタイプ電子ケーキ"></div>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     圧電素子の電圧を読み取ると、デバイスは読み取り値のわずかな変化を予期していました。 しかし、ADCの最大解像度でさえ、ろうそくが消え始めるように非常によく吹く必要がありました。 しかし、それらはうまくいきました。最初は、それぞれのろうそくに与えられたランダムな寿命に応じて、異なる周波数と位相で明滅し始め、次に順番に消えました。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     次のステップでは、ワイヤーを貼り付けたボードよりもケーキをエレガントにすることにしました。 また、ケーキが小さなマイクロコントローラーで動作することを妻に見せたかった。 インターネットのどこかで、 <b>Arduino</b>を<b>ATTiny85</b>コントローラーで実行できるという記事を見つけ、それを頭脳として使用することにしました。 問題は、このコントローラーにはろうそくとセンサーに使用できる汎用脚が5つしかないため、各LEDを別々の脚に置くと4つのろうそくしか使用できないことが判明したことです。 当時、私はチャーレプレックスについて知らなかったので、ろうそくをインバーターの遅延回路で複製することにしました。LEDが点滅すると、だれかが位相遅延で複製されていることに気付かないでしょう。 さらに、追加の要素は、キャンドルを配置するための円形パターンにうまく適合します。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/33d/bba/0ef/33dbba0efb6e37dd60ea85738541eb9f.jpg" alt="遅延回路を備えたATTiny85電子ケーキプロトタイプ"></div>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     電源として、4つのAAAバッテリーを使用しましたが、外観の簡潔さに違反しました。 さらに、私はより正直なろうそくとより高い感度が欲しかった。  ATTinyシリーズのマイクロコントローラーの仕様を調べてみたところ、11の一般的な汎用脚を持つ<b>ATTiny84</b>という素晴らしいアナログが見つかりました。 さらに、20倍の差動アンプを備えたADC入力を備えています！ そこで、新しいプロトタイプが登場しました。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/60b/6c6/42f/60b6c642f398c1679c3e921bdfee420a.jpg" alt="2個の単三電池を備えたATTiny44のプロトタイプ電子ケーキ"></div>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     フロア間に2個のAAAバッテリーを入れたいと思っていましたが、ラックのサイズとピエゾ素子の計算を間違えました。これはボードに隣接してはならないため、バッテリーをボードの下に貼り付けなければなりませんでした。 信号の増幅により、ケーキの感度が非常に高くなり、ノイズが発生したため、アルゴリズムを変更する必要がありました。信号の標準偏差を測定し、この偏差が経験的に決定されたしきい値を超えたときにブローイングロジックをオンにしました。 プログラムは小さく、4 kB未満であることが判明したため、 <b>ATTiny44を</b>使用しました。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     回路の電源と床の間の空きスペースが本当に好きではありませんでした。バッテリーの仕様を調べてみると、AAAAバッテリーがあることがわかりました。 それらは非常に小さく、数百ミリアンペアの電流を供給します。 購入するのは難しいですが、タイプ<b>6LR61の</b> 9ボルトのバッテリーを使用する場合は、6個のAAAAバッテリーで構成されています。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     また、バッテリー電流を増やすことで供給電圧を+5 Vに上げる興味深い<b>HT7750</b>スイッチング電源<b>マイクロサーキットを</b>見つけ、対角線に1つのAAAAバッテリーが収まるサイズのケーキを作ることにしました。 次のプロトタイプが判明しました。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/2be/e02/7b1/2bee027b16a7f9e3f466ef62544724a2.jpg" alt="単3電池1個を搭載したATTiny44電子ケーキプロトタイプ"></div>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     広角LEDを使用すると、ケーキの美観が向上するだけでなく、視野角も広がりました。 中国でボードを注文しました。これにより、完成したデバイスの品質が向上しました。 しかし、私が予想していなかったのは、吹くときのノイズの急激な増加でした。 実際には、スイッチング電源自体にノイズが多く、ここでは、異なる数のLEDがオンのときの出力電圧の電流依存性もあります。 古いアルゴリズムは機能しなくなったため、圧電センサーからコンピューターへの読み取り値を読み取り、信号の振幅周波数特性を分析するという、より徹底的なタスクにアプローチする必要がありました。 私は、1分間の沈黙、1分間の吹き飛ばし、そして1分間の身体に対する摩擦音を記録しました。 圧電素子の共振は約1 kHzであり、ろうそくが吹き消されていることが確実に判断できます。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     そのため、ろうそくを吹き消す瞬間を判断するために、周波数1 kHzのハニングウィンドウを使用した高速フーリエ変換を検討し始めました。  <b>ATTiny44に</b>は乗算コマンドが組み込まれておらず、メモリが非常に限られているため（256バイトのRAM、プログラムごとに4 kB）、すべての乗算をシフトと加算に置き換える必要があり、一般にすべてが適合するようにプログラムを最適化することが不可欠でした。 プログラム変更の結果、ケーキは他のすべてのプロトタイプの感度を上回りました。 その後、信号経路内の不要な成分を除去し始めました。これは単純にハイパスフィルターと見なされ、ケーキの応答性はさらに向上しました。  <b>HT7750</b>を<b>HT7733に</b>交換し<b>ます</b> 。 出力を+5 Vから+3.3 Vに置き換えると、バッテリーをより経済的に使用できます。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     最後に私を混乱させたのは、オフモードのパワーチップが約17 µAを消費したことで、これは1年でバッテリーが空になったことを意味します。 しかし、このチップにはイネーブル入力を備えた<b>SOT-25</b>パッケージの一実施形態があり、リセットボタンを押すとチップの解像度入力で高レベルを供給するためにコンデンサを充電し、その後ゆっくり放電する小さなスイッチング回路を構成したことを思い出しました10メガオームの抵抗を介して3分間。 このタイムアウト後、ケーキはオフになり、1μA未満の消費を開始します。これは、バッテリーの自己放電電流に匹敵します。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/731/314/747/731314747c8c08f1929b22ed9a29ebce.jpg" alt="サイズ比較のための手の背景に電子ケーキ"></div>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h1> 回路図 </h1>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/30c/d41/9ff/30cd419ff7d511e72e304c4ce11e5bb4.png" alt="ケーキのコンセプト"></div>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b>HT7733</b>は、入力電圧を+3.3 Vに上げるスイッチング電源です。直径20 mmのピエゾ素子は、マイクロコントローラーの差動ADCに20倍のゲインで接続されます。 各LEDは、マイクロコントローラーの一方の脚に接続されています。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b>RESETを</b>押すと、トランジスタが開き、10μFのコンデンサが充電され、パワーチップの分解能入力に高レベルが適用されます。 チップはオンになり、3分間+3.3 Vの出力を開始しますが、10 uFのコンデンサは10メガオームの抵抗を通して放電されます。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h1> プログラム </h1>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div class="spoiler">  <b class="spoiler_title">Arduino IDE用のC ++プログラム</b> <div class="spoiler_text"><pre><code class="hljs dos">///////////////////////////////////////////////////////////////////////////////////////////////// // BitCake v1.<span class="hljs-number"><span class="hljs-number">1</span></span>.<span class="hljs-number"><span class="hljs-number">1</span></span> / November <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-number"><span class="hljs-number">2014</span></span> // by Maksym Ganenko &lt;buratin.barabanus <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> Google Mail&gt; ///////////////////////////////////////////////////////////////////////////////////////////////// #include &lt;avr/interrupt.h&gt; #include &lt;avr/pgmspace.h&gt; #include &lt;avr/power.h&gt; #include &lt;avr/sleep.h&gt; #include &lt;<span class="hljs-built_in"><span class="hljs-built_in">time</span></span>.h&gt; #include &lt;util/delay.h&gt; ///////////////////////////////////////////////////////////////////////////////////////////////// // <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> fixed delta loop <span class="hljs-built_in"><span class="hljs-built_in">time</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> milliseconds // <span class="hljs-number"><span class="hljs-number">0</span></span> to use internal timer const uint8_t DELTA_LOOP_TIME_MS = <span class="hljs-number"><span class="hljs-number">14</span></span>; // amplify intermediate values to get better calculation accuracy const uint8_t SAMPLES_GAIN_ORDER = <span class="hljs-number"><span class="hljs-number">5</span></span>; // x32 const uint8_t RESULT_GAIN_ORDER = <span class="hljs-number"><span class="hljs-number">2</span></span>; // x4 // LEDs encoded by ports ID const prog_int8_t LEDS[] PROGMEM = { <span class="hljs-number"><span class="hljs-number">0</span></span>xA6, <span class="hljs-number"><span class="hljs-number">0</span></span>xA7, <span class="hljs-number"><span class="hljs-number">0</span></span>xB2, <span class="hljs-number"><span class="hljs-number">0</span></span>xB1, <span class="hljs-number"><span class="hljs-number">0</span></span>xB0, <span class="hljs-number"><span class="hljs-number">0</span></span>xA2, <span class="hljs-number"><span class="hljs-number">0</span></span>xA3, <span class="hljs-number"><span class="hljs-number">0</span></span>xA4, <span class="hljs-number"><span class="hljs-number">0</span></span>xA5 }; const uint8_t LEDS_NUM = sizeof(LEDS) / sizeof(LEDS[<span class="hljs-number"><span class="hljs-number">0</span></span>]); // ADMUX register code <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ADC const uint8_t PIEZO_ADMUX = <span class="hljs-number"><span class="hljs-number">0</span></span>b10101001; // Vref = <span class="hljs-number"><span class="hljs-number">1</span></span>.<span class="hljs-number"><span class="hljs-number">1</span></span>V, (A1 - A0) x <span class="hljs-number"><span class="hljs-number">20</span></span> // MCU prescaler const uint8_t MCU_PRESCALER = <span class="hljs-number"><span class="hljs-number">0</span></span>b000; // <span class="hljs-number"><span class="hljs-number">1</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">8</span></span> Mhz CPU clock // ADC prescaler const uint8_t ADC_PRESCALER = <span class="hljs-number"><span class="hljs-number">0</span></span>b100; // <span class="hljs-number"><span class="hljs-number">16</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">512</span></span> kHz ADC clock =&gt; <span class="hljs-number"><span class="hljs-number">38</span></span>.<span class="hljs-number"><span class="hljs-number">5</span></span>k reads per sec // number of piezo reads to average per sample (<span class="hljs-keyword"><span class="hljs-keyword">for</span></span> noise reduction) const uint8_t SUBSAMPLE_BUF_ORDER = <span class="hljs-number"><span class="hljs-number">4</span></span>; // =&gt; <span class="hljs-number"><span class="hljs-number">16</span></span> const uint8_t SUBSAMPLE_BUF_SIZE = (<span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; SUBSAMPLE_BUF_ORDER); // FFT samples number - can't be changed without changing FFT calculation code const uint8_t SAMPLE_BUF_ORDER = <span class="hljs-number"><span class="hljs-number">5</span></span>; // =&gt; <span class="hljs-number"><span class="hljs-number">32</span></span> const uint8_t SAMPLE_BUF_SIZE = (<span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; SAMPLE_BUF_ORDER); // FFT signal threshold to activate blowing logic // this value defines the sensitivity of device // depends on electronic components noise const uint8_t BLOWING_THRESHOLD = <span class="hljs-number"><span class="hljs-number">3</span></span>; // timeouts <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> milliseconds const uint32_t SETUP_TIME_MS = <span class="hljs-number"><span class="hljs-number">750</span></span>; // timeout before activating of cake logic const uint32_t DELAY_BLOWING_MS = <span class="hljs-number"><span class="hljs-number">0</span></span>; // delay LEDs flickering when blowing detected const uint32_t PROLONG_BLOWING_MS = <span class="hljs-number"><span class="hljs-number">150</span></span>; // prolong blowing logic when no blowing detected const uint32_t NO_ACTIVITY_MS = <span class="hljs-number"><span class="hljs-number">60000</span></span>; // turn off cake <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> no blowing detected const uint32_t TIME_LIMIT_MS = <span class="hljs-number"><span class="hljs-number">150000</span></span>; // <span class="hljs-built_in"><span class="hljs-built_in">time</span></span> limit <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> cake to work // LEDs blinking periods when blowing logic is activated const uint8_t LEDS_PERIOD_MIN_MS = <span class="hljs-number"><span class="hljs-number">100</span></span>; const uint8_t LEDS_PERIOD_MAX_MS = <span class="hljs-number"><span class="hljs-number">150</span></span>; // LEDs <span class="hljs-built_in"><span class="hljs-built_in">time</span></span>-to-live timeouts const uint16_t LEDS_TTL_MIN_MS = <span class="hljs-number"><span class="hljs-number">200</span></span>; const uint16_t LEDS_TTL_MAX_MS = <span class="hljs-number"><span class="hljs-number">1000</span></span>; ///////////////////////////////////////////////////////////////////////////////////////////////// volatile uint8_t samplePos = SAMPLE_BUF_SIZE; // FFT10 specific accumulators int16_t sampleAccA [<span class="hljs-number"><span class="hljs-number">5</span></span>]; int16_t sampleAccB [<span class="hljs-number"><span class="hljs-number">5</span></span>]; // LEDs state variables uint16_t ledsActivity; uint8_t ledsPeriod [LEDS_NUM]; uint8_t ledsPhase [LEDS_NUM]; uint8_t ledsTTL [LEDS_NUM]; // blowing logic state uint8_t blowing = false; uint32_t lastBlowingTime = <span class="hljs-number"><span class="hljs-number">0</span></span>; int16_t totalBlowingTime = <span class="hljs-number"><span class="hljs-number">0</span></span>; uint32_t globalTime = <span class="hljs-number"><span class="hljs-number">0</span></span>; uint32_t lastLoopTime; uint32_t setupPhaseTime; // <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> compatibility with other Atmel MCUs uint8_t portA, portB, portC, portD; ///////////////////////////////////////////////////////////////////////////////////////////////// // fast distance approximation uint32_t approxDist(int32_t dx, int32_t dy) { uint32_t min, max; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dx &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) dx = -dx; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dy &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) dy = -dy; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dx &lt; dy) { min = dx; max = dy; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { min = dy; max = dx; } // coefficients equivalent to (<span class="hljs-number"><span class="hljs-number">123</span></span>/<span class="hljs-number"><span class="hljs-number">128</span></span> * max) and (<span class="hljs-number"><span class="hljs-number">51</span></span>/<span class="hljs-number"><span class="hljs-number">128</span></span> * min) return (((max &lt;&lt; <span class="hljs-number"><span class="hljs-number">8</span></span>) + (max &lt;&lt; <span class="hljs-number"><span class="hljs-number">3</span></span>) - (max &lt;&lt; <span class="hljs-number"><span class="hljs-number">4</span></span>) - (max &lt;&lt; <span class="hljs-number"><span class="hljs-number">1</span></span>) + (min &lt;&lt; <span class="hljs-number"><span class="hljs-number">7</span></span>) - (min &lt;&lt; <span class="hljs-number"><span class="hljs-number">5</span></span>) + (min &lt;&lt; <span class="hljs-number"><span class="hljs-number">3</span></span>) - (min &lt;&lt; <span class="hljs-number"><span class="hljs-number">1</span></span>)) &gt;&gt; <span class="hljs-number"><span class="hljs-number">8</span></span>); } const uint8_t FFT_DIVIDER_ORDER = <span class="hljs-number"><span class="hljs-number">8</span></span>; // =&gt; <span class="hljs-number"><span class="hljs-number">256</span></span> // approximate multiplication int32_t mul256(int32_t x) { return x &lt;&lt; <span class="hljs-number"><span class="hljs-number">8</span></span>; } int32_t mul240(int32_t x) { return (x &lt;&lt; <span class="hljs-number"><span class="hljs-number">8</span></span>) - (x &lt;&lt; <span class="hljs-number"><span class="hljs-number">4</span></span>); } int32_t mul208(int32_t x) { return (x &lt;&lt; <span class="hljs-number"><span class="hljs-number">7</span></span>) + (x &lt;&lt; <span class="hljs-number"><span class="hljs-number">6</span></span>) + (x &lt;&lt; <span class="hljs-number"><span class="hljs-number">4</span></span>); } int32_t mul176(int32_t x) { return (x &lt;&lt; <span class="hljs-number"><span class="hljs-number">7</span></span>) + (x &lt;&lt; <span class="hljs-number"><span class="hljs-number">5</span></span>) + (x &lt;&lt; <span class="hljs-number"><span class="hljs-number">4</span></span>); } int32_t mul144(int32_t x) { return (x &lt;&lt; <span class="hljs-number"><span class="hljs-number">7</span></span>) + (x &lt;&lt; <span class="hljs-number"><span class="hljs-number">4</span></span>); } int32_t mul96(int32_t x) { return (x &lt;&lt; <span class="hljs-number"><span class="hljs-number">6</span></span>) + (x &lt;&lt; <span class="hljs-number"><span class="hljs-number">5</span></span>); } int32_t mul48(int32_t x) { return (x &lt;&lt; <span class="hljs-number"><span class="hljs-number">5</span></span>) + (x &lt;&lt; <span class="hljs-number"><span class="hljs-number">4</span></span>); } typedef int32_t (*fmul32)(int32_t); const fmul32 fmulVec[<span class="hljs-number"><span class="hljs-number">4</span></span>] = { mul96, mul176, mul240, mul256 }; // calculate FFT[<span class="hljs-number"><span class="hljs-number">10</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-number"><span class="hljs-number">32</span></span> samples uint8_t fft10() { int32_t a = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (uint8_t i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">4</span></span>; ++i) { a += fmulVec[i](sampleAccA[i + <span class="hljs-number"><span class="hljs-number">1</span></span>]); } int32_t b = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (uint8_t i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">4</span></span>; ++i) { b += fmulVec[i](sampleAccB[i + <span class="hljs-number"><span class="hljs-number">1</span></span>]); } uint32_t result = approxDist(a &lt;&lt; RESULT_GAIN_ORDER, b &lt;&lt; RESULT_GAIN_ORDER); result &gt;&gt;= FFT_DIVIDER_ORDER; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>xff) return <span class="hljs-number"><span class="hljs-number">0</span></span>xff; return result; } ///////////////////////////////////////////////////////////////////////////////////////////////// // fft10 specific coefficients const prog_int8_t sampleAccDestA[SAMPLE_BUF_SIZE / <span class="hljs-number"><span class="hljs-number">2</span></span>] PROGMEM = { +<span class="hljs-number"><span class="hljs-number">4</span></span>, -<span class="hljs-number"><span class="hljs-number">1</span></span>, -<span class="hljs-number"><span class="hljs-number">2</span></span>, +<span class="hljs-number"><span class="hljs-number">3</span></span>, +<span class="hljs-number"><span class="hljs-number">0</span></span>, -<span class="hljs-number"><span class="hljs-number">3</span></span>, +<span class="hljs-number"><span class="hljs-number">2</span></span>, +<span class="hljs-number"><span class="hljs-number">1</span></span>, -<span class="hljs-number"><span class="hljs-number">4</span></span>, +<span class="hljs-number"><span class="hljs-number">1</span></span>, +<span class="hljs-number"><span class="hljs-number">2</span></span>, -<span class="hljs-number"><span class="hljs-number">3</span></span>, +<span class="hljs-number"><span class="hljs-number">0</span></span>, +<span class="hljs-number"><span class="hljs-number">3</span></span>, -<span class="hljs-number"><span class="hljs-number">2</span></span>, -<span class="hljs-number"><span class="hljs-number">1</span></span> }; const prog_int8_t sampleAccDestB[SAMPLE_BUF_SIZE / <span class="hljs-number"><span class="hljs-number">2</span></span>] PROGMEM = { +<span class="hljs-number"><span class="hljs-number">0</span></span>, +<span class="hljs-number"><span class="hljs-number">3</span></span>, -<span class="hljs-number"><span class="hljs-number">2</span></span>, -<span class="hljs-number"><span class="hljs-number">1</span></span>, +<span class="hljs-number"><span class="hljs-number">4</span></span>, -<span class="hljs-number"><span class="hljs-number">1</span></span>, -<span class="hljs-number"><span class="hljs-number">2</span></span>, +<span class="hljs-number"><span class="hljs-number">3</span></span>, +<span class="hljs-number"><span class="hljs-number">0</span></span>, -<span class="hljs-number"><span class="hljs-number">3</span></span>, +<span class="hljs-number"><span class="hljs-number">2</span></span>, +<span class="hljs-number"><span class="hljs-number">1</span></span>, -<span class="hljs-number"><span class="hljs-number">4</span></span>, +<span class="hljs-number"><span class="hljs-number">1</span></span>, +<span class="hljs-number"><span class="hljs-number">2</span></span>, -<span class="hljs-number"><span class="hljs-number">3</span></span> }; const uint8_t HANNING_DIVIDER_ORDER = <span class="hljs-number"><span class="hljs-number">6</span></span>; // =&gt; <span class="hljs-number"><span class="hljs-number">64</span></span> // hanning window coefficients int16_t mul0(int16_t x) { return <span class="hljs-number"><span class="hljs-number">0</span></span>; } int16_t mul1(int16_t x) { return x; } int16_t mul3(int16_t x) { return (x &lt;&lt; <span class="hljs-number"><span class="hljs-number">2</span></span>) - x; } int16_t mul6(int16_t x) { return (x &lt;&lt; <span class="hljs-number"><span class="hljs-number">3</span></span>) - (x &lt;&lt; <span class="hljs-number"><span class="hljs-number">1</span></span>); } int16_t mul10(int16_t x) { return (x &lt;&lt; <span class="hljs-number"><span class="hljs-number">3</span></span>) + (x &lt;&lt; <span class="hljs-number"><span class="hljs-number">1</span></span>); } int16_t mul15(int16_t x) { return (x &lt;&lt; <span class="hljs-number"><span class="hljs-number">4</span></span>) - x; } int16_t mul21(int16_t x) { return (x &lt;&lt; <span class="hljs-number"><span class="hljs-number">4</span></span>) + (x &lt;&lt; <span class="hljs-number"><span class="hljs-number">2</span></span>) + x; } int16_t mul27(int16_t x) { return (x &lt;&lt; <span class="hljs-number"><span class="hljs-number">5</span></span>) - (x &lt;&lt; <span class="hljs-number"><span class="hljs-number">2</span></span>) - x; } int16_t mul34(int16_t x) { return (x &lt;&lt; <span class="hljs-number"><span class="hljs-number">5</span></span>) + (x &lt;&lt; <span class="hljs-number"><span class="hljs-number">2</span></span>); } int16_t mul40(int16_t x) { return (x &lt;&lt; <span class="hljs-number"><span class="hljs-number">5</span></span>) + (x &lt;&lt; <span class="hljs-number"><span class="hljs-number">3</span></span>); } int16_t mul46(int16_t x) { return (x &lt;&lt; <span class="hljs-number"><span class="hljs-number">5</span></span>) + (x &lt;&lt; <span class="hljs-number"><span class="hljs-number">4</span></span>) - (x &lt;&lt; <span class="hljs-number"><span class="hljs-number">2</span></span>); } int16_t mul52(int16_t x) { return (x &lt;&lt; <span class="hljs-number"><span class="hljs-number">6</span></span>) - (x &lt;&lt; <span class="hljs-number"><span class="hljs-number">3</span></span>) - (x &lt;&lt; <span class="hljs-number"><span class="hljs-number">2</span></span>); } int16_t mul56(int16_t x) { return (x &lt;&lt; <span class="hljs-number"><span class="hljs-number">6</span></span>) - (x &lt;&lt; <span class="hljs-number"><span class="hljs-number">3</span></span>); } int16_t mul60(int16_t x) { return (x &lt;&lt; <span class="hljs-number"><span class="hljs-number">6</span></span>) - (x &lt;&lt; <span class="hljs-number"><span class="hljs-number">2</span></span>); } int16_t mul63(int16_t x) { return (x &lt;&lt; <span class="hljs-number"><span class="hljs-number">6</span></span>) - x; } int16_t mul64(int16_t x) { return (x &lt;&lt; <span class="hljs-number"><span class="hljs-number">6</span></span>); } // hanning window coefficients typedef int16_t (*fmul16)(int16_t); const fmul16 hanningVec[] = { mul0, mul1, mul3, mul6, mul10, mul15, mul21, mul27, mul34, mul40, mul46, mul52, mul56, mul60, mul63, mul64 }; // ADC interrup routine // we average SUBSAMPLE_BUF_SIZE reads from ADC to reduce noise // and apply the calculated value on fft10 specific accumulators ISR(ADC_vect) { static uint8_t subsampleCtr = <span class="hljs-number"><span class="hljs-number">0</span></span>; static int16_t subsampleSum = <span class="hljs-number"><span class="hljs-number">0</span></span>; // read ADC uint8_t low = ADCL, high = ADCH; int16_t subsample = (high &lt;&lt; <span class="hljs-number"><span class="hljs-number">8</span></span>) | low; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (samplePos &lt; SAMPLE_BUF_SIZE) { subsampleSum += subsample; ++subsampleCtr; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (subsampleCtr == SUBSAMPLE_BUF_SIZE) { // average of subsamples int16_t sample = (subsampleSum &gt;&gt; SUBSAMPLE_BUF_ORDER) &lt;&lt; SAMPLES_GAIN_ORDER; uint8_t halfPos = samplePos &amp; (SAMPLE_BUF_SIZE / <span class="hljs-number"><span class="hljs-number">2</span></span> - <span class="hljs-number"><span class="hljs-number">1</span></span>); uint8_t mulPos = halfPos; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (halfPos != samplePos) { mulPos = SAMPLE_BUF_SIZE / <span class="hljs-number"><span class="hljs-number">2</span></span> - mulPos; } // multiply by hanning window coefficient sample = hanningVec[mulPos](sample) &gt;&gt; HANNING_DIVIDER_ORDER; int8_t destA = pgm_read_byte_near(sampleAccDestA + halfPos); int8_t destB = pgm_read_byte_near(sampleAccDestB + halfPos); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (destA &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) sampleAccA[destA] += sample; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> sampleAccA[-destA] -= sample; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (destB &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) sampleAccB[destB] += sample; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> sampleAccB[-destB] -= sample; ++samplePos; subsampleSum = subsampleCtr = <span class="hljs-number"><span class="hljs-number">0</span></span>; } } } ///////////////////////////////////////////////////////////////////////////////////////////////// void powerDown() { // all pins to low portA = portB = portC = portD = <span class="hljs-number"><span class="hljs-number">0</span></span>; portsUpdateFinish(); // disable ADC ADCSRA &amp;= ~_BV(ADEN); // power down set_sleep_mode(SLEEP_MODE_PWR_DOWN); sleep_mode(); } void portsUpdateStart() { #<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">defined</span></span>(PORTA) portA = PORTA; #endif #<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">defined</span></span>(PORTB) portB = PORTB; #endif #<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">defined</span></span>(PORTC) portC = PORTC; #endif #<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">defined</span></span>(PORTD) portD = PORTD; #endif } void portsUpdateFinish() { #<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">defined</span></span>(PORTA) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (PORTA != portA) { PORTA = portA; } #endif #<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">defined</span></span>(PORTB) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (PORTB != portB) { PORTB = portB; } #endif #<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">defined</span></span>(PORTC) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (PORTC != portC) { PORTC = portC; } #endif #<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">defined</span></span>(PORTD) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (PORTD != portD) { PORTD = portD; } #endif } void writeLed(uint8_t anIndex, uint8_t aValue) { uint8_t led = pgm_read_byte_near(LEDS + anIndex); uint8_t code = _BV(led &amp; <span class="hljs-number"><span class="hljs-number">0</span></span>x0F); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (aValue &amp;&amp; bitRead(ledsActivity, anIndex)) { switch(led &amp; <span class="hljs-number"><span class="hljs-number">0</span></span>xF0) { #<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">defined</span></span>(PORTA) case <span class="hljs-number"><span class="hljs-number">0</span></span>xA0: portA |= code; <span class="hljs-built_in"><span class="hljs-built_in">break</span></span>; #endif #<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">defined</span></span>(PORTB) case <span class="hljs-number"><span class="hljs-number">0</span></span>xB0: portB |= code; <span class="hljs-built_in"><span class="hljs-built_in">break</span></span>; #endif #<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">defined</span></span>(PORTC) case <span class="hljs-number"><span class="hljs-number">0</span></span>xC0: portC |= code; <span class="hljs-built_in"><span class="hljs-built_in">break</span></span>; #endif #<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">defined</span></span>(PORTD) case <span class="hljs-number"><span class="hljs-number">0</span></span>xD0: portD |= code; <span class="hljs-built_in"><span class="hljs-built_in">break</span></span>; #endif } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { switch(led &amp; <span class="hljs-number"><span class="hljs-number">0</span></span>xF0) { #<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">defined</span></span>(PORTA) case <span class="hljs-number"><span class="hljs-number">0</span></span>xA0: portA &amp;= ~code; <span class="hljs-built_in"><span class="hljs-built_in">break</span></span>; #endif #<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">defined</span></span>(PORTB) case <span class="hljs-number"><span class="hljs-number">0</span></span>xB0: portB &amp;= ~code; <span class="hljs-built_in"><span class="hljs-built_in">break</span></span>; #endif #<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">defined</span></span>(PORTC) case <span class="hljs-number"><span class="hljs-number">0</span></span>xC0: portC &amp;= ~code; <span class="hljs-built_in"><span class="hljs-built_in">break</span></span>; #endif #<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">defined</span></span>(PORTD) case <span class="hljs-number"><span class="hljs-number">0</span></span>xD0: portD &amp;= ~code; <span class="hljs-built_in"><span class="hljs-built_in">break</span></span>; #endif } } } ///////////////////////////////////////////////////////////////////////////////////////////////// void setup() { portsUpdateStart(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (uint8_t i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; LEDS_NUM; ++i) { bitSet(ledsActivity, i); uint8_t led = pgm_read_byte_near(LEDS + i); uint8_t code = _BV(led &amp; <span class="hljs-number"><span class="hljs-number">0</span></span>x0F); switch (led &amp; <span class="hljs-number"><span class="hljs-number">0</span></span>xF0) { #<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">defined</span></span>(DDRA) case <span class="hljs-number"><span class="hljs-number">0</span></span>xA0: DDRA |= code; <span class="hljs-built_in"><span class="hljs-built_in">break</span></span>; #endif #<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">defined</span></span>(DDRB) case <span class="hljs-number"><span class="hljs-number">0</span></span>xB0: DDRB |= code; <span class="hljs-built_in"><span class="hljs-built_in">break</span></span>; #endif #<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">defined</span></span>(DDRC) case <span class="hljs-number"><span class="hljs-number">0</span></span>xC0: DDRC |= code; <span class="hljs-built_in"><span class="hljs-built_in">break</span></span>; #endif #<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">defined</span></span>(DDRD) case <span class="hljs-number"><span class="hljs-number">0</span></span>xD0: DDRD |= code; <span class="hljs-built_in"><span class="hljs-built_in">break</span></span>; #endif } writeLed(i, HIGH); } portsUpdateFinish(); // <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> MCU prescaler CLKPR = <span class="hljs-number"><span class="hljs-number">0</span></span>b10000000; CLKPR = MCU_PRESCALER; // <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> ADC prescaler ADCSRA = (ADCSRA &amp; ~<span class="hljs-number"><span class="hljs-number">0</span></span>b111) | ADC_PRESCALER; // activate ADC auto-triggering ADCSRA |= _BV(ADATE) | _BV(ADIE); ADMUX = PIEZO_ADMUX; ADCSRA |= _BV(ADSC); // disable all digital inputs DIDR0 = <span class="hljs-number"><span class="hljs-number">0</span></span>xff; // disable analog comparator ACSR |= _BV(ACD); // disable timer <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> delta loop <span class="hljs-built_in"><span class="hljs-built_in">time</span></span> is <span class="hljs-keyword"><span class="hljs-keyword">defined</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (DELTA_LOOP_TIME_MS) { power_timer0_disable(); power_timer1_disable(); set_sleep_mode(SLEEP_MODE_ADC); } _delay_ms(<span class="hljs-number"><span class="hljs-number">100</span></span>); lastLoopTime = DELTA_LOOP_TIME_MS ? <span class="hljs-number"><span class="hljs-number">0</span></span> : millis(); setupPhaseTime = lastLoopTime + SETUP_TIME_MS; } void loop() { uint32_t <span class="hljs-built_in"><span class="hljs-built_in">time</span></span> = DELTA_LOOP_TIME_MS ? globalTime : millis(); uint16_t loopDeltaTime = <span class="hljs-built_in"><span class="hljs-built_in">time</span></span> - lastLoopTime; uint8_t setupPhase = <span class="hljs-built_in"><span class="hljs-built_in">time</span></span> &lt; setupPhaseTime; rand(); // update random seed // wait <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ADC routine to read all samples <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> FFT memset(sampleAccA, <span class="hljs-number"><span class="hljs-number">0</span></span>, sizeof(sampleAccA)); memset(sampleAccB, <span class="hljs-number"><span class="hljs-number">0</span></span>, sizeof(sampleAccB)); samplePos = <span class="hljs-number"><span class="hljs-number">0</span></span>; while (samplePos != SAMPLE_BUF_SIZE) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (DELTA_LOOP_TIME_MS) { sleep_mode(); } } portsUpdateStart(); // calculate FFT[<span class="hljs-number"><span class="hljs-number">10</span></span>] uint8_t signal = fft10(); // blowing detection <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (signal &gt; BLOWING_THRESHOLD) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!blowing) { // generate LEDs flickering values <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (uint8_t i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; LEDS_NUM; ++i) { ledsPeriod[i] = LEDS_PERIOD_MIN_MS + rand() % (LEDS_PERIOD_MAX_MS - LEDS_PERIOD_MIN_MS); ledsTTL[i] = (LEDS_TTL_MIN_MS + rand() % (LEDS_TTL_MAX_MS - LEDS_TTL_MIN_MS)) &gt;&gt; <span class="hljs-number"><span class="hljs-number">3</span></span>; ledsPhase[i] = rand() % ledsPeriod[i]; } } blowing = !setupPhase; lastBlowingTime = <span class="hljs-built_in"><span class="hljs-built_in">time</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (blowing &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">time</span></span> - lastBlowingTime &gt; PROLONG_BLOWING_MS) { blowing = false; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (blowing) { totalBlowingTime += loopDeltaTime; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (totalBlowingTime &gt;= DELAY_BLOWING_MS) { // prolong startup <span class="hljs-built_in"><span class="hljs-built_in">time</span></span> until noise stabilizes <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (setupPhase) { setupPhaseTime += SETUP_TIME_MS; } // update LEDs state <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (uint8_t i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; LEDS_NUM; ++i) { uint8_t level = ((<span class="hljs-built_in"><span class="hljs-built_in">time</span></span> + ledsPhase[i]) % ledsPeriod[i] &lt; (ledsPeriod[i] &gt;&gt; <span class="hljs-number"><span class="hljs-number">1</span></span>)) ? LOW : HIGH; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (signal &lt;= BLOWING_THRESHOLD) { level = !level; } writeLed(i, level); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!setupPhase &amp;&amp; totalBlowingTime &gt; (ledsTTL[i] &lt;&lt; <span class="hljs-number"><span class="hljs-number">3</span></span>)) { bitClear(ledsActivity, i); } } } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { totalBlowingTime = max(<span class="hljs-number"><span class="hljs-number">0</span></span>, totalBlowingTime - loopDeltaTime); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (totalBlowingTime &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) totalBlowingTime = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (uint8_t i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; LEDS_NUM; ++i) { writeLed(i, HIGH); } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (setupPhase) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">time</span></span> &gt;= <span class="hljs-number"><span class="hljs-number">1500</span></span>) { // show busy state int lowLed = (<span class="hljs-built_in"><span class="hljs-built_in">time</span></span> &gt;&gt; <span class="hljs-number"><span class="hljs-number">6</span></span>) % LEDS_NUM; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (uint8_t i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; LEDS_NUM; ++i) { writeLed(i, (i == lowLed) ? LOW : HIGH); } } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { const bool DEBUG_MODE = false; // trace debug value using LEDs const bool INVERT_LEVELS = true; // LOW level means <span class="hljs-number"><span class="hljs-number">1</span></span>, HIGH level means <span class="hljs-number"><span class="hljs-number">0</span></span> const bool MEASURE_TIME = false; // measure <span class="hljs-built_in"><span class="hljs-built_in">time</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> ms (minus offset, see code) const bool SHOW_ORDER = false; // show value as binary order <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (DEBUG_MODE) { int value = signal; // value to show <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (MEASURE_TIME) { static uint32_t totalLoopTime = <span class="hljs-number"><span class="hljs-number">0</span></span>; static uint32_t loopCtr = <span class="hljs-number"><span class="hljs-number">0</span></span>; totalLoopTime += loopDeltaTime; ++loopCtr; // <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> <span class="hljs-built_in"><span class="hljs-built_in">time</span></span> offset here value = totalLoopTime / loopCtr - <span class="hljs-number"><span class="hljs-number">10</span></span>; } int dbgValue = value; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (SHOW_ORDER) { dbgValue = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (; value &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>; ++dbgValue, value &gt;&gt;= <span class="hljs-number"><span class="hljs-number">1</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (uint8_t i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; LEDS_NUM; ++i) { bitSet(ledsActivity, i); writeLed(i, (dbgValue &gt; i) ? (INVERT_LEVELS ? LOW : HIGH) : (INVERT_LEVELS ? HIGH : LOW)); } // the last LED shows blowing state writeLed(LEDS_NUM - <span class="hljs-number"><span class="hljs-number">1</span></span>, blowing ? HIGH : LOW); } } portsUpdateFinish(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ledsActivity == <span class="hljs-number"><span class="hljs-number">0</span></span> || <span class="hljs-built_in"><span class="hljs-built_in">time</span></span> - lastBlowingTime &gt; NO_ACTIVITY_MS || <span class="hljs-built_in"><span class="hljs-built_in">time</span></span> &gt; TIME_LIMIT_MS) { powerDown(); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (DELTA_LOOP_TIME_MS) { globalTime += DELTA_LOOP_TIME_MS; } lastLoopTime = <span class="hljs-built_in"><span class="hljs-built_in">time</span></span>; } /////////////////////////////////////////////////////////////////////////////////////////////////</code>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
     </pre> </div></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     コントローラーをプログラムするには、 <b>USBTiny</b>などの<b>ICSPプログラマー</b>またはプログラマーとしてプログラムされた<b>Arduino</b>ボードが必要です（ <i>「Arduino as a Programmer」を</i>参照してください）。 このプログラムは<b>Arduino IDE</b>から直接ダウンロードできますが、その前に、 <b>ATTiny</b>用の特別なライブラリをインストールし、コントローラーとして<b>ATTiny44 8MHz</b>を選択する必要があります。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h1> 参照資料 </h1>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <a href="http://bitcake.eu/">http://bitcake.eu-</a>このプロジェクト専用のサイト（英語） </div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../J243487/index.html">chkrootkit脆弱性スキャナーのインストール、構成、使用</a></li>
<li><a href="../J24349/index.html">WindowsでのSafari</a></li>
<li><a href="../J243493/index.html">Adora Chung（パート1）：製品と誠実さの曲線</a></li>
<li><a href="../J243495/index.html">NPMユニバース</a></li>
<li><a href="../J243497/index.html">古典的なコンピューターサイエンス</a></li>
<li><a href="../J2435/index.html">FeedBurnerはロシア語の広告チャネルを取得しました</a></li>
<li><a href="../J24350/index.html">開発者へのアプリケーションのライセンスに関するロシア連邦の法律の変更</a></li>
<li><a href="../J243501/index.html">LEGO NXTフレックスケーブルの修理</a></li>
<li><a href="../J243503/index.html">エクスプレスコース「プロジェクトプランニング」</a></li>
<li><a href="../J243505/index.html">Outlookの連絡先の誕生日と記念日カレンダー</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter70218013 = new Ya.Metrika({
                  id:70218013,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/70218013" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'G-FEDBM7F51Q', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Clever Geek | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <div class="company-info js-company-info" itemscope="" itemtype="http://schema.org/Organization">
      <span itemprop="name">Western Town Media (WTM)</span>
      <div itemprop="address" itemscope="" itemtype="http://schema.org/PostalAddress">
        <span itemprop="streetAddress">1968 Stoney Lonesome Road</span>
        <br>
        <span itemprop="postalCode">PA 18640</span>
        <span itemprop="addressLocality">Pittston, USA</span>
      </div>
      <span itemprop="telephone">570-362-1316</span>
    </div>
    <script type="application/ld+json">
      {
        "@context": "http://schema.org",
        "@type": "Organization",
        "address": {
          "@type": "PostalAddress",
          "addressLocality": "Pittston, USA",
          "postalCode": "PA 18640",
          "streetAddress": "1968 Stoney Lonesome Road"
        },
        "name": "Western Town Media (WTM)",
        "telephone": "570-362-1316"
      }
    </script>
  </div>
</footer>
  
</body>

</html>