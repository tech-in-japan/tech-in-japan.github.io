<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-FEDBM7F51Q"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-FEDBM7F51Q');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>💏 ⌛️ 👲🏿 （非）プロトスレッドのファン専用：1-Wireを操作するための高レベル機能 ♍️ 📑 ☝🏼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ベアメタル用のファームウェアを作成することが理解されています。 そうしないと、プロトスレッドを使用しても意味がありません。 マルチタスクはOSツールによって提供される必要があります。 また、入出力操作に関連する多少複雑なアルゴリズムを実装する必要があることも理解されています。 さて、そして、いつもの...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="sitemap" type="application/xml" href="/sitemap.xml"/>

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

  <script>document.write('<script src="https://pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://tech-in-japan.github.io/index.html"></a>
    <div class="page-header-text">Clever Geek Handbook</div>
  </header>
  <section class="page js-page"><h1>（非）プロトスレッドのファン専用：1-Wireを操作するための高レベル機能</h1><div class="post__text post__text-html js-mediator-article" id="post-content-body" data-io-article-url="https://habr.com/ru/post/326320/"> ベアメタル用のファームウェアを作成することが理解されています。 そうしないと、プロトスレッドを使用しても意味がありません。 マルチタスクはOSツールによって提供される必要があります。 また、入出力操作に関連する多少複雑なアルゴリズムを実装する必要があることも理解されています。 さて、そして、いつものように、マイクロコントローラーでは、RAMと消費電力を節約するための明らかな要件があります。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     例として、1-Wireバス上のデバイスを保守するタスクを考えます。 非同期プリミティブの実装については、以前の記事と<a href="https://habr.com/ru/post/326320/">こちら</a>で<a href="https://habr.com/ru/post/326320/">ご覧いただけます</a> 。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      PnP実装の場合、プログラムは、最大許容交換レート、現在接続されているデバイスの識別子のリスト、電源の状態など、バスの特性を独立して決定できる必要があります。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     その後、可能な限り迅速に高速デバイスと通信するために、最大許容為替レートを定義します。 同時に、低速のデバイスはこの交換によって「認識」されず、当社に干渉しません。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     測定を実行する（またはEEPROMをプログラミングする）コマンドを発行した後、（必要に応じて）アクティブプルアップモードを有効にするには、電源の状態を知る必要があります。 そうしないと、寄生電力を使用すると、測定結果を読み取ろうとするときにエラーが発生します（おそらく、低インピーダンスのプルアップ抵抗を配置する必要がありますが、これはおそらく美しい解決策ではありません）。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     さて、現在接続されているデバイスの識別子のリストは、私たちにとって非常に重要です。 それ以外の場合、どのように対処しますか？ 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="probe"></a> バスの特性を決定するアルゴリズム： 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ol><li>  OVERDRIVEモードでRESET手順を実行してみましょう。  PRESENCEが検出された場合、接続されたデバイスの少なくとも一部は高速で動作できます。 この場合、手順3に進みます。 </li><li> 通常モードでRESETプロシージャを実行してみましょう。  PRESENCEが検出された場合、1-Wireバス上に少なくとも1つの接続されたデバイスがあり、ステップ3に進みます。 それ以外の場合、現在バスに接続されているデバイスはありません。 </li><li>  「すべてのデバイスのアドレス指定」コマンドをバスに送信してから、「電力条件の読み取り」コマンドを送信します。 接続されたデバイスの少なくとも1つが寄生電力モードを使用している場合、 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     対応するフラグを設定します。 </li></ol>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     しかし、接続されたデバイスの識別子を決定するアルゴリズムは非常に面倒です。 同期実装は<a href="https://habr.com/ru/post/326320/">アプリケーションノート187</a>に記載されていますが、非同期に作り直しただけです。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     アルゴリズムの実行のすべての段階で、1-Wireバス上の干渉の出現により発生する可能性のあるエラーを監視することが望ましいです。 エラーの発生ポイントに応じて、進行中の操作を自動的に繰り返すか、否定的な完了ステータスを返すことができます。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     さらに、読者は<a href="https://habr.com/ru/post/326320/">プロトスレッド</a>に関する最小限の知識しか持っていないことが想定されています。 英語のテキストを理解するのが難しいと思う人は誰でも、最初に<a href="https://habr.com/ru/post/326320/">ここ</a>と<a href="https://habr.com/ru/post/326320/">ここを</a>読むことができ<a href="https://habr.com/ru/post/326320/">ます</a> 。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     スポイラーの下には、バスパラメータを決定し、メインプログラムから接続されたデバイスを検出するためのプロシージャを呼び出す例があります。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div class="spoiler">  <b class="spoiler_title">主なプログラム</b> <div class="spoiler_text"><pre><code class="hljs swift"><span class="hljs-type"><span class="hljs-type">PT_INIT</span></span>(&amp;ptSearchContext.pt); <span class="hljs-comment"><span class="hljs-comment">/*          */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(<span class="hljs-type"><span class="hljs-type">PT_SCHEDULE</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">c</span></span> = ptOneWireProbeBus(&amp;ptSearchContext.pt, &amp;nested))) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-type"><span class="hljs-type">PT_WAITING</span></span> == <span class="hljs-built_in"><span class="hljs-built_in">c</span></span>) { <span class="hljs-comment"><span class="hljs-comment">/*    ,   -  */</span></span> waitComplete(); <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; } } <span class="hljs-comment"><span class="hljs-comment">/*      */</span></span> ptOneWireInitWalkROM(&amp;ptSearchContext); <span class="hljs-comment"><span class="hljs-comment">/*      1-Wire  */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(<span class="hljs-type"><span class="hljs-type">PT_SCHEDULE</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">c</span></span> = ptOneWireWalkROM(&amp;ptSearchContext))) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-type"><span class="hljs-type">PT_WAITING</span></span> == <span class="hljs-built_in"><span class="hljs-built_in">c</span></span>) { <span class="hljs-comment"><span class="hljs-comment">/*    ,   -  */</span></span> waitComplete(); <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; } <span class="hljs-comment"><span class="hljs-comment">/*   1-Wire   . *  S/N    ptSearchContext.romid */</span></span> __no_operation(); } <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> __no_operation();</code>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
     </pre> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    </div></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     これはデモです。 実際のプログラムでは、waitComplete（）関数を呼び出す代わりに、他のプロトスレッドのサービスに切り替えることができます（そうでない場合は、低電力モードに入ります）。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div class="spoiler">  <b class="spoiler_title">実装で使用されるマクロ</b> <div class="spoiler_text"><pre> <code class="hljs cs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> OVERDRIVE() \ drv_onewire_context.overdrive #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> PRESENCE_DETECTED() \ drv_onewire_context.presence #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> PARASITE_POWER \ drv_onewire_context.parasite #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> STATUS \ drv_onewire_context.status #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> PT_WAIT_IO_COMPLETE() \ PT_WAIT_WHILE(TASK_CONTEXT, ONEWIRE_STATUS_PROGRESS == (dummy = drvOneWireStatus())) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> IO_SUCCESS() \ (ONEWIRE_STATUS_COMPLETE == dummy) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> PT_TX_BITS(_v,_n) do { \ </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta">(drvOneWireTxBits((_v),(_n))) { \ PT_WAIT_IO_COMPLETE(); } </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> { \ dummy = ONEWIRE_STATUS_ERROR; } } while(0) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> PT_TX_BYTE(_v) \ PT_TX_BITS((_v), 8) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> PT_RX_BITS(_n) \ PT_TX_BITS(~0,(_n)) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> PT_TX_BYTE_CONST(_v) do { \ PT_TX_BYTE((_v)); \ </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta">(!IO_SUCCESS() || ((_v) != drvOneWireRxBits(8))) { \ STATUS = ONEWIRE_STATUS_ERROR; } } while(0)</span></span></code>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
     </pre>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    </div></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     短い説明： 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      PT_WAIT_IO_COMPLETE（） 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      I / O操作が完了するのを待っています。 プロトスレッド内でのみ使用するように設計されています。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      PT_TX_BITS（_v、_n） 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      _vの値から_nビットをバスに転送し、I / O操作が完了するのを待ちます。 プロトスレッド内でのみ使用するように設計されています。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      PT_TX_BYTE（_v） 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      _vバイトをバスに転送して、I / O操作が完了するのを待ちます。 プロトスレッド内でのみ使用するように設計されています。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      PT_RX_BITS（_n） 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      I / O操作が完了するまで待機する_nビットを受信します。 プロトスレッド内でのみ使用するように設計されています。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      PT_TX_BYTE_CONST（_v） 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     コマンドバイト（定数）をバスに送信し、送信データの歪みをチェックし、I / O操作の完了を待ちます。 プロトスレッド内でのみ使用するように設計されています。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     この場合の「入力入力の完了を待機する」とは、何らかの条件のチェックを伴う鈍いサイクルではなく、ステータスPT_WAITINGの現在のプロトスレッドの中断を意味することに注意してください。 これにより、アクティブ化されたI / O操作が終了するまで電流を定期的にチェックして、他のプロトスレッドを実行できます。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div class="spoiler">  <b class="spoiler_title">すべてのデバイスのアドレス指定コマンドの送信</b> <div class="spoiler_text"><pre> <code class="hljs swift"><span class="hljs-type"><span class="hljs-type">PT_THREAD</span></span>(ptOneWireTargetAll(<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">pt</span></span></span><span class="hljs-class"> * </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_pt</span></span></span><span class="hljs-class">)) </span></span>{ uint8_t dummy; <span class="hljs-type"><span class="hljs-type">PT_BEGIN</span></span>(<span class="hljs-type"><span class="hljs-type">TASK_CONTEXT</span></span>); <span class="hljs-type"><span class="hljs-type">PT_TX_BYTE_CONST</span></span>(<span class="hljs-type"><span class="hljs-type">OP_SKIP_ROM</span></span>); <span class="hljs-type"><span class="hljs-type">PT_END</span></span>(<span class="hljs-type"><span class="hljs-type">TASK_CONTEXT</span></span>); }</code>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
     </pre>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    </div></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     すべてのデバイスをアドレス指定する操作は、1-Wireバスの他のコマンドで使用できるため、独立したプロトスレッドとしてフレーム化されました。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div class="spoiler">  <b class="spoiler_title">タイヤ定義手順</b> <div class="spoiler_text"><pre> <code class="hljs cs">PT_THREAD(ptOneWireProbeBus(<span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> pt * _pt, <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> pt * _nested)) { uint8_t dummy; PT_BEGIN(TASK_CONTEXT); <span class="hljs-comment"><span class="hljs-comment">/* Parasite power not detected */</span></span> PARASITE_POWER = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-comment"><span class="hljs-comment">/* Try overdrive procedure first */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(drvOneWireReset(<span class="hljs-number"><span class="hljs-number">1</span></span>)) { PT_WAIT_IO_COMPLETE(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!IO_SUCCESS() || !PRESENCE_DETECTED()) { <span class="hljs-comment"><span class="hljs-comment">/* Overdrive RESET procedure failed */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(drvOneWireReset(<span class="hljs-number"><span class="hljs-number">0</span></span>)) { PT_WAIT_IO_COMPLETE(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!IO_SUCCESS() || !PRESENCE_DETECTED()) { <span class="hljs-comment"><span class="hljs-comment">/* No devices on the bus */</span></span> PT_EXIT(TASK_CONTEXT); } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-comment"><span class="hljs-comment">/* Hardware BUSY */</span></span> PT_EXIT(TASK_CONTEXT); } } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-comment"><span class="hljs-comment">/* Hardware BUSY */</span></span> PT_EXIT(TASK_CONTEXT); } PT_SPAWN(TASK_CONTEXT, _nested, ptOneWireTargetAll(_nested)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(ONEWIRE_STATUS_COMPLETE == STATUS) { PT_TX_BYTE_CONST(OP_READ_POWER_SUPPLY); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(IO_SUCCESS()) { <span class="hljs-comment"><span class="hljs-comment">/* Read one bit after command */</span></span> PT_RX_BITS(<span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(IO_SUCCESS()) { <span class="hljs-comment"><span class="hljs-comment">/* Fetch bit value */</span></span> int16_t <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = drvOneWireRxBits(<span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">value</span></span> &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-comment"><span class="hljs-comment">/* Rx bit decode failed */</span></span> STATUS = ONEWIRE_STATUS_ERROR; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-comment"><span class="hljs-comment">/* If any device sent "0" then it used parasite power */</span></span> PARASITE_POWER = <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> ? <span class="hljs-number"><span class="hljs-number">0</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span>; } } } } PT_END(TASK_CONTEXT); }</code>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
     </pre>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    </div></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     コードは非常にシンプルで、上記の<a href="https://habr.com/ru/post/326320/">アルゴリズム</a>を実装してい<a href="https://habr.com/ru/post/326320/">ます</a> 。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div class="spoiler">  <b class="spoiler_title">接続されたデバイスの識別子を決定する手順</b> <div class="spoiler_text"><pre> <code class="hljs pgsql">PT_THREAD(ptOneWireWalkROM(pt_onewire_search_context_t * _ctx)) { PT_BEGIN(TASK_CONTEXT); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(!LAST_DEVICE_FLAG) { int16_t dummy; <span class="hljs-comment"><span class="hljs-comment">/* initialize for search */</span></span> ID_BIT_NUMBER = <span class="hljs-number"><span class="hljs-number">1</span></span>; LAST_ZERO = <span class="hljs-number"><span class="hljs-number">0</span></span>; ROM_BYTE_NUMBER = <span class="hljs-number"><span class="hljs-number">0</span></span>; ROM_BYTE_MASK = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-comment"><span class="hljs-comment">/* 1-Wire reset (dependent on OVERDRIVE flag) */</span></span> PT_ONEWIRE_RESET(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!IO_SUCCESS() || !PRESENCE_DETECTED()) { // <span class="hljs-keyword"><span class="hljs-keyword">reset</span></span> the <span class="hljs-keyword"><span class="hljs-keyword">search</span></span> LAST_DISCREPANCY = <span class="hljs-number"><span class="hljs-number">0</span></span>; LAST_DEVICE_FLAG = <span class="hljs-number"><span class="hljs-number">0</span></span>; LAST_FAMILY_DISCREPANCY = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-comment"><span class="hljs-comment">/* If presence not detected then no devices on the bus */</span></span> PT_EXIT(TASK_CONTEXT); } <span class="hljs-comment"><span class="hljs-comment">/* issue the search command */</span></span> PT_TX_BYTE(OP_SEARCH_ROM); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!IO_SUCCESS() || (OP_SEARCH_ROM != drvOneWireRxBits(<span class="hljs-number"><span class="hljs-number">8</span></span>))) { <span class="hljs-comment"><span class="hljs-comment">/* Send command error, repeat procedure from RESET point */</span></span> <span class="hljs-comment"><span class="hljs-comment">/* Other solution is abort search procedure */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; } // <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> the <span class="hljs-keyword"><span class="hljs-keyword">search</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { // <span class="hljs-keyword"><span class="hljs-keyword">read</span></span> a <span class="hljs-type"><span class="hljs-type">bit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> its complement PT_RX_BITS(<span class="hljs-number"><span class="hljs-number">2</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!IO_SUCCESS()) { <span class="hljs-comment"><span class="hljs-comment">/* Error while receiving 2 bits. * As ID_BIT_NUMBER less than 65 search procedure * resumed from state such as original task entry. */</span></span> break; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>((RX_VALUE = drvOneWireRxBits(<span class="hljs-number"><span class="hljs-number">2</span></span>)) &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { __no_operation(); break; } uint8_t id_bit = (RX_VALUE &amp; <span class="hljs-number"><span class="hljs-number">0x01</span></span>) ? <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">0</span></span>; uint8_t cmp_id_bit = (RX_VALUE &amp; <span class="hljs-number"><span class="hljs-number">0x02</span></span>) ? <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">0</span></span>; uint8_t search_direction; <span class="hljs-comment"><span class="hljs-comment">/* check for no devices on 1-wire */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((id_bit == <span class="hljs-number"><span class="hljs-number">1</span></span>) &amp;&amp; (cmp_id_bit == <span class="hljs-number"><span class="hljs-number">1</span></span>)) { <span class="hljs-comment"><span class="hljs-comment">/* Same bit values equ "1" indicate no devices on the bus */</span></span> break; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-comment"><span class="hljs-comment">/* all devices coupled have 0 or 1 */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (id_bit != cmp_id_bit) { search_direction = id_bit; <span class="hljs-comment"><span class="hljs-comment">/* bit write value for search */</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-comment"><span class="hljs-comment">/* if this discrepancy if before the LAST_DISCREPANCY on a previous next then pick the same as last time */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ID_BIT_NUMBER &lt; LAST_DISCREPANCY) { search_direction = (ROMID_BYTE_REF(ROM_BYTE_NUMBER) &amp; ROM_BYTE_MASK) ? <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-comment"><span class="hljs-comment">/* if equal to last pick 1, if not then pick 0 */</span></span> search_direction = (ID_BIT_NUMBER == LAST_DISCREPANCY) ? <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-comment"><span class="hljs-comment">/* if 0 was picked then record its position in LAST_ZERO */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (search_direction == <span class="hljs-number"><span class="hljs-number">0</span></span>) { LAST_ZERO = ID_BIT_NUMBER; } <span class="hljs-comment"><span class="hljs-comment">/* check for LAST_FAMILY_DISCREPANCY in family */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (LAST_ZERO &lt; <span class="hljs-number"><span class="hljs-number">9</span></span>) { LAST_FAMILY_DISCREPANCY = LAST_ZERO; } } } <span class="hljs-comment"><span class="hljs-comment">/* set or clear the bit in the ROM byte ROM_BYTE_NUMBER with mask rom_byte_mask */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (search_direction == <span class="hljs-number"><span class="hljs-number">1</span></span>) { ROMID_BYTE_REF(ROM_BYTE_NUMBER) |= ROM_BYTE_MASK; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { ROMID_BYTE_REF(ROM_BYTE_NUMBER) &amp;= ~ROM_BYTE_MASK; } <span class="hljs-comment"><span class="hljs-comment">/* serial number search direction write bit */</span></span> PT_TX_BITS(search_direction, <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-comment"><span class="hljs-comment">/* search_direction not stored, therefore we can't check echo */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!IO_SUCCESS()) { <span class="hljs-comment"><span class="hljs-comment">/* Sending direction failed. * As ID_BIT_NUMBER less than 65 search procedure * resumed from state such as original task entry. */</span></span> break; } <span class="hljs-comment"><span class="hljs-comment">/* increment the byte counter ID_BIT_NUMBER and shift the mask rom_byte_mask */</span></span> ID_BIT_NUMBER++; ROM_BYTE_MASK &lt;&lt;= <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-comment"><span class="hljs-comment">/* if the mask is 0 then go to new SerialNum byte ROM_BYTE_NUMBER and reset mask */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ROM_BYTE_MASK == <span class="hljs-number"><span class="hljs-number">0</span></span>) { ROM_BYTE_NUMBER++; ROM_BYTE_MASK = <span class="hljs-number"><span class="hljs-number">1</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(ROM_BYTE_NUMBER &lt; <span class="hljs-number"><span class="hljs-number">8</span></span>); <span class="hljs-comment"><span class="hljs-comment">/* loop until through all ROM bytes 0-7 */</span></span> <span class="hljs-comment"><span class="hljs-comment">/* if the search was successful then */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!(ID_BIT_NUMBER &lt; <span class="hljs-number"><span class="hljs-number">65</span></span>)) { uint8_t i; <span class="hljs-comment"><span class="hljs-comment">/* Calculate CRC */</span></span> uint8_t crc = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(i = <span class="hljs-number"><span class="hljs-number">0</span></span>;i &lt; sizeof(ROMID);i++) { crc = modOneWireUpdateCRC(crc, ROMID_BYTE_REF(i)); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(crc) { <span class="hljs-comment"><span class="hljs-comment">/* CRC error. * Repeat procedure from original point */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; } <span class="hljs-comment"><span class="hljs-comment">/* search successful so set LAST_DISCREPANCY and LAST_DEVICE_FLAG */</span></span> LAST_DISCREPANCY = LAST_ZERO; // <span class="hljs-keyword"><span class="hljs-keyword">check</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> last device <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (LAST_DISCREPANCY == <span class="hljs-number"><span class="hljs-number">0</span></span>) { LAST_DEVICE_FLAG = <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-comment"><span class="hljs-comment">/* Next device detection complete */</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-comment"><span class="hljs-comment">/* I/O error. * Retry procedure from original point */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!ROMID.id.familyCode) { <span class="hljs-comment"><span class="hljs-comment">/* familyCode     0! */</span></span> break; } <span class="hljs-comment"><span class="hljs-comment">/* Return detected device S/N */</span></span> PT_YIELD(TASK_CONTEXT); } <span class="hljs-comment"><span class="hljs-comment">/* Reset state for next scan loop (if need) */</span></span> ptOneWireInitWalkROM(CONTEXT); PT_END(TASK_CONTEXT); } <span class="hljs-comment"><span class="hljs-comment">/* * Initialize device search procedure */</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> ptOneWireInitWalkROM(pt_onewire_search_context_t * _ctx) { <span class="hljs-comment"><span class="hljs-comment">/* Prepare ptOneWireWalkROM() for first call */</span></span> LAST_DISCREPANCY = <span class="hljs-number"><span class="hljs-number">0</span></span>; LAST_DEVICE_FLAG = <span class="hljs-number"><span class="hljs-number">0</span></span>; LAST_FAMILY_DISCREPANCY = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-comment"><span class="hljs-comment">/* Initialize protothreads data */</span></span> PT_INIT(TASK_CONTEXT); }</code>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
     </pre>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    </div></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <a href="https://habr.com/ru/post/326320/">マキシム</a>から同期実装を取得し、I / Oルーチンを非同期マクロに置き換えました。 このすべてと、実行中のテストケースには、約30分かかりました。 プロトスレッドラッパーを使用しないと、どれだけ混乱する必要があるのでしょうか。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      STM8L-Discoveryボードの完全なプロジェクトソースコードは<a href="https://habr.com/ru/post/326320/">github</a>で入手できます。 コンパイル時に上記の例を使用してアセンブリを作成するには、HIGH_LEVELシンボルを定義する必要があります。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     参照： 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ol><li><a name="code"></a>  <a href="https://github.com/vedga/1-wire">Githubプロジェクトコード</a> </li><li><a name="stm"></a>  <a href="https://habrahabr.ru/post/326114/">STM8LおよびSTM32用のPWMおよびICPを使用して1-Wireマスターを実装するためのプリミティブ</a> </li><li><a name="avr"></a>  <a href="https://habrahabr.ru/post/322710/">AVR AtMegaマイクロコントローラーでPWMおよびICPを使用して1-Wireマスターを実装するためのプリミティブ</a> </li><li><a name="dunkels"></a>  <a href="http://dunkels.com/adam/pt/index.html">アダムダンケルのプロトスレッド</a> </li><li><a name="continuation"></a>  <a href="https://habrahabr.ru/post/143318/">連続性ベースのマイクロコントローラーでの</a> <a href="https://habrahabr.ru/users/ldir/" class="user_link">ldir</a> <a href="https://habrahabr.ru/post/143318/">マルチタスク</a>からの<a href="https://habrahabr.ru/users/ldir/" class="user_link">HDR</a> </li><li><a name="multitask"></a>  <a href="https://habrahabr.ru/users/lifev/" class="user_link">LifeV</a> <a href="https://habrahabr.ru/company/embox/blog/244361/">Protothread Habrと協調マルチタスク</a> </li><li><a name="apn_187"></a>  <a href="https://www.maximintegrated.com/en/app-notes/index.mvp/id/187">アプリケーションノート187。1-Wire検索アルゴリズム</a> </li></ol></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../J326288/index.html">サンドボックステクノロジー チェックポイントSandBlast。 パート3</a></li>
<li><a href="../J326292/index.html">仕組み：SSL / TLSの紹介</a></li>
<li><a href="../J3263/index.html">ハブラトピキと時間。</a></li>
<li><a href="../J326308/index.html">GoogleはTPUの技術データと任命を発表しました</a></li>
<li><a href="../J326312/index.html">vk.comのチャットボットを3分で書く方法</a></li>
<li><a href="../J326324/index.html">タイミング用のカスタムUI要素の実装。 パート1</a></li>
<li><a href="../J326328/index.html">Bashスクリプト、パート3：オプションとコマンドラインスイッチ</a></li>
<li><a href="../J326330/index.html">Web SCADAシステムの最初のステップ。 AngularJSを使用してブラウザーを活気づける</a></li>
<li><a href="../J326332/index.html">ロシアコードカップ2017の第1ラウンドの結果</a></li>
<li><a href="../J326334/index.html">意識の論理。 パート12.パターンを検索します。 組み合わせ空間</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter70218013 = new Ya.Metrika({
                  id:70218013,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/70218013" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'G-FEDBM7F51Q', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Clever Geek | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <div class="company-info js-company-info" itemscope="" itemtype="http://schema.org/Organization">
      <span itemprop="name">Western Town Media (WTM)</span>
      <div itemprop="address" itemscope="" itemtype="http://schema.org/PostalAddress">
        <span itemprop="streetAddress">1968 Stoney Lonesome Road</span>
        <br>
        <span itemprop="postalCode">PA 18640</span>
        <span itemprop="addressLocality">Pittston, USA</span>
      </div>
      <span itemprop="telephone">570-362-1316</span>
    </div>
    <script type="application/ld+json">
      {
        "@context": "http://schema.org",
        "@type": "Organization",
        "address": {
          "@type": "PostalAddress",
          "addressLocality": "Pittston, USA",
          "postalCode": "PA 18640",
          "streetAddress": "1968 Stoney Lonesome Road"
        },
        "name": "Western Town Media (WTM)",
        "telephone": "570-362-1316"
      }
    </script>
  </div>
</footer>
  
</body>

</html>