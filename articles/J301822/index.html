<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-FEDBM7F51Q"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-FEDBM7F51Q');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🧑🏾‍🤝‍🧑🏼 🔋 🥒 本番環境のWebsocket 🤽 ⛓️ 🚬</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="10ヶ月前、私はブラウザのおもちゃを作り始めました。 cocos jsはグラフィックスとして、websocketはサーバーとの通信として選択されました。 私はこのテクノロジーが本当に好きで、その上でサーバーとのゲームの通信をすべて整理しました。 このためにこの記事を使用しました。 しかし、残念ながら...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="sitemap" type="application/xml" href="/sitemap.xml"/>

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

  <script>document.write('<script src="https://pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://tech-in-japan.github.io/index.html"></a>
    <div class="page-header-text">Clever Geek Handbook</div>
  </header>
  <section class="page js-page"><h1>本番環境のWebsocket</h1><div class="post__text post__text-html js-mediator-article" id="post-content-body" data-io-article-url="https://habr.com/ru/post/301822/">  10ヶ月前、私はブラウザのおもちゃを作り始めました。  cocos jsはグラフィックスとして、websocketはサーバーとの通信として選択されました。 私はこのテクノロジーが本当に好きで、その上でサーバーとのゲームの通信をすべて整理しました。  <a href="https://habrahabr.ru/post/209864/">この</a>ために<a href="https://habrahabr.ru/post/209864/">この記事</a>を使用しました。 しかし、残念ながら、その記事に記載されているコードは実稼働では使用できません。 判明したように、問題のレベルは重大ではなく、ブロックされています。 すべてが非常に悪いので、サーバーとのすべての通信をWebソケットからロングプールまで書き直す必要がありました。 最後に、「サファリではなくブラウザを使用している場合はwebsocketを使用し、それ以外の場合はロングポーリング」というオプションを残し、このトピックについてもう少し分岐します。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     そのため、実稼働環境でWebソケットを使用した経験はまともなものになりました。 そして最近、ハブレに関する最初の記事を書くように促したイベントが起こりました。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     おもちゃがソーシャルネットワークに公開された後、見つかったすべてのクリティカル/ブロッキングバグを修正し、すべてを静かなモードで整理し始めました。  <a href="https://habrahabr.ru/post/209864/">この例</a>は、一般的に、コードに挿入して使用できるサーバーコードを含むインターネット上の唯一のガイドであるという事実に注目したいと思います。 さて、検索エンジンで「php websocket server」と入力します-自分でインストールできるものを見つけてください。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     突然、私は上記の<a href="https://habrahabr.ru/post/209864/">記事を</a>読み直し、最初に「phpdaemon」と「ratchet」へのリンクを見つけました。 それでは、冷静にコードを見てみましょう。  PhpDeamonでは、WebSocket接続処理の腸内で、WebSocketプロトコルへの小さなしかし非常に重要な分岐があります。 また、1つのケースで「Safari5と多くの非ブラウザークライアント」と表示されます。 私がおかしくなりそうだと言うことは、何も言わないことです。 私の目の前で数百時間のフラッシュが発生し、多くの手間と苦しみがあり、プロジェクト全体に疑問を投げかけました。 信じられなかったので、確認することにしました。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      〜15時間以内に、PhpDeamonからWebSocketに関連する最小限のコードを引き出しました（最新バージョンのすべてのブラウザーで動作し、サーバーコード自体は高負荷でも動作します）。説明付きで公開しようと思います。 他の人が私が経験しなければならない苦痛を経験しないように。 はい、コードは小さくありませんでしたが、申し訳ありません。WebSocketはクライアント側では非常にシンプルであり、サーバー側ではすべてが非常に大きくなります（Safari開発者に別の「ありがとう」としましょう）。 また、WebSocketのスコープは主にゲームであるという事実により、サーバーソケットのノンブロッキング使用の問題が重要です-これはボーナスの複雑さであり、非常に重要ですが、 <a href="https://habrahabr.ru/post/209864/">ここ</a>では決して考慮しません。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     より理解しやすいように、オブジェクトのないテストアプリケーションを作成したかったのです。 しかし、残念ながら、この例のこのアプローチでは多くの繰り返しコードが生成されるため、1つのクラスと3つの継承者を追加する必要がありました。 残りはすべてオブジェクトなしです。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div class="spoiler">  <b class="spoiler_title">まず、クライアント部分</b> <div class="spoiler_text"><pre><code class="html hljs xml"><span class="hljs-meta"><span class="hljs-meta">&lt;!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://www.w3.org/1999/xhtml"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">meta</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">http-equiv</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Content-Type"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">content</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/html; charset=utf-8"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">title</span></span></span><span class="hljs-tag">&gt;</span></span>WebSocket test page<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">title</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">onload</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"create();"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/javascript"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="actionscript"><span class="actionscript"> </span><span class="hljs-function"><span class="hljs-keyword"><span class="actionscript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="actionscript"><span class="hljs-function"> </span></span><span class="hljs-title"><span class="actionscript"><span class="hljs-function"><span class="hljs-title">create</span></span></span></span><span class="hljs-params"><span class="actionscript"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span><span class="actionscript"><span class="hljs-function"> </span></span></span><span class="actionscript">{ </span><span class="hljs-comment"><span class="actionscript"><span class="hljs-comment">// Example ws = new WebSocket('ws://'+document.domain+':8081/'); ws.onopen = function () {document.getElementById('log').innerHTML += 'WebSocket opened &lt;br/&gt;';} ws.onmessage = function (e) {document.getElementById('log').innerHTML += 'WebSocket message: '+e.data+' &lt;br/&gt;';} ws.onclose = function () {document.getElementById('log').innerHTML += 'WebSocket closed &lt;br/&gt;';} } </span></span></span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">onclick</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"create();"</span></span></span><span class="hljs-tag">&gt;</span></span>Create WebSocket<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">onclick</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"ws.send('ping');"</span></span></span><span class="hljs-tag">&gt;</span></span>Send ping<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">onclick</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"ws.close();"</span></span></span><span class="hljs-tag">&gt;</span></span>Close WebSocket<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"log"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">style</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"width:300px; height: 300px; border: 1px solid #999999; overflow:auto;"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span></code>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
     </pre> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    </div></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     私のゲームでは、3つのサーバーソケットを使用する必要がありました。  WebSocket、ワーカー用、およびロングプール用。 ゲームにはたくさんの数学がありますので、私たちはワーカーをして、コンピューティングのためのタスクを与えなければなりませんでした。 それが目的です。 そのstream_selectは、それらすべてに共通である必要があります。そうでないと、遅延や狂ったプロセッサー使用が発生します。 この知識は、使用済みの神経の山と引き換えに得られました。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div class="spoiler">  <b class="spoiler_title">メインサービスサイクル</b> <div class="spoiler_text"><pre> <code class="php hljs">$master = stream_socket_server(<span class="hljs-string"><span class="hljs-string">"tcp://127.0.0.1:8081"</span></span>, $errno, $errstr); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!$master) <span class="hljs-keyword"><span class="hljs-keyword">die</span></span>(<span class="hljs-string"><span class="hljs-string">"$errstr ($errno)\n"</span></span>); $sockets = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>($master); stream_set_blocking($master, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); <span class="hljs-comment"><span class="hljs-comment">//      ,         ,     "stream_socket_accept". ,         - ,      -  . while (true) { $read = $sockets; $write = $except = array(); if (($num_changed_streams = stream_select($read, $write, $except, 0, 1000000)) === false) { var_dump('stream_select error'); break; //    ,   "die",                "/etc/init.d/game restart"  100%   case,     "pcntl"       . } foreach ($read as $socket) { $index_socket = array_search($socket, $sockets); if ($index_socket == 0) { //   continue; } //      } }</span></span></code>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
     </pre>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    </div></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     新しいクライアントとの接続は非常に標準的なコードですが、ソケットが非ブロックモードであるという事実により、すべての着信データを断片的に収集し、十分なデータがある場合にそれを処理し、必要なプロトコルを理解するコードの束を記述する必要がありますこのプロトコルを使用するには、使用して切り替えます。 この1つのタスクはすでに大量のコードであり、PhpDeamonではWebSocketとは関係のないコードを大量に積みました（8つの異なるサーバーをそこに上げることもできます）。 このトピックでは、多くの部分を切り離して単純化することができました。 彼はWebSocketに関連するものだけを残しました。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div class="spoiler">  <b class="spoiler_title">切り捨てられたファイル&lt;ws.php&gt;</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ws</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> MAX_BUFFER_SIZE = <span class="hljs-number"><span class="hljs-number">1024</span></span> * <span class="hljs-number"><span class="hljs-number">1024</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $socket; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> array _SERVER */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> $server = []; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $headers = []; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $closed = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $unparsed_data = <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $current_header; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $unread_lines = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $extensions = []; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $extensionsCleanRegex = <span class="hljs-string"><span class="hljs-string">'/(?:^|\W)x-webkit-/iS'</span></span>; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> integer Current state */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $state = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-comment"><span class="hljs-comment">// stream state of the connection (application protocol level) /** * Alias of STATE_STANDBY */ const STATE_ROOT = 0; /** * Standby state (default state) */ const STATE_STANDBY = 0; /** * State: first line */ const STATE_FIRSTLINE = 1; /** * State: headers */ const STATE_HEADERS = 2; /** * State: content */ const STATE_CONTENT = 3; /** * State: prehandshake */ const STATE_PREHANDSHAKE = 5; /** * State: handshaked */ const STATE_HANDSHAKED = 6; public function get_state() { return $this-&gt;state; } public function closed() { return $this-&gt;closed; } protected function close() { if ($this-&gt;closed) return; var_dump('self close'); fclose($this-&gt;socket); $this-&gt;closed = true; } public function __construct($socket) { stream_set_blocking($socket, false); $this-&gt;socket = $socket; } private function read_line() { $lines = explode(PHP_EOL, $this-&gt;unparsed_data); $last_line = $lines[count($lines)-1]; unset($lines[count($lines) - 1]); foreach ($lines as $line) { $this-&gt;unread_lines[] = $line; } $this-&gt;unparsed_data = $last_line; if (count($this-&gt;unread_lines) != 0) { return array_shift($this-&gt;unread_lines); } else { return null; } } public function on_receive_data() { if ($this-&gt;closed) return; $data = stream_socket_recvfrom($this-&gt;socket, MAX_BUFFER_SIZE); if (is_string($data)) { $this-&gt;unparsed_data .= $data; } } /** * Called when new data received. * @return void */ public function on_read() { if ($this-&gt;closed) return; if ($this-&gt;state === self::STATE_STANDBY) { $this-&gt;state = self::STATE_FIRSTLINE; } if ($this-&gt;state === self::STATE_FIRSTLINE) { if (!$this-&gt;http_read_first_line()) { return; } $this-&gt;state = self::STATE_HEADERS; } if ($this-&gt;state === self::STATE_HEADERS) { if (!$this-&gt;http_read_headers()) { return; } if (!$this-&gt;http_process_headers()) { $this-&gt;close(); return; } $this-&gt;state = self::STATE_CONTENT; } if ($this-&gt;state === self::STATE_CONTENT) { $this-&gt;state = self::STATE_PREHANDSHAKE; } } /** * Read first line of HTTP request * @return boolean|null Success */ protected function http_read_first_line() { if (($l = $this-&gt;read_line()) === null) { return null; } $e = explode(' ', $l); $u = isset($e[1]) ? parse_url($e[1]) : false; if ($u === false) { $this-&gt;bad_request(); return false; } if (!isset($u['path'])) { $u['path'] = null; } if (isset($u['host'])) { $this-&gt;server['HTTP_HOST'] = $u['host']; } $srv = &amp; $this-&gt;server; $srv['REQUEST_METHOD'] = $e[0]; $srv['REQUEST_TIME'] = time(); $srv['REQUEST_TIME_FLOAT'] = microtime(true); $srv['REQUEST_URI'] = $u['path'] . (isset($u['query']) ? '?' . $u['query'] : ''); $srv['DOCUMENT_URI'] = $u['path']; $srv['PHP_SELF'] = $u['path']; $srv['QUERY_STRING'] = isset($u['query']) ? $u['query'] : null; $srv['SCRIPT_NAME'] = $srv['DOCUMENT_URI'] = isset($u['path']) ? $u['path'] : '/'; $srv['SERVER_PROTOCOL'] = isset($e[2]) ? $e[2] : 'HTTP/1.1'; $srv['REMOTE_ADDR'] = null; $srv['REMOTE_PORT'] = null; return true; } /** * Read headers line-by-line * @return boolean|null Success */ protected function http_read_headers() { while (($l = $this-&gt;read_line()) !== null) { if ($l === '') { return true; } $e = explode(': ', $l); if (isset($e[1])) { $this-&gt;current_header = 'HTTP_' . strtoupper(strtr($e[0], ['-' =&gt; '_'])); $this-&gt;server[$this-&gt;current_header] = $e[1]; } elseif (($e[0][0] === "\t" || $e[0][0] === "\x20") &amp;&amp; $this-&gt;current_header) { // multiline header continued $this-&gt;server[$this-&gt;current_header] .= $e[0]; } else { // whatever client speaks is not HTTP anymore $this-&gt;bad_request(); return false; } } } /** * Process headers * @return bool */ protected function http_process_headers() { $this-&gt;state = self::STATE_PREHANDSHAKE; if (isset($this-&gt;server['HTTP_SEC_WEBSOCKET_EXTENSIONS'])) { $str = strtolower($this-&gt;server['HTTP_SEC_WEBSOCKET_EXTENSIONS']); $str = preg_replace($this-&gt;extensionsCleanRegex, '', $str); $this-&gt;extensions = explode(', ', $str); } if (!isset($this-&gt;server['HTTP_CONNECTION']) || (!preg_match('~(?:^|\W)Upgrade(?:\W|$)~i', $this-&gt;server['HTTP_CONNECTION'])) // "Upgrade" is not always alone (ie. "Connection: Keep-alive, Upgrade") || !isset($this-&gt;server['HTTP_UPGRADE']) || (strtolower($this-&gt;server['HTTP_UPGRADE']) !== 'websocket') // Lowercase comparison iss important ) { $this-&gt;close(); return false; } if (isset($this-&gt;server['HTTP_COOKIE'])) { self::parse_str(strtr($this-&gt;server['HTTP_COOKIE'], self::$hvaltr), $this-&gt;cookie); } if (isset($this-&gt;server['QUERY_STRING'])) { self::parse_str($this-&gt;server['QUERY_STRING'], $this-&gt;get); } // ---------------------------------------------------------- // Protocol discovery, based on HTTP headers... // ---------------------------------------------------------- if (isset($this-&gt;server['HTTP_SEC_WEBSOCKET_VERSION'])) { // HYBI if ($this-&gt;server['HTTP_SEC_WEBSOCKET_VERSION'] === '8') { // Version 8 (FF7, Chrome14) $this-&gt;switch_to_protocol('v13'); } elseif ($this-&gt;server['HTTP_SEC_WEBSOCKET_VERSION'] === '13') { // newest protocol $this-&gt;switch_to_protocol('v13'); } else { error_log(get_class($this) . '::' . __METHOD__ . " : Websocket protocol version " . $this-&gt;server['HTTP_SEC_WEBSOCKET_VERSION'] . ' is not yet supported for client "addr"'); // $this-&gt;addr $this-&gt;close(); return false; } } elseif (!isset($this-&gt;server['HTTP_SEC_WEBSOCKET_KEY1']) || !isset($this-&gt;server['HTTP_SEC_WEBSOCKET_KEY2'])) { $this-&gt;switch_to_protocol('ve'); } else { // Defaulting to HIXIE (Safari5 and many non-browser clients...) $this-&gt;switch_to_protocol('v0'); } // ---------------------------------------------------------- // End of protocol discovery // ---------------------------------------------------------- return true; } private function switch_to_protocol($protocol) { $class = 'ws_'.$protocol; $this-&gt;new_instance = new $class($this-&gt;socket); $this-&gt;new_instance-&gt;state = $this-&gt;state; $this-&gt;new_instance-&gt;unparsed_data = $this-&gt;unparsed_data; $this-&gt;new_instance-&gt;server = $this-&gt;server; } /** * Send Bad request * @return void */ public function bad_request() { $this-&gt;write("400 Bad Request\r\n\r\n&lt;html&gt;&lt;head&gt;&lt;title&gt;400 Bad Request&lt;/title&gt;&lt;/head&gt;&lt;body bgcolor=\"white\"&gt;&lt;center&gt;&lt;h1&gt;400 Bad Request&lt;/h1&gt;&lt;/center&gt;&lt;/body&gt;&lt;/html&gt;"); $this-&gt;close(); } /** * Replacement for default parse_str(), it supoorts UCS-2 like this: %uXXXX * @param string $s String to parse * @param array &amp;$var Reference to the resulting array * @param boolean $header Header-style string * @return void */ public static function parse_str($s, &amp;$var, $header = false) { static $cb; if ($cb === null) { $cb = function ($m) { return urlencode(html_entity_decode('&amp;#' . hexdec($m[1]) . ';', ENT_NOQUOTES, 'utf-8')); }; } if ($header) { $s = strtr($s, self::$hvaltr); } if ( (stripos($s, '%u') !== false) &amp;&amp; preg_match('~(%u[af\d]{4}|%[cf][af\d](?!%[89a-f][af\d]))~is', $s, $m) ) { $s = preg_replace_callback('~%(u[af\d]{4}|[af\d]{2})~i', $cb, $s); } parse_str($s, $var); } /** * Send data to the connection. Note that it just writes to buffer that flushes at every baseloop * @param string $data Data to send * @return boolean Success */ public function write($data) { if ($this-&gt;closed) return false; return stream_socket_sendto($this-&gt;socket, $data) == 0; } }</span></span></code>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
     </pre>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    </div></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     このような切り捨てられた形式でのこのクラスの意味は、クライアントに接続するためにコンストラクターで非ブロックモードを設定することです。 次に、メインループで、データが到着するたびに、すぐに読み取り、「 <b>unparsed_data</b> 」変数に追加（追加）します（これは<b>on_receive_data</b>メソッドです）。  MAX_BUFFER_SIZEの次元を超えても、悪いことはまったく起こらないことを理解することが重要です。 最後の例では、ここで何が起こるか、その値を「5」と言って、すべてが引き続き機能することを確認できます。 単純に、最初のステップでバッファからのデータは無視されます-結局、それらは不完全であり、2番目、5番目、または100番目のアプローチから、最後に、すべての受信データが入力され、処理されます。 同時に、stream_selectは、すべてのデータが取得されるまで、メインループでマイクロ秒も待機しません。 予想されるデータの95％が完全に読み取られるような定数を選択する必要があります。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     さらにメインループ（データの次の部分を受け取った後）で、蓄積されたデータの処理を試みます（これは<b>on_read</b>メソッドです）。  wsクラスでは、on_readメソッドは基本的に「最初の行を読み取り、環境変数を準備する」、「すべてのヘッダーを読み取る」、「すべてのヘッダーを処理する」という3つのステップで構成されます。 最初の2つは説明する必要はありませんが、非ブロッキングモードであり、データがどこでも引き裂かれているという事実に備えなければならないため、かなり大量に書かれています。 ヘッダーの処理では、最初に要求の形式が正しいかどうかをチェックし、次にヘッダーがクライアントと通信するプロトコルを決定します。 その結果、 <b>switch_to_protocol</b>メソッドをプルする必要があり<b>ます</b> 。 内部のこのメソッドは、クラス「ws_ &lt;protocol&gt;」のインスタンスを形成し、メインループに戻る準備をします。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     メインループでは、実際にさらに確認する必要があります。オブジェクトを置き換える必要があるかどうか（誰かがこの場所の実装をより適切に提供できる場合-常に歓迎します）。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     次に、メインループで、ソケットが閉じているかどうかを確認する必要があります。 閉じている場合は、メモリをクリアします（詳細は次のブロックで）。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div class="spoiler">  <b class="spoiler_title">&lt;deamon.php&gt;ファイルのフルバージョン</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">require</span></span>(<span class="hljs-string"><span class="hljs-string">'ws.php'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">require</span></span>(<span class="hljs-string"><span class="hljs-string">'ws_v0.php'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">require</span></span>(<span class="hljs-string"><span class="hljs-string">'ws_v13.php'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">require</span></span>(<span class="hljs-string"><span class="hljs-string">'ws_ve.php'</span></span>); $master = stream_socket_server(<span class="hljs-string"><span class="hljs-string">"tcp://127.0.0.1:8081"</span></span>, $errno, $errstr); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!$master) <span class="hljs-keyword"><span class="hljs-keyword">die</span></span>(<span class="hljs-string"><span class="hljs-string">"$errstr ($errno)\n"</span></span>); $sockets = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>($master); <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> ws[] $connections */</span></span> $connections = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(); stream_set_blocking($master, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> ws $connection * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> $data * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> $type */</span></span> $my_callback = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($connection, $data, $type)</span></span></span><span class="hljs-function"> </span></span>{ var_dump(<span class="hljs-string"><span class="hljs-string">'my ws data: ['</span></span>.$data.<span class="hljs-string"><span class="hljs-string">'/'</span></span>.$type.<span class="hljs-string"><span class="hljs-string">']'</span></span>); $connection-&gt;send_frame(<span class="hljs-string"><span class="hljs-string">'test '</span></span>.time()); }; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) { $read = $sockets; $write = $except = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (($num_changed_streams = stream_select($read, $write, $except, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1000000</span></span>)) === <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) { var_dump(<span class="hljs-string"><span class="hljs-string">'stream_select error'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($read <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $socket) { $index_socket = array_search($socket, $sockets); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($index_socket == <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-comment"><span class="hljs-comment">//   if ($socket_new = stream_socket_accept($master, -1)) { $connection = new ws($socket_new, $my_callback); $sockets[] = $socket_new; $index_new_socket = array_search($socket_new, $sockets); $connections[$index_new_socket] = &amp;$connection; $index_socket = $index_new_socket; } else { //            error_log('stream_socket_accept'); var_dump('error stream_socket_accept'); continue; } } $connection = &amp;$connections[$index_socket]; $connection-&gt;on_receive_data(); $connection-&gt;on_read(); if ($connection-&gt;get_state() == ws::STATE_PREHANDSHAKE) { $connection = $connection-&gt;get_new_instance(); $connections[$index_socket] = &amp;$connection; $connection-&gt;on_read(); } if ($connection-&gt;closed()) { unset($sockets[$index_socket]); unset($connections[$index_socket]); unset($connection); var_dump('close '.$index_socket); } } }</span></span></code>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
     </pre>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    </div></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      「$ My_callback」がここに追加されます-これはクライアントからのカスタムメッセージハンドラです。 もちろん、本番環境ではあらゆる種類のオブジェクトにすべてをラップできますが、ここでは関数変数だけを理解しやすくします。 彼女については少し後で。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     新しい接続の処理を実装し、ループの本体を実装しました。これについてはもう少し上に書きました。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <a href="https://habrahabr.ru/post/209864/">ここで</a>サーバーコードに注意したいです。 ソケットから読み取られたデータが空の文字列である場合（もちろん、更新で空の文字列のチェックを見た場合）、ソケットを閉じる必要があります。 ああ、私はこの勢いがどれだけ私に血を飲んだのか、そして何人のユーザーを失ったのかさえ知りません。 突然、Safariは空の文字列を送信し、これを標準と見なし、このコードはユーザーへの接続を取得して閉じます。  Yandexブラウザは時々同じように動作します。 理由はわかりませんが、この場合、Safariの場合、WebSocketはフリーズしたままです。つまり、閉じず、開かず、ハングするだけです。 私はこの魔法のブラウザに無関心ではないことに気づきましたか？ 私はIE6をどのように作り上げたか覚えています-同じ感覚です。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     次に、 <b>array_search</b>を使用して、$ sockets配列と$ connections配列を同期する理由について説明します。 事実、stream_selectはクリーンな$ソケット配列に不可欠であり、他には何もありません。 しかし、どういうわけか、$ sockets配列の特定のソケットをwsオブジェクトに関連付ける必要があります。 たくさんのオプションを試してみました-最終的に、キーで常に同期される2つのアレイがあるようなオプションで停止しました。  1つの配列では、stream_selectに必要なクリーンソケット、2番目の配列では、wsクラスまたはその子孫のインスタンス。 誰かがより良いこの場所を提供できる場合-提供しています。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     注意すべきもう1つのケースは、 <b>stream_socket_acceptに</b>欠陥<b>が</b>ある場合です。 私が理解しているように、理論的には、マスターソケットが非ブロッキングモードであり、クライアントを接続するのに十分なデータが到着していない場合にのみ可能です。 したがって、何もしません。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div class="spoiler">  <b class="spoiler_title">ファイル&lt;ws.php&gt;のフルバージョン</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ws</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> $hvaltr = [<span class="hljs-string"><span class="hljs-string">'; '</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'&amp;'</span></span>, <span class="hljs-string"><span class="hljs-string">';'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'&amp;'</span></span>, <span class="hljs-string"><span class="hljs-string">' '</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'%20'</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> maxAllowedPacket = <span class="hljs-number"><span class="hljs-number">1024</span></span> * <span class="hljs-number"><span class="hljs-number">1024</span></span> * <span class="hljs-number"><span class="hljs-number">1024</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> MAX_BUFFER_SIZE = <span class="hljs-number"><span class="hljs-number">1024</span></span> * <span class="hljs-number"><span class="hljs-number">1024</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $socket; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> array _SERVER */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> $server = []; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $on_frame_user = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $handshaked = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $headers = []; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $headers_sent = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $closed = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $unparsed_data = <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $current_header; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $unread_lines = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(); <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> ws|null */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $new_instance = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $extensions = []; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $extensionsCleanRegex = <span class="hljs-string"><span class="hljs-string">'/(?:^|\W)x-webkit-/iS'</span></span>; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> integer Current state */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $state = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-comment"><span class="hljs-comment">// stream state of the connection (application protocol level) /** * Alias of STATE_STANDBY */ const STATE_ROOT = 0; /** * Standby state (default state) */ const STATE_STANDBY = 0; /** * State: first line */ const STATE_FIRSTLINE = 1; /** * State: headers */ const STATE_HEADERS = 2; /** * State: content */ const STATE_CONTENT = 3; /** * State: prehandshake */ const STATE_PREHANDSHAKE = 5; /** * State: handshaked */ const STATE_HANDSHAKED = 6; public function get_state() { return $this-&gt;state; } public function get_new_instance() { return $this-&gt;new_instance; } public function closed() { return $this-&gt;closed; } protected function close() { if ($this-&gt;closed) return; var_dump('self close'); fclose($this-&gt;socket); $this-&gt;closed = true; } public function __construct($socket, $on_frame_user = null) { stream_set_blocking($socket, false); $this-&gt;socket = $socket; $this-&gt;on_frame_user = $on_frame_user; } private function read_line() { $lines = explode(PHP_EOL, $this-&gt;unparsed_data); $last_line = $lines[count($lines)-1]; unset($lines[count($lines) - 1]); foreach ($lines as $line) { $this-&gt;unread_lines[] = $line; } $this-&gt;unparsed_data = $last_line; if (count($this-&gt;unread_lines) != 0) { return array_shift($this-&gt;unread_lines); } else { return null; } } public function on_receive_data() { if ($this-&gt;closed) return; $data = stream_socket_recvfrom($this-&gt;socket, self::MAX_BUFFER_SIZE); if (is_string($data)) { $this-&gt;unparsed_data .= $data; } } /** * Called when new data received. * @return void */ public function on_read() { if ($this-&gt;closed) return; if ($this-&gt;state === self::STATE_STANDBY) { $this-&gt;state = self::STATE_FIRSTLINE; } if ($this-&gt;state === self::STATE_FIRSTLINE) { if (!$this-&gt;http_read_first_line()) { return; } $this-&gt;state = self::STATE_HEADERS; } if ($this-&gt;state === self::STATE_HEADERS) { if (!$this-&gt;http_read_headers()) { return; } if (!$this-&gt;http_process_headers()) { $this-&gt;close(); return; } $this-&gt;state = self::STATE_CONTENT; } if ($this-&gt;state === self::STATE_CONTENT) { $this-&gt;state = self::STATE_PREHANDSHAKE; } } /** * Read first line of HTTP request * @return boolean|null Success */ protected function http_read_first_line() { if (($l = $this-&gt;read_line()) === null) { return null; } $e = explode(' ', $l); $u = isset($e[1]) ? parse_url($e[1]) : false; if ($u === false) { $this-&gt;bad_request(); return false; } if (!isset($u['path'])) { $u['path'] = null; } if (isset($u['host'])) { $this-&gt;server['HTTP_HOST'] = $u['host']; } $address = explode(':', stream_socket_get_name($this-&gt;socket, true)); //   $srv = &amp; $this-&gt;server; $srv['REQUEST_METHOD'] = $e[0]; $srv['REQUEST_TIME'] = time(); $srv['REQUEST_TIME_FLOAT'] = microtime(true); $srv['REQUEST_URI'] = $u['path'] . (isset($u['query']) ? '?' . $u['query'] : ''); $srv['DOCUMENT_URI'] = $u['path']; $srv['PHP_SELF'] = $u['path']; $srv['QUERY_STRING'] = isset($u['query']) ? $u['query'] : null; $srv['SCRIPT_NAME'] = $srv['DOCUMENT_URI'] = isset($u['path']) ? $u['path'] : '/'; $srv['SERVER_PROTOCOL'] = isset($e[2]) ? $e[2] : 'HTTP/1.1'; $srv['REMOTE_ADDR'] = $address[0]; $srv['REMOTE_PORT'] = $address[1]; return true; } /** * Read headers line-by-line * @return boolean|null Success */ protected function http_read_headers() { while (($l = $this-&gt;read_line()) !== null) { if ($l === '') { return true; } $e = explode(': ', $l); if (isset($e[1])) { $this-&gt;current_header = 'HTTP_' . strtoupper(strtr($e[0], ['-' =&gt; '_'])); $this-&gt;server[$this-&gt;current_header] = $e[1]; } elseif (($e[0][0] === "\t" || $e[0][0] === "\x20") &amp;&amp; $this-&gt;current_header) { // multiline header continued $this-&gt;server[$this-&gt;current_header] .= $e[0]; } else { // whatever client speaks is not HTTP anymore $this-&gt;bad_request(); return false; } } } /** * Process headers * @return bool */ protected function http_process_headers() { $this-&gt;state = self::STATE_PREHANDSHAKE; if (isset($this-&gt;server['HTTP_SEC_WEBSOCKET_EXTENSIONS'])) { $str = strtolower($this-&gt;server['HTTP_SEC_WEBSOCKET_EXTENSIONS']); $str = preg_replace($this-&gt;extensionsCleanRegex, '', $str); $this-&gt;extensions = explode(', ', $str); } if (!isset($this-&gt;server['HTTP_CONNECTION']) || (!preg_match('~(?:^|\W)Upgrade(?:\W|$)~i', $this-&gt;server['HTTP_CONNECTION'])) // "Upgrade" is not always alone (ie. "Connection: Keep-alive, Upgrade") || !isset($this-&gt;server['HTTP_UPGRADE']) || (strtolower($this-&gt;server['HTTP_UPGRADE']) !== 'websocket') // Lowercase comparison iss important ) { $this-&gt;close(); return false; } /* if (isset($this-&gt;server['HTTP_COOKIE'])) { self::parse_str(strtr($this-&gt;server['HTTP_COOKIE'], self::$hvaltr), $this-&gt;cookie); } if (isset($this-&gt;server['QUERY_STRING'])) { self::parse_str($this-&gt;server['QUERY_STRING'], $this-&gt;get); } */ // ---------------------------------------------------------- // Protocol discovery, based on HTTP headers... // ---------------------------------------------------------- if (isset($this-&gt;server['HTTP_SEC_WEBSOCKET_VERSION'])) { // HYBI if ($this-&gt;server['HTTP_SEC_WEBSOCKET_VERSION'] === '8') { // Version 8 (FF7, Chrome14) $this-&gt;switch_to_protocol('v13'); } elseif ($this-&gt;server['HTTP_SEC_WEBSOCKET_VERSION'] === '13') { // newest protocol $this-&gt;switch_to_protocol('v13'); } else { error_log(get_class($this) . '::' . __METHOD__ . " : Websocket protocol version " . $this-&gt;server['HTTP_SEC_WEBSOCKET_VERSION'] . ' is not yet supported for client "addr"'); // $this-&gt;addr $this-&gt;close(); return false; } } elseif (!isset($this-&gt;server['HTTP_SEC_WEBSOCKET_KEY1']) || !isset($this-&gt;server['HTTP_SEC_WEBSOCKET_KEY2'])) { $this-&gt;switch_to_protocol('ve'); } else { // Defaulting to HIXIE (Safari5 and many non-browser clients...) $this-&gt;switch_to_protocol('v0'); } // ---------------------------------------------------------- // End of protocol discovery // ---------------------------------------------------------- return true; } private function switch_to_protocol($protocol) { $class = 'ws_'.$protocol; $this-&gt;new_instance = new $class($this-&gt;socket); $this-&gt;new_instance-&gt;state = $this-&gt;state; $this-&gt;new_instance-&gt;unparsed_data = $this-&gt;unparsed_data; $this-&gt;new_instance-&gt;server = $this-&gt;server; $this-&gt;new_instance-&gt;on_frame_user = $this-&gt;on_frame_user; } /** * Send Bad request * @return void */ public function bad_request() { $this-&gt;write("400 Bad Request\r\n\r\n&lt;html&gt;&lt;head&gt;&lt;title&gt;400 Bad Request&lt;/title&gt;&lt;/head&gt;&lt;body bgcolor=\"white\"&gt;&lt;center&gt;&lt;h1&gt;400 Bad Request&lt;/h1&gt;&lt;/center&gt;&lt;/body&gt;&lt;/html&gt;"); $this-&gt;close(); } /** * Replacement for default parse_str(), it supoorts UCS-2 like this: %uXXXX * @param string $s String to parse * @param array &amp;$var Reference to the resulting array * @param boolean $header Header-style string * @return void */ public static function parse_str($s, &amp;$var, $header = false) { static $cb; if ($cb === null) { $cb = function ($m) { return urlencode(html_entity_decode('&amp;#' . hexdec($m[1]) . ';', ENT_NOQUOTES, 'utf-8')); }; } if ($header) { $s = strtr($s, self::$hvaltr); } if ( (stripos($s, '%u') !== false) &amp;&amp; preg_match('~(%u[af\d]{4}|%[cf][af\d](?!%[89a-f][af\d]))~is', $s, $m) ) { $s = preg_replace_callback('~%(u[af\d]{4}|[af\d]{2})~i', $cb, $s); } parse_str($s, $var); } /** * Send data to the connection. Note that it just writes to buffer that flushes at every baseloop * @param string $data Data to send * @return boolean Success */ public function write($data) { if ($this-&gt;closed) return false; return stream_socket_sendto($this-&gt;socket, $data) == 0; } /** *         * @return bool */ protected function send_handshake_reply() { return false; } /** * Called when we're going to handshake. * @return boolean Handshake status */ public function handshake() { $extra_headers = ''; foreach ($this-&gt;headers as $k =&gt; $line) { if ($k !== 'STATUS') { $extra_headers .= $line . "\r\n"; } } if (!$this-&gt;send_handshake_reply($extra_headers)) { error_log(get_class($this) . '::' . __METHOD__ . ' : Handshake protocol failure for client ""'); // $this-&gt;addr $this-&gt;close(); return false; } $this-&gt;handshaked = true; $this-&gt;headers_sent = true; $this-&gt;state = static::STATE_HANDSHAKED; return true; } /** * Read from buffer without draining * @param integer $n Number of bytes to read * @param integer $o Offset * @return string|false */ public function look($n, $o = 0) { if (strlen($this-&gt;unparsed_data) &lt;= $o) { return ''; } return substr($this-&gt;unparsed_data, $o, $n); } /** * Convert bytes into integer * @param string $str Bytes * @param boolean $l Little endian? Default is false * @return integer */ public static function bytes2int($str, $l = false) { if ($l) { $str = strrev($str); } $dec = 0; $len = strlen($str); for ($i = 0; $i &lt; $len; ++$i) { $dec += ord(substr($str, $i, 1)) * pow(0x100, $len - $i - 1); } return $dec; } /** * Drains buffer * @param integer $n Numbers of bytes to drain * @return boolean Success */ public function drain($n) { $ret = substr($this-&gt;unparsed_data, 0, $n); $this-&gt;unparsed_data = substr($this-&gt;unparsed_data, $n); return $ret; } /** * Read data from the connection's buffer * @param integer $n Max. number of bytes to read * @return string|false Readed data */ public function read($n) { if ($n &lt;= 0) { return ''; } $read = $this-&gt;drain($n); if ($read === '') { return false; } return $read; } /** * Reads all data from the connection's buffer * @return string Readed data */ public function read_unlimited() { $ret = $this-&gt;unparsed_data; $this-&gt;unparsed_data = ''; return $ret; } /** * Searches first occurence of the string in input buffer * @param string $what Needle * @param integer $start Offset start * @param integer $end Offset end * @return integer Position */ public function search($what, $start = 0, $end = -1) { return strpos($this-&gt;unparsed_data, $what, $start); } /** * Called when new frame received. * @param string $data Frame's data. * @param string $type Frame's type ("STRING" OR "BINARY"). * @return boolean Success. */ public function on_frame($data, $type) { if (is_callable($this-&gt;on_frame_user)) { call_user_func($this-&gt;on_frame_user, $this, $data, $type); } return true; } public function send_frame($data, $type = null, $cb = null) { return false; } /** * Get real frame type identificator * @param $type * @return integer */ public function get_frame_type($type) { if (is_int($type)) { return $type; } if ($type === null) { $type = 'STRING'; } $frametype = @constant(get_class($this) . '::' . $type); if ($frametype === null) { error_log(__METHOD__ . ' : Undefined frametype "' . $type . '"'); } return $frametype; } }</span></span></code>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
     </pre>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    </div></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     実際には、「Webソケットレベルでクライアントに接続する」、「クライアントからメッセージを受信する」、「クライアントにメッセージを送信する」という3つのことが追加されます。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     まず、いくつかの理論と用語。  「ハンドシェイク」は、Webソケットの観点から、httpを介した接続を確立するための手順です。 結局のところ、一連の質問を解決する必要があります。プロキシとキャッシュの厚い部分を突破する方法、邪悪なハッカーから身を守る方法です。  「フレーム」という用語は、復号化された形式のデータです。これは、クライアントからのメッセージまたはクライアントへのメッセージです。 おそらく記事の冒頭でこれについて書く価値はありましたが、これらの「フレーム」のために、ソケットサーバーをブロッキングソケットモードにすることは意味がありません。 この瞬間が<a href="https://habrahabr.ru/post/209864/">ここ</a>で行われ<a href="https://habrahabr.ru/post/209864/">た方法</a> -それは私が一晩以上睡眠を奪った。 その記事では、オプションはフレームが完全に到着しなかった、または2つが一度に到着したとは見なされません。 ちなみに、ゲームログが示したように、これとそれは非常に典型的な状況です。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     さて詳細に。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Webソケットレベルでのクライアントへの接続</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -プロトコル（ws_v0など）がon_readメソッドをブロックし、十分なデータがあるときに内部でハンドシェイクをプルすると想定されます。次は、親の「握手」です。次に、send_handshake_replyメソッドが作動します。これはプロトコルに実装する必要があります。この「send_handshake_reply」は、「接続が確立されたこと」、通常のブラウザ-通常の回答、およびSafari-特別な回答を理解するような方法でクライアントに応答する必要があります。</font></font>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クライアントからメッセージを受信する</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。愚かなクライアントは、接続が確立されず、ユーザーからのメッセージがすでに到着しているようなオプションを実装できることに注意してください。したがって、「unparsed_data」変数を慎重に扱う必要があります。各プロトコルで、on_readメソッドは送信されたフレームのサイズを理解し、フレーム全体が到着したことを確認し、ユーザーのメッセージで到着したフレームを復号化する必要があります。各プロトコルで、これは非常に異なって非常にカーリーに行われます（フレームが完全に到着したかどうかはわかりませんが、次のフレームのバイトを噛むことはできません）。さらに「on_read」の内部で、クライアントデータが受信および復号化され、そのタイプが決定されると（はい、そのように提供されます）、「on_frame」メソッドをプルします。 my_callback、メインループの前）その結果、$ my_callbackはクライアントからメッセージを受け取ります。</font></font>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クライアントにメッセージを送信します</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">「send_frame」メソッドは、プロトコル内に実装する必要があるだけで、ひきつります。</font><font style="vertical-align: inherit;">ここでは、メッセージを暗号化してユーザーに送信するだけです。</font><font style="vertical-align: inherit;">異なるプロトコルは異なる方法で暗号化します。</font></font>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <font style="vertical-align: inherit;"><font style="vertical-align: inherit;">現在、3つのプロトコル「v13」、「v0」、「ve」を添付しています。</font></font>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ファイル&lt;ws_v13.php&gt;</font></font></b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ws_v13</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ws</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> CONTINUATION = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> STRING = <span class="hljs-number"><span class="hljs-number">0x1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> BINARY = <span class="hljs-number"><span class="hljs-number">0x2</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> CONNCLOSE = <span class="hljs-number"><span class="hljs-number">0x8</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> PING = <span class="hljs-number"><span class="hljs-number">0x9</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> PONG = <span class="hljs-number"><span class="hljs-number">0xA</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> $opcodes = [ <span class="hljs-number"><span class="hljs-number">0</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'CONTINUATION'</span></span>, <span class="hljs-number"><span class="hljs-number">0x1</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'STRING'</span></span>, <span class="hljs-number"><span class="hljs-number">0x2</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'BINARY'</span></span>, <span class="hljs-number"><span class="hljs-number">0x8</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'CONNCLOSE'</span></span>, <span class="hljs-number"><span class="hljs-number">0x9</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'PING'</span></span>, <span class="hljs-number"><span class="hljs-number">0xA</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'PONG'</span></span>, ]; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $outgoingCompression = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $framebuf = <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-comment"><span class="hljs-comment">/** * Apply mask * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> $data * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> string|false $mask * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> mixed */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mask</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($data, $mask)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ($i = <span class="hljs-number"><span class="hljs-number">0</span></span>, $l = strlen($data), $ml = strlen($mask); $i &lt; $l; $i++) { $data[$i] = $data[$i] ^ $mask[$i % $ml]; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $data; } <span class="hljs-comment"><span class="hljs-comment">/** * Sends a frame. * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> string $data Frame's data. * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> string $type Frame's type. ("STRING" OR "BINARY") * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> callable $cb Optional. Callback called when the frame is received by client. * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@callback</span></span></span><span class="hljs-comment"> $cb ( ) * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> boolean Success. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">send_frame</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($data, $type = null, $cb = null)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;handshaked) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;closed &amp;&amp; $type !== <span class="hljs-string"><span class="hljs-string">'CONNCLOSE'</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } <span class="hljs-comment"><span class="hljs-comment">/*if (in_array($type, ['STRING', 'BINARY']) &amp;&amp; ($this-&gt;outgoingCompression &gt; 0) &amp;&amp; in_array('deflate-frame', $this-&gt;extensions)) { //$data = gzcompress($data, $this-&gt;outgoingCompression); //$rsv1 = 1; }*/</span></span> $fin = <span class="hljs-number"><span class="hljs-number">1</span></span>; $rsv1 = <span class="hljs-number"><span class="hljs-number">0</span></span>; $rsv2 = <span class="hljs-number"><span class="hljs-number">0</span></span>; $rsv3 = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;write(chr(bindec($fin . $rsv1 . $rsv2 . $rsv3 . str_pad(decbin(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;get_frame_type($type)), <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-string"><span class="hljs-string">'0'</span></span>, STR_PAD_LEFT)))); $dataLength = strlen($data); $isMasked = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; $isMaskedInt = $isMasked ? <span class="hljs-number"><span class="hljs-number">128</span></span> : <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($dataLength &lt;= <span class="hljs-number"><span class="hljs-number">125</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;write(chr($dataLength + $isMaskedInt)); } <span class="hljs-keyword"><span class="hljs-keyword">elseif</span></span> ($dataLength &lt;= <span class="hljs-number"><span class="hljs-number">65535</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;write(chr(<span class="hljs-number"><span class="hljs-number">126</span></span> + $isMaskedInt) . <span class="hljs-comment"><span class="hljs-comment">// 126 + 128 chr($dataLength &gt;&gt; 8) . chr($dataLength &amp; 0xFF)); } else { $this-&gt;write(chr(127 + $isMaskedInt) . // 127 + 128 chr($dataLength &gt;&gt; 56) . chr($dataLength &gt;&gt; 48) . chr($dataLength &gt;&gt; 40) . chr($dataLength &gt;&gt; 32) . chr($dataLength &gt;&gt; 24) . chr($dataLength &gt;&gt; 16) . chr($dataLength &gt;&gt; 8) . chr($dataLength &amp; 0xFF)); } if ($isMasked) { $mask = chr(mt_rand(0, 0xFF)) . chr(mt_rand(0, 0xFF)) . chr(mt_rand(0, 0xFF)) . chr(mt_rand(0, 0xFF)); $this-&gt;write($mask . $this-&gt;mask($data, $mask)); } else { $this-&gt;write($data); } if ($cb !== null) { $cb(); } return true; } /** * Sends a handshake message reply * @param string Received data (no use in this class) * @return boolean OK? */ public function send_handshake_reply($extraHeaders = '') { if (!isset($this-&gt;server['HTTP_SEC_WEBSOCKET_KEY']) || !isset($this-&gt;server['HTTP_SEC_WEBSOCKET_VERSION'])) { return false; } if ($this-&gt;server['HTTP_SEC_WEBSOCKET_VERSION'] !== '13' &amp;&amp; $this-&gt;server['HTTP_SEC_WEBSOCKET_VERSION'] !== '8') { return false; } if (isset($this-&gt;server['HTTP_ORIGIN'])) { $this-&gt;server['HTTP_SEC_WEBSOCKET_ORIGIN'] = $this-&gt;server['HTTP_ORIGIN']; } if (!isset($this-&gt;server['HTTP_SEC_WEBSOCKET_ORIGIN'])) { $this-&gt;server['HTTP_SEC_WEBSOCKET_ORIGIN'] = ''; } $this-&gt;write("HTTP/1.1 101 Switching Protocols\r\n" . "Upgrade: WebSocket\r\n" . "Connection: Upgrade\r\n" . "Date: " . date('r') . "\r\n" . "Sec-WebSocket-Origin: " . $this-&gt;server['HTTP_SEC_WEBSOCKET_ORIGIN'] . "\r\n" . "Sec-WebSocket-Location: ws://" . $this-&gt;server['HTTP_HOST'] . $this-&gt;server['REQUEST_URI'] . "\r\n" . "Sec-WebSocket-Accept: " . base64_encode(sha1(trim($this-&gt;server['HTTP_SEC_WEBSOCKET_KEY']) . "258EAFA5-E914-47DA-95CA-C5AB0DC85B11", true)) . "\r\n" ); if (isset($this-&gt;server['HTTP_SEC_WEBSOCKET_PROTOCOL'])) { $this-&gt;write("Sec-WebSocket-Protocol: " . $this-&gt;server['HTTP_SEC_WEBSOCKET_PROTOCOL']."\r\n"); } $this-&gt;write($extraHeaders."\r\n"); return true; } /** * Called when new data received * @see http://tools.ietf.org/html/draft-ietf-hybi-thewebsocketprotocol-10#page-16 * @return void */ public function on_read() { if ($this-&gt;closed) return; if ($this-&gt;state === self::STATE_PREHANDSHAKE) { if (!$this-&gt;handshake()) { return; } } if ($this-&gt;state === self::STATE_HANDSHAKED) { while (($buflen = strlen($this-&gt;unparsed_data)) &gt;= 2) { $first = ord($this-&gt;look(1)); // first byte integer (fin, opcode) $firstBits = decbin($first); $opcode = (int)bindec(substr($firstBits, 4, 4)); if ($opcode === 0x8) { // CLOSE $this-&gt;close(); return; } $opcodeName = isset(static::$opcodes[$opcode]) ? static::$opcodes[$opcode] : false; if (!$opcodeName) { error_log(get_class($this) . ': Undefined opcode ' . $opcode); $this-&gt;close(); return; } $second = ord($this-&gt;look(1, 1)); // second byte integer (masked, payload length) $fin = (bool)($first &gt;&gt; 7); $isMasked = (bool)($second &gt;&gt; 7); $dataLength = $second &amp; 0x7f; $p = 2; if ($dataLength === 0x7e) { // 2 bytes-length if ($buflen &lt; $p + 2) { return; // not enough data yet } $dataLength = self::bytes2int($this-&gt;look(2, $p), false); $p += 2; } elseif ($dataLength === 0x7f) { // 8 bytes-length if ($buflen &lt; $p + 8) { return; // not enough data yet } $dataLength = self::bytes2int($this-&gt;look(8, $p)); $p += 8; } if (self::maxAllowedPacket &lt;= $dataLength) { // Too big packet $this-&gt;close(); return; } if ($isMasked) { if ($buflen &lt; $p + 4) { return; // not enough data yet } $mask = $this-&gt;look(4, $p); $p += 4; } if ($buflen &lt; $p + $dataLength) { return; // not enough data yet } $this-&gt;drain($p); $data = $this-&gt;read($dataLength); if ($isMasked) { $data = $this-&gt;mask($data, $mask); } //Daemon::log(De</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">bug:</span></span></span><span class="hljs-comment">:dump(array('ext' =&gt; $this-&gt;extensions, 'rsv1' =&gt; $firstBits[1], 'data' =&gt; De</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">bug:</span></span></span><span class="hljs-comment">:exportBytes($data)))); /*if ($firstBits[1] &amp;&amp; in_array('deflate-frame', $this-&gt;extensions)) { // deflate frame $data = gzuncompress($data, $this-&gt;pool-&gt;maxAllowedPacket); }*/ if (!$fin) { $this-&gt;framebuf .= $data; } else { $this-&gt;on_frame($this-&gt;framebuf . $data, $opcodeName); $this-&gt;framebuf = ''; } } } } }</span></span></code>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
     </pre>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    </div></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ファイル&lt;ws_v0.php&gt;</font></font></b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ws_v0</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ws</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> STRING = <span class="hljs-number"><span class="hljs-number">0x00</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> BINARY = <span class="hljs-number"><span class="hljs-number">0x80</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $key; <span class="hljs-comment"><span class="hljs-comment">/** * Sends a handshake message reply * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> string Received data (no use in this class) * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> boolean OK? */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">send_handshake_reply</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($extraHeaders = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">''</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;server[<span class="hljs-string"><span class="hljs-string">'HTTP_SEC_WEBSOCKET_KEY1'</span></span>]) || !<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;server[<span class="hljs-string"><span class="hljs-string">'HTTP_SEC_WEBSOCKET_KEY2'</span></span>])) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } $final_key = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_computeFinalKey(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;server[<span class="hljs-string"><span class="hljs-string">'HTTP_SEC_WEBSOCKET_KEY1'</span></span>], <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;server[<span class="hljs-string"><span class="hljs-string">'HTTP_SEC_WEBSOCKET_KEY2'</span></span>], <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;key); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;key = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!$final_key) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;server[<span class="hljs-string"><span class="hljs-string">'HTTP_SEC_WEBSOCKET_ORIGIN'</span></span>])) { <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;server[<span class="hljs-string"><span class="hljs-string">'HTTP_SEC_WEBSOCKET_ORIGIN'</span></span>] = <span class="hljs-string"><span class="hljs-string">''</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;write(<span class="hljs-string"><span class="hljs-string">"HTTP/1.1 101 Web Socket Protocol Handshake\r\n"</span></span> . <span class="hljs-string"><span class="hljs-string">"Upgrade: WebSocket\r\n"</span></span> . <span class="hljs-string"><span class="hljs-string">"Connection: Upgrade\r\n"</span></span> . <span class="hljs-string"><span class="hljs-string">"Sec-WebSocket-Origin: "</span></span> . <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;server[<span class="hljs-string"><span class="hljs-string">'HTTP_ORIGIN'</span></span>] . <span class="hljs-string"><span class="hljs-string">"\r\n"</span></span> . <span class="hljs-string"><span class="hljs-string">"Sec-WebSocket-Location: ws://"</span></span> . <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;server[<span class="hljs-string"><span class="hljs-string">'HTTP_HOST'</span></span>] . <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;server[<span class="hljs-string"><span class="hljs-string">'REQUEST_URI'</span></span>] . <span class="hljs-string"><span class="hljs-string">"\r\n"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;server[<span class="hljs-string"><span class="hljs-string">'HTTP_SEC_WEBSOCKET_PROTOCOL'</span></span>])) { <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;write(<span class="hljs-string"><span class="hljs-string">"Sec-WebSocket-Protocol: "</span></span> . <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;server[<span class="hljs-string"><span class="hljs-string">'HTTP_SEC_WEBSOCKET_PROTOCOL'</span></span>].<span class="hljs-string"><span class="hljs-string">"\r\n"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;write($extraHeaders . <span class="hljs-string"><span class="hljs-string">"\r\n"</span></span> . $final_key); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-comment"><span class="hljs-comment">/** * Computes final key for Sec-WebSocket. * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> string Key1 * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> string Key2 * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> string Data * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> string Result */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_computeFinalKey</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($key1, $key2, $data)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (strlen($data) &lt; <span class="hljs-number"><span class="hljs-number">8</span></span>) { error_log(get_class(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>) . <span class="hljs-string"><span class="hljs-string">'::'</span></span> . <span class="hljs-keyword"><span class="hljs-keyword">__METHOD__</span></span> . <span class="hljs-string"><span class="hljs-string">' : Invalid handshake data for client ""'</span></span>); <span class="hljs-comment"><span class="hljs-comment">// $this-&gt;addr return false; } return md5($this-&gt;_computeKey($key1) . $this-&gt;_computeKey($key2) . substr($data, 0, 8), true); } /** * Computes key for Sec-WebSocket. * @param string Key * @return string Result */ protected function _computeKey($key) { $spaces = 0; $digits = ''; for ($i = 0, $s = strlen($key); $i &lt; $s; ++$i) { $c = substr($key, $i, 1); if ($c === "\x20") { ++$spaces; } elseif (ctype_digit($c)) { $digits .= $c; } } if ($spaces &gt; 0) { $result = (float)floor($digits / $spaces); } else { $result = (float)$digits; } return pack('N', $result); } /** * Sends a frame. * @param string $data Frame's data. * @param string $type Frame's type. ("STRING" OR "BINARY") * @param callable $cb Optional. Callback called when the frame is received by client. * @callback $cb ( ) * @return boolean Success. */ public function send_frame($data, $type = null, $cb = null) { if (!$this-&gt;handshaked) { return false; } if ($this-&gt;closed &amp;&amp; $type !== 'CONNCLOSE') { return false; } if ($type === 'CONNCLOSE') { if ($cb !== null) { $cb($this); return true; } } $type = $this-&gt;get_frame_type($type); // Binary if (($type &amp; self::BINARY) === self::BINARY) { $n = strlen($data); $len = ''; $pos = 0; char: ++$pos; $c = $n &gt;&gt; 0 &amp; 0x7F; $n &gt;&gt;= 7; if ($pos !== 1) { $c += 0x80; } if ($c !== 0x80) { $len = chr($c) . $len; goto char; }; $this-&gt;write(chr(self::BINARY) . $len . $data); } // String else { $this-&gt;write(chr(self::STRING) . $data . "\xFF"); } if ($cb !== null) { $cb(); } return true; } /** * Called when new data received * @return void */ public function on_read() { if ($this-&gt;state === self::STATE_PREHANDSHAKE) { if (strlen($this-&gt;unparsed_data) &lt; 8) { return; } $this-&gt;key = $this-&gt;read_unlimited(); $this-&gt;handshake(); } if ($this-&gt;state === self::STATE_HANDSHAKED) { while (($buflen = strlen($this-&gt;unparsed_data)) &gt;= 2) { $hdr = $this-&gt;look(10); $frametype = ord(substr($hdr, 0, 1)); if (($frametype &amp; 0x80) === 0x80) { $len = 0; $i = 0; do { if ($buflen &lt; $i + 1) { // not enough data yet return; } $b = ord(substr($hdr, ++$i, 1)); $n = $b &amp; 0x7F; $len *= 0x80; $len += $n; } while ($b &gt; 0x80); if (self::maxAllowedPacket &lt;= $len) { // Too big packet $this-&gt;close(); return; } if ($buflen &lt; $len + $i + 1) { // not enough data yet return; } $this-&gt;drain($i + 1); $this-&gt;on_frame($this-&gt;read($len), 'BINARY'); } else { if (($p = $this-&gt;search("\xFF")) !== false) { if (self::maxAllowedPacket &lt;= $p - 1) { // Too big packet $this-&gt;close(); return; } $this-&gt;drain(1); $data = $this-&gt;read($p); $this-&gt;drain(1); $this-&gt;on_frame($data, 'STRING'); } else { if (self::maxAllowedPacket &lt; $buflen - 1) { // Too big packet $this-&gt;close(); return; } // not enough data yet return; } } } } } }</span></span></code>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
     </pre>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    </div></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ファイル&lt;ws_ve.php&gt;</font></font></b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ws_ve</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ws</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> STRING = <span class="hljs-number"><span class="hljs-number">0x00</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> BINARY = <span class="hljs-number"><span class="hljs-number">0x80</span></span>; <span class="hljs-comment"><span class="hljs-comment">/** * Sends a handshake message reply * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> string Received data (no use in this class) * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> boolean OK? */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">send_handshake_reply</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($extraHeaders = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">''</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;server[<span class="hljs-string"><span class="hljs-string">'HTTP_SEC_WEBSOCKET_ORIGIN'</span></span>])) { <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;server[<span class="hljs-string"><span class="hljs-string">'HTTP_SEC_WEBSOCKET_ORIGIN'</span></span>] = <span class="hljs-string"><span class="hljs-string">''</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;write(<span class="hljs-string"><span class="hljs-string">"HTTP/1.1 101 Web Socket Protocol Handshake\r\n"</span></span> . <span class="hljs-string"><span class="hljs-string">"Upgrade: WebSocket\r\n"</span></span> . <span class="hljs-string"><span class="hljs-string">"Connection: Upgrade\r\n"</span></span> . <span class="hljs-string"><span class="hljs-string">"Sec-WebSocket-Origin: "</span></span> . <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;server[<span class="hljs-string"><span class="hljs-string">'HTTP_ORIGIN'</span></span>] . <span class="hljs-string"><span class="hljs-string">"\r\n"</span></span> . <span class="hljs-string"><span class="hljs-string">"Sec-WebSocket-Location: ws://"</span></span> . <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;server[<span class="hljs-string"><span class="hljs-string">'HTTP_HOST'</span></span>] . <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;server[<span class="hljs-string"><span class="hljs-string">'REQUEST_URI'</span></span>] . <span class="hljs-string"><span class="hljs-string">"\r\n"</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;server[<span class="hljs-string"><span class="hljs-string">'HTTP_SEC_WEBSOCKET_PROTOCOL'</span></span>])) { <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;write(<span class="hljs-string"><span class="hljs-string">"Sec-WebSocket-Protocol: "</span></span> . <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;server[<span class="hljs-string"><span class="hljs-string">'HTTP_SEC_WEBSOCKET_PROTOCOL'</span></span>].<span class="hljs-string"><span class="hljs-string">"\r\n"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;write($extraHeaders.<span class="hljs-string"><span class="hljs-string">"\r\n"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-comment"><span class="hljs-comment">/** * Computes key for Sec-WebSocket. * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> string Key * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> string Result */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_computeKey</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($key)</span></span></span><span class="hljs-function"> </span></span>{ $spaces = <span class="hljs-number"><span class="hljs-number">0</span></span>; $digits = <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ($i = <span class="hljs-number"><span class="hljs-number">0</span></span>, $s = strlen($key); $i &lt; $s; ++$i) { $c = substr($key, $i, <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($c === <span class="hljs-string"><span class="hljs-string">"\x20"</span></span>) { ++$spaces; } <span class="hljs-keyword"><span class="hljs-keyword">elseif</span></span> (ctype_digit($c)) { $digits .= $c; } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($spaces &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { $result = (float)floor($digits / $spaces); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { $result = (float)$digits; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> pack(<span class="hljs-string"><span class="hljs-string">'N'</span></span>, $result); } <span class="hljs-comment"><span class="hljs-comment">/** * Sends a frame. * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> string $data Frame's data. * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> string $type Frame's type. ("STRING" OR "BINARY") * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> callable $cb Optional. Callback called when the frame is received by client. * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@callback</span></span></span><span class="hljs-comment"> $cb ( ) * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> boolean Success. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">send_frame</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($data, $type = null, $cb = null)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;handshaked) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;closed &amp;&amp; $type !== <span class="hljs-string"><span class="hljs-string">'CONNCLOSE'</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($type === <span class="hljs-string"><span class="hljs-string">'CONNCLOSE'</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($cb !== <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { $cb(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } } <span class="hljs-comment"><span class="hljs-comment">// Binary $type = $this-&gt;get_frame_type($type); if (($type &amp; self::BINARY) === self::BINARY) { $n = strlen($data); $len = ''; $pos = 0; char: ++$pos; $c = $n &gt;&gt; 0 &amp; 0x7F; $n &gt;&gt;= 7; if ($pos !== 1) { $c += 0x80; } if ($c !== 0x80) { $len = chr($c) . $len; goto char; }; $this-&gt;write(chr(self::BINARY) . $len . $data); } // String else { $this-&gt;write(chr(self::STRING) . $data . "\xFF"); } if ($cb !== null) { $cb(); } return true; } /** * Called when new data received * @return void */ public function on_read() { while (($buflen = strlen($this-&gt;unparsed_data)) &gt;= 2) { $hdr = $this-&gt;look(10); $frametype = ord(substr($hdr, 0, 1)); if (($frametype &amp; 0x80) === 0x80) { $len = 0; $i = 0; do { if ($buflen &lt; $i + 1) { return; } $b = ord(substr($hdr, ++$i, 1)); $n = $b &amp; 0x7F; $len *= 0x80; $len += $n; } while ($b &gt; 0x80); if (self::maxAllowedPacket &lt;= $len) { // Too big packet $this-&gt;close(); return; } if ($buflen &lt; $len + $i + 1) { // not enough data yet return; } $this-&gt;drain($i + 1); $this-&gt;on_frame($this-&gt;read($len), $frametype); } else { if (($p = $this-&gt;search("\xFF")) !== false) { if (self::maxAllowedPacket &lt;= $p - 1) { // Too big packet $this-&gt;close(); return; } $this-&gt;drain(1); $data = $this-&gt;read($p); $this-&gt;drain(1); $this-&gt;on_frame($data, 'STRING'); } else { if (self::maxAllowedPacket &lt; $buflen - 1) { // Too big packet $this-&gt;close(); return; } } } } } }</span></span></code>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
     </pre>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    </div></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VEプロトコルはまだテストされていないことに注意してください-誰がそれを使用するのかわかりません。</font><font style="vertical-align: inherit;">しかし、PhpDeamonからコードを忠実に変換してカットしました。</font></font>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V13プロトコルは、すべての通常のブラウザー（FireFox、Opera、Chrome、Yandex）で使用されます。</font><font style="vertical-align: inherit;">IEでも使用します（IE6以降、申し訳ありませんが、IEが「ブラウザ」になることはありません。IE開発チームでさえ、「ブラウザではなくシンクライアント」と述べています）。</font><font style="vertical-align: inherit;">V0プロトコルはSafariブラウザーを使用します。</font></font>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4> 結論の代わりに </h4>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <font style="vertical-align: inherit;"><font style="vertical-align: inherit;">注意してください、健康のために上記のすべてのコードを使用してください（もちろん、通常のオブジェクトにラップすることをお勧めします。すべてが理解のために単純化されています。</font><font style="vertical-align: inherit;">このコードを使用する場合は、「Thanks Anlide and PhpDeamon」というコードのどこかに書いてください。</font><font style="vertical-align: inherit;">その結果、ここに示されているソケットサーバーは、すべての最新のブラウザーと互換性があります。</font><font style="vertical-align: inherit;">メモリリークなしで動作し、負荷の高いシステムでの使用に適しています。</font></font>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">更新</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">記事の著者のコメント。私はテキストで常に言及しています：</font></font><a href="https://habrahabr.ru/post/301822/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">habrahabr.ru/post/301822/#comment_9634636</font></font></a> </li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> read_lint（）メソッドにはエラーが含まれています。これは、ヘッダーのみを読み取る必要があるにもかかわらず、httpリクエスト本文の本文を読み取っているということです。 </font></font></li><li>     —       . </li><li>       gitbub <a href="https://github.com/anlide/websocket">github.com/anlide/websocket</a>      ping-pong ,         select  - —         websocket. </li></ul></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../J30181/index.html">角が丸い半透明ブロック</a></li>
<li><a href="../J301810/index.html">ギガビットスクイージング：またはViPNet Client / Coordinatorの文書化されていない機能</a></li>
<li><a href="../J301812/index.html">KitchenCIを使用してSaltStackでプロジェクトをテストする</a></li>
<li><a href="../J301814/index.html">ロシアのITスペシャリストの選び方：神話2、3</a></li>
<li><a href="../J301820/index.html">中国語のPostgresまたはPostgresで中国語の全文検索を設定する</a></li>
<li><a href="../J301826/index.html">Dropboxがオペレーティングシステムのカーネルに埋め込まれている理由を説明しました</a></li>
<li><a href="../J301828/index.html">DevConf :: Hii by Yii at TASS June 18-19、2016</a></li>
<li><a href="../J301830/index.html">掲示板としての天井時計の使用</a></li>
<li><a href="../J301834/index.html">セマンティックギャップ「セマンティックギャップ」</a></li>
<li><a href="../J301836/index.html">ポケットの中のスペース：実験の結果</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter70218013 = new Ya.Metrika({
                  id:70218013,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/70218013" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'G-FEDBM7F51Q', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Clever Geek | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <div class="company-info js-company-info" itemscope="" itemtype="http://schema.org/Organization">
      <span itemprop="name">Western Town Media (WTM)</span>
      <div itemprop="address" itemscope="" itemtype="http://schema.org/PostalAddress">
        <span itemprop="streetAddress">1968 Stoney Lonesome Road</span>
        <br>
        <span itemprop="postalCode">PA 18640</span>
        <span itemprop="addressLocality">Pittston, USA</span>
      </div>
      <span itemprop="telephone">570-362-1316</span>
    </div>
    <script type="application/ld+json">
      {
        "@context": "http://schema.org",
        "@type": "Organization",
        "address": {
          "@type": "PostalAddress",
          "addressLocality": "Pittston, USA",
          "postalCode": "PA 18640",
          "streetAddress": "1968 Stoney Lonesome Road"
        },
        "name": "Western Town Media (WTM)",
        "telephone": "570-362-1316"
      }
    </script>
  </div>
</footer>
  
</body>

</html>