<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-FEDBM7F51Q"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-FEDBM7F51Q');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🍏 🕴🏽 🎅🏻 Mikrotik：バックアップインターネットチャネルに切り替えるスクリプト 👈🏾 💠 🧘🏼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="メインのインターネットが消えたときにバックアップインターネットに切り替え、メインのインターネットが再び機能し始めたらすぐに戻るためのスクリプトを共有したいと思います。 チャネルは一度に1つずつ使用可能で、ここでは負荷分散が行われないことをすぐに言わなければなりません。 両方のチャネルはPPP接続です...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="sitemap" type="application/xml" href="/sitemap.xml"/>

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

  <script>document.write('<script src="https://pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://tech-in-japan.github.io/index.html"></a>
    <div class="page-header-text">Clever Geek Handbook</div>
  </header>
  <section class="page js-page"><h1>Mikrotik：バックアップインターネットチャネルに切り替えるスクリプト</h1><div class="post__text post__text-html js-mediator-article" id="post-content-body"> メインのインターネットが消えたときにバックアップインターネットに切り替え、メインのインターネットが再び機能し始めたらすぐに戻るためのスクリプトを共有したいと思います。 チャネルは一度に1つずつ使用可能で、ここでは負荷分散が行われないことをすぐに言わなければなりません。 両方のチャネルはPPP接続です（私の場合、1つは有線で、2つ目は3Gホイッスルです）。 スクリプトは最も柔軟な監視ツールとして特別に作成されました。他のオプション、特にチェックゲートウェイは、私にとって完全に正しいわけではないからです。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     基本的な原則は単純です。VPNチャネルを上げても、インターネットがそれを介して機能することを意味するわけではありません。 いくつかの外部アドレスにpingを送信して確認します。  pingが作業の指標ではない場合に思い付くことができますが、スクリプトでは、状況に応じて他の検証方法を指定できます。 その他の機能：バックアップチャネルはモバイルネットワークであり、メインチャネルがない場合にのみ接続し、それ以外の時間はインターフェイスがオフになります。 メインチャネルに戻ると、その操作性が正しくチェックされます。 インターフェイスを使用したpingとは異なる手法。 さて、インターフェイスのルート距離は動的に変化し、常に等しくないため、チャネルが同時に機能することは可能ですが、トラフィックはそのうちの1つにのみ向けられます。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     理解してください。プロバイダーまたはプロバイダーのいずれかが静的を提供する場合、スクリプトを簡単にやり直すことができます。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     したがって、スクリプトが機能するために必要な設定を一貫して説明し、次に作業の主要なポイントを細かく説明します。 最後はスクリプト全体です。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      ISP1（メイン）とISP2（バックアップ）の2つのPPP接続があるとします。両方とも設定され、別々に動作します。  <i>dial-on-demand = no</i>および<i>add-default-route = yesをそれら</i>に設定し、ISP2の<i>default-route-distance</i>パラメーターをISP1よりも1つ多く設定し<i>ます</i> 。  NATなどの標準的なものを設定し、リクエストの送信元と同じインターフェイス上で応答用のパケットと接続をマークし、マークされたパケットのルートを設定します。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div class="spoiler">  <b class="spoiler_title">準備する</b> <div class="spoiler_text"><pre><code class="bash hljs">/ip firewall mangle add action=mark-connection chain=forward connection-mark=no-mark \ <span class="hljs-keyword"><span class="hljs-keyword">in</span></span>-interface=ISP1 new-connection-mark=ISP1 passthrough=no add action=mark-routing chain=prerouting connection-mark=ISP1 <span class="hljs-keyword"><span class="hljs-keyword">in</span></span>-interface=\ bridge-local new-routing-mark=to_ISP1 passthrough=no add action=mark-connection chain=forward connection-mark=no-mark \ <span class="hljs-keyword"><span class="hljs-keyword">in</span></span>-interface=ISP2 new-connection-mark=ISP2 passthrough=no add action=mark-routing chain=prerouting connection-mark=ISP2 <span class="hljs-keyword"><span class="hljs-keyword">in</span></span>-interface=\ bridge-local new-routing-mark=to_ISP2 passthrough=no /ip firewall nat add action=masquerade chain=srcnat out-interface=ISP1 add action=masquerade chain=srcnat out-interface=ISP2 /ip route add distance=1 gateway=ISP1 routing-mark=to_ISP1 add distance=1 gateway=ISP2 routing-mark=to_ISP2</code>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
     </pre> </div></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     また、ルーターのローカルアドレスは192.168.xx.yy、サブネットは192.168.xx.0 / 24であると想定しています。 このデータは、インターフェースの名前と同様に、独自のものに変更する必要があります。 これは全体のセットアップではなく、すべての順序についてです。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div class="spoiler">  <b class="spoiler_title">変数</b> <div class="spoiler_text"><pre> <code class="bash hljs">global FailoverTimes; global FailoverLastTime; global FailoverLastBackTime; <span class="hljs-built_in"><span class="hljs-built_in">local</span></span> ifMain <span class="hljs-string"><span class="hljs-string">"ISP1"</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">local</span></span> ifRes <span class="hljs-string"><span class="hljs-string">"ISP2"</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">local</span></span> scriptName <span class="hljs-string"><span class="hljs-string">"Failover"</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">local</span></span> state 0; <span class="hljs-built_in"><span class="hljs-built_in">local</span></span> pingNum 0; <span class="hljs-built_in"><span class="hljs-built_in">local</span></span> pingRes; <span class="hljs-built_in"><span class="hljs-built_in">local</span></span> routeDist; <span class="hljs-built_in"><span class="hljs-built_in">local</span></span> routeDist2; <span class="hljs-built_in"><span class="hljs-built_in">local</span></span> tmp; <span class="hljs-built_in"><span class="hljs-built_in">local</span></span> ip { xxxx; yyyy; zzzz }; <span class="hljs-built_in"><span class="hljs-built_in">local</span></span> pingSrcAddr 192.168.xx.yy;</code>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
     </pre></div></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     変数を定義します： <i>ifMain</i>および<i>ifResに</i>インターフェイスの名前を書き込み、 <i>pingSrcAddr</i>にルーターのローカルアドレス（必要な理由は後で明らかになります）、および<i>ip</i>配列のチャネルをチェックするためにpingする3つの外部アドレスを書き込みます。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div class="spoiler">  <b class="spoiler_title">単一インスタンス</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( [len [/system script job find <span class="hljs-built_in"><span class="hljs-built_in">where</span></span> script=<span class="hljs-variable"><span class="hljs-variable">$scriptName</span></span>]] &gt; 1) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>= { error <span class="hljs-string"><span class="hljs-string">"single instance"</span></span> }; delay 15;</code>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
     </pre></div></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     スクリプトのコピーを1つだけ実行します。  RouterOSの開始時に起動する場合は、接続を確立する時間を与えてください。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     少しスキップして、主要部分に移りましょう。 スクリプトは、停止するかエラーが発生するまで無限に実行されます。 無限ループでは、 <i>状態</i>変数を使用して現在の状態を分析し、必要なアクションを実行します。 それらを考慮してください。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div class="spoiler">  <b class="spoiler_title">状態0</b> <div class="spoiler_text"><pre> <code class="bash hljs"> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$state</span></span> = 0) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>= { <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$pingNum</span></span> &gt;= 3) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>= { <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$pingNum</span></span> 0; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ([ping (<span class="hljs-variable"><span class="hljs-variable">$ip</span></span>-&gt;<span class="hljs-variable"><span class="hljs-variable">$pingNum</span></span>) count=1] = 0) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>= { <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$pingRes</span></span> [ping (<span class="hljs-variable"><span class="hljs-variable">$ip</span></span>-&gt;0) count=2]; <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$pingRes</span></span> (<span class="hljs-variable"><span class="hljs-variable">$pingRes</span></span>+[ping (<span class="hljs-variable"><span class="hljs-variable">$ip</span></span>-&gt;1) count=2]); <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$pingRes</span></span> (<span class="hljs-variable"><span class="hljs-variable">$pingRes</span></span>+[ping (<span class="hljs-variable"><span class="hljs-variable">$ip</span></span>-&gt;2) count=2]); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$pingRes</span></span> = 0) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>= { <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$FailoverLastTime</span></span> <span class="hljs-string"><span class="hljs-string">"$[/system clock get date] $[/system clock get time]"</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$FailoverTimes</span></span> ([tonum <span class="hljs-variable"><span class="hljs-variable">$FailoverTimes</span></span>] + 1) <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$state</span></span> 1; <span class="hljs-built_in"><span class="hljs-built_in">log</span></span> info <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$scriptName</span></span></span><span class="hljs-string">: state changed 0-&gt;1"</span></span>; } } <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$pingNum</span></span> (<span class="hljs-variable"><span class="hljs-variable">$pingNum</span></span> + 1); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$state</span></span> = 0) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>= { delay 15 }; } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-variable"><span class="hljs-variable">$state</span></span> = 0); }</code>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
     </pre></div></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     状態0-メインチャネルが機能しているとき。  15秒ごとに1回、指定された3つのアドレスの1つを順番にチェックし、回答がない場合は3つのアドレスすべてをチェックします。 聴覚障害者-バックアップチャネルへの移行を開始します。 配列内のアドレスは3であることが厳密に示されています。そうでない場合は、修正する必要があります。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div class="spoiler">  <b class="spoiler_title">状態1</b> <div class="spoiler_text"><pre> <code class="bash hljs"> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$state</span></span> = 1) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>= { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( [/interface l2tp-client get <span class="hljs-variable"><span class="hljs-variable">$ifMain</span></span> default-route-distance] &gt; 10) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>= { /interface ppp-client <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$ifRes</span></span> default-route-distance=1; } /interface <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span> <span class="hljs-variable"><span class="hljs-variable">$ifRes</span></span>; beep frequency=2000 length=250ms; delay 500ms; beep frequency=2000 length=250ms; delay 500ms; delay 6; /interface <span class="hljs-built_in"><span class="hljs-built_in">disable</span></span> <span class="hljs-variable"><span class="hljs-variable">$ifMain</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$routeDist</span></span> ([/interface ppp-client get <span class="hljs-variable"><span class="hljs-variable">$ifRes</span></span> default-route-distance] + 1); /interface l2tp-client <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$ifMain</span></span> default-route-distance=<span class="hljs-variable"><span class="hljs-variable">$routeDist</span></span>; /interface <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span> <span class="hljs-variable"><span class="hljs-variable">$ifMain</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$state</span></span> 2; <span class="hljs-built_in"><span class="hljs-built_in">log</span></span> info <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$scriptName</span></span></span><span class="hljs-string">: state changed 1-&gt;2"</span></span>; }</code>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
     </pre></div></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     状態1-チャネルの切り替え。 どの特定のPPP接続が使用されるかが重要です。 この例では、ISP1はl2tp-clientであり、ISP2はppp-clientです。 他の場合は、 <i>default-route-distanceの</i>行でそれらを修正する必要があり<i>ます</i> 。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     バックアップチャネルをオンにした後、7秒間待機します。 これは私にとって十分な時間であり、その間に3G接続が立ち上がります。 この間、現在の接続と新しい接続はタイムアウトでハングしますが、メインVPNはまだ切断されておらず、宛先到達不能ルーターの応答は最小限に抑えられます。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     アマチュア向けのサウンド表示は、夜間に動作する場合があります。 そうでない場合は、削除します。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     さらに、メインチャネルはオフになり、その<i>デフォルトルート距離は</i>バックアップチャネルより1大きく設定され、再びオンになります。 このため、予約を介してインターネットに干渉することなく、メインチャネルの復帰を待つことができます。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     今後、メインチャネルに切り替えて予約を切断すると、 <i>デフォルトルート距離</i>が1ずつ増加します。ルート距離を切り替えるたびに、PPP接続が順次増加します。 それらが行き過ぎないようにするために、ここで現在の値がチェックされ、10を超えると1のリセットが発生します（たとえば、理論的には最大約250）。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div class="spoiler">  <b class="spoiler_title">状態2</b> <div class="spoiler_text"><pre> <code class="bash hljs"> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$state</span></span> = 2) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>= { <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( [len [interface find <span class="hljs-built_in"><span class="hljs-built_in">where</span></span> name=<span class="hljs-variable"><span class="hljs-variable">$ifMain</span></span> and running] ] = 1) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>= { <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$pingRes</span></span> [ping (<span class="hljs-variable"><span class="hljs-variable">$ip</span></span>-&gt;0) src-address=<span class="hljs-variable"><span class="hljs-variable">$pingSrcAddr</span></span> count=2]; <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$pingRes</span></span> (<span class="hljs-variable"><span class="hljs-variable">$pingRes</span></span>+[ping (<span class="hljs-variable"><span class="hljs-variable">$ip</span></span>-&gt;1) src-address=<span class="hljs-variable"><span class="hljs-variable">$pingSrcAddr</span></span> count=2]); <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$pingRes</span></span> (<span class="hljs-variable"><span class="hljs-variable">$pingRes</span></span>+[ping (<span class="hljs-variable"><span class="hljs-variable">$ip</span></span>-&gt;2) src-address=<span class="hljs-variable"><span class="hljs-variable">$pingSrcAddr</span></span> count=2]); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$pingRes</span></span> &gt; 0) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>= { <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$state</span></span> 3; <span class="hljs-built_in"><span class="hljs-built_in">log</span></span> info <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$scriptName</span></span></span><span class="hljs-string">: state changed 2-&gt;3"</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$state</span></span> = 2) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>= { delay 15 }; } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-variable"><span class="hljs-variable">$state</span></span> = 2); }</code>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
     </pre></div></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     状態2-メインチャネルの復元を待機しています。 保護区の状態がおもしろくないことは注目に値します。 彼が接続しなかった場合、何もすることはなく、彼のためのすべての条件が作成されます。実際、私たちはメインチャンネルにのみ興味があります。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     ここでは、メインチャネルのVPNが引き上げられることが予想され、その後、アクティブな予約を使用して外部アドレスへのpingが試行されます。 それは難しくなりますが、正しいです。  <i>ping xx.xx.xx.xx interface = $ ifMain</i>を記述した場合、開発者によると、これは機能する場合と機能しない場合があります。 ここで、pingはルーターのローカルアドレスから使用されます。 それは常にそこにあると仮定され、そうでなければルーターが必要です。 プロバイダーが動的に提供するため、メインチャネルの外部アドレスは使用しませんでした。 ルートが非アクティブ（ルート距離がバックアップよりも大きい）場合でも、メインチャネルを介してこのようなpingを送信するようにルーターに指示する方法を見つけます。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div class="spoiler">  <b class="spoiler_title">チューニング</b> <div class="spoiler_text"><pre> <code class="bash hljs">/ip firewall mangle add action=mark-routing chain=output comment=Failover_script_rule \ dst-address=!192.168.xx.0/24 new-routing-mark=to_ISP1 passthrough=no \ protocol=icmp src-address=192.168.xx.yy /ip route rule add action=lookup-only-in-table routing-mark=to_ISP1 src-address=\ 192.168.xx.yy/32 table=to_ISP1</code>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
     </pre></div></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     ここで使用されるpingトラフィックは非標準です。 これは、ルーター自体から外部アドレスへの出力トラフィックです。 通常、このような場合、ルーターはパケットが<i>src-addressに</i>向かうインターフェースのアドレスを取得し<i>ます</i> 。 ルーターのローカルアドレスを<i>src-address</i>として指定することにより、lokalkaが座っているのと同じNATに対してそれを取り出すように見えます。 さらに、このようなトラフィックはメインチャネルの<i>ルーティングマークで</i>タグ付けされ、パケットはラベル付きのルートのためにメインチャネルを通過します。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      2番目のルールも必要です。 これがないと、メインチャンネルが突然再び落ちた場合、 <i>to_ISP1</i>とマークされたpingでも、バックアップチャンネルラベルなしでルートに沿って移動し、メインチャンネルに正しく戻りません。 これは、RouterOSがどのように機能するかです。チャネルが接続されていない場合、ルートはマークされていても無効になります。 少し明確にするために、 <i>状態</i> = 2を想定し<i>ます。</i>メインチャネルはアップしていますが、トラフィックは通過しません。 この場合、pingに6秒かかります。 したがって、この時点でメインチャネルがオフになっている場合、pingはリザーブを通過し始めます。  2番目のルールはこれを除外します。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     ルーターからLANへのpingはマークされておらず、通常どおり動作することに注意してください。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div class="spoiler">  <b class="spoiler_title">状態3</b> <div class="spoiler_text"><pre> <code class="bash hljs"> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$state</span></span> = 3) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>= { /interface <span class="hljs-built_in"><span class="hljs-built_in">disable</span></span> <span class="hljs-variable"><span class="hljs-variable">$ifRes</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$routeDist</span></span> ([/interface l2tp-client get <span class="hljs-variable"><span class="hljs-variable">$ifMain</span></span> default-route-distance] + 1); /interface ppp-client <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$ifRes</span></span> default-route-distance=<span class="hljs-variable"><span class="hljs-variable">$routeDist</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$state</span></span> 0; <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$FailoverLastBackTime</span></span> <span class="hljs-string"><span class="hljs-string">"$[/system clock get date] $[/system clock get time]"</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">log</span></span> info <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$scriptName</span></span></span><span class="hljs-string">: state changed 3-&gt;0"</span></span>; beep frequency=500 length=500ms; }</code>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
     </pre></div></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     状態3-メインチャネルへの移行。  pingがメインチャネルを通過し始めたら、バックアップVPNをオフにするだけで、メインVPNが使用されます。 次に、バックアップの<i>default-route-distanceを</i>メインよりも1大きく変更し、音声信号を送ります。  PPP接続のタイプに注意を払い、必要に応じて変更します。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     この時点で、サイクルは閉じて状態0に戻ります。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     ここで、スクリプトを実行するときに、現在の状態を確認する方法について説明します。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div class="spoiler">  <b class="spoiler_title">初期状態</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$routeDist</span></span> [/interface l2tp-client get <span class="hljs-variable"><span class="hljs-variable">$ifMain</span></span> default-route-distance]; <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$routeDist2</span></span> [/interface ppp-client get <span class="hljs-variable"><span class="hljs-variable">$ifRes</span></span> default-route-distance]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$routeDist</span></span> &lt; <span class="hljs-variable"><span class="hljs-variable">$routeDist2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>= { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( [/interface get <span class="hljs-variable"><span class="hljs-variable">$ifMain</span></span> running] = <span class="hljs-literal"><span class="hljs-literal">true</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>= { <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$state</span></span> 0; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>= { <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$state</span></span> 1; } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>= { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( [/interface get <span class="hljs-variable"><span class="hljs-variable">$ifMain</span></span> disabled] = <span class="hljs-literal"><span class="hljs-literal">true</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>= { /interface <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span> <span class="hljs-variable"><span class="hljs-variable">$ifMain</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$routeDist</span></span> &gt; <span class="hljs-variable"><span class="hljs-variable">$routeDist2</span></span> and [/interface get <span class="hljs-variable"><span class="hljs-variable">$ifRes</span></span> disabled] = <span class="hljs-literal"><span class="hljs-literal">false</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>= { <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$state</span></span> 2; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>= { <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$state</span></span> 3; } } <span class="hljs-built_in"><span class="hljs-built_in">log</span></span> info <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$scriptName</span></span></span><span class="hljs-string">: initial state </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$state</span></span></span><span class="hljs-string">"</span></span>;</code>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
     </pre></div></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     ここでは、ロジックも一見複雑です。  ISP1が実行されているかどうか、ISP2が実行されているかどうか、およびデフォルトのルート距離関係を持つ3つのパラメーターが分析されます。 初期状態1および3は非標準であり、構成が正しくないことを示していますが、この場合、不必要な切り替えによっても、スクリプト自体がすべてを復元します。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div class="spoiler">  <b class="spoiler_title">除外条件</b> <div class="spoiler_text"> 除外した条件がもう1つあります。 ほとんどの場合、ほとんどの人にはほとんど必要ありません。 私のISP1は、IPではなく名前でVPNを接続してこの名前を解決するために、同じプロバイダーのDNSを使用する必要があります。 ローカルアドレスに解決されます。 また、特定のDNSを示す解決でスクリプトを支援しない場合、ISP1ネットワークが利用可能になった後でも、接続しません。 ドメイン名は解決されませんが、DNSリザーブは引き続き使用されます。 これは余分です。 状態： 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> <code class="bash hljs"> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$state</span></span> = 2) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>= { <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (([ping DNSip1 count=1] &gt; 0) or ([ping DNSip2 count=1] &gt; 0)) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>= { <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$tmp</span></span> 0; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { resolve VPNaddress server=DNSip1; } on-error= { }; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { resolve VPNaddress server=DNSip2; } on-error= { }; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { resolve VPNaddress } on-error= { <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$tmp</span></span> 1; }; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$tmp</span></span> = 0) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>= { <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$state</span></span> 3; <span class="hljs-built_in"><span class="hljs-built_in">log</span></span> info <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$scriptName</span></span></span><span class="hljs-string">: state changed 2-&gt;3"</span></span>; delay 5; } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$state</span></span> = 2) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>= { delay 15 }; } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-variable"><span class="hljs-variable">$state</span></span> = 2); }</code>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
     </pre>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      DNSip1、DNSip2、VPNaddressの代わりに、必要なデータを置き換えます。 以下のすべての状態は、それぞれ+1シフトします。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    </div></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     これは基本的にすべて、6.26およびRB951G-2HnDで開発およびデバッグされています。 他のバージョンでは-私は約束しません、そしてチームの前に '：'がないことを残念に思います。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     私の構成では、このスクリプトと組み合わせて、1分に1回、スケジュールに従って実行される別のスクリプトが機能します。 彼は、このスクリプトが実行されているかどうかを確認し、変更されたときにメールでIPアドレスをさらに送信します。 これは小さな例ですが、最初の部分のみです： 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div class="spoiler">  <b class="spoiler_title">スクリプトモニター</b> <div class="spoiler_text"><pre> <code class="bash hljs">global FailoverDisabled; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( [len [/system script job find <span class="hljs-built_in"><span class="hljs-built_in">where</span></span> script=<span class="hljs-string"><span class="hljs-string">"Failover"</span></span>]] = 0 and <span class="hljs-variable"><span class="hljs-variable">$FailoverDisabled</span></span> != 1) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>= { <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { execute script=<span class="hljs-string"><span class="hljs-string">"Failover"</span></span>; } on-error= { <span class="hljs-built_in"><span class="hljs-built_in">log</span></span> info <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$scriptName</span></span></span><span class="hljs-string">: Failed to execute Failover"</span></span> }; }</code>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
     </pre></div></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     グローバル変数は、フェールオーバースクリプトの起動を無効にすることができます。 また、スケジュールにより、ルーターが予期せず再起動した場合、スクリプトは自動的に再起動されます。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div class="spoiler">  <b class="spoiler_title">フェールオーバースクリプト全体</b> <div class="spoiler_text"><pre> <code class="bash hljs">global FailoverTimes; global FailoverLastTime; global FailoverLastBackTime; <span class="hljs-built_in"><span class="hljs-built_in">local</span></span> ifMain <span class="hljs-string"><span class="hljs-string">"ISP1"</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">local</span></span> ifRes <span class="hljs-string"><span class="hljs-string">"ISP2"</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">local</span></span> scriptName <span class="hljs-string"><span class="hljs-string">"Failover"</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">local</span></span> state 0; <span class="hljs-built_in"><span class="hljs-built_in">local</span></span> pingNum 0; <span class="hljs-built_in"><span class="hljs-built_in">local</span></span> pingRes; <span class="hljs-built_in"><span class="hljs-built_in">local</span></span> routeDist; <span class="hljs-built_in"><span class="hljs-built_in">local</span></span> routeDist2; <span class="hljs-built_in"><span class="hljs-built_in">local</span></span> tmp; <span class="hljs-built_in"><span class="hljs-built_in">local</span></span> ip { xxxx; yyyy; zzzz }; <span class="hljs-built_in"><span class="hljs-built_in">local</span></span> pingSrcAddr 192.168.xx.yy; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( [len [/system script job find <span class="hljs-built_in"><span class="hljs-built_in">where</span></span> script=<span class="hljs-variable"><span class="hljs-variable">$scriptName</span></span>]] &gt; 1) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>= { error <span class="hljs-string"><span class="hljs-string">"single instance"</span></span> }; delay 15; <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$routeDist</span></span> [/interface l2tp-client get <span class="hljs-variable"><span class="hljs-variable">$ifMain</span></span> default-route-distance]; <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$routeDist2</span></span> [/interface ppp-client get <span class="hljs-variable"><span class="hljs-variable">$ifRes</span></span> default-route-distance]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$routeDist</span></span> &lt; <span class="hljs-variable"><span class="hljs-variable">$routeDist2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>= { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( [/interface get <span class="hljs-variable"><span class="hljs-variable">$ifMain</span></span> running] = <span class="hljs-literal"><span class="hljs-literal">true</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>= { <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$state</span></span> 0; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>= { <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$state</span></span> 1; } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>= { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( [/interface get <span class="hljs-variable"><span class="hljs-variable">$ifMain</span></span> disabled] = <span class="hljs-literal"><span class="hljs-literal">true</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>= { /interface <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span> <span class="hljs-variable"><span class="hljs-variable">$ifMain</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$routeDist</span></span> &gt; <span class="hljs-variable"><span class="hljs-variable">$routeDist2</span></span> and [/interface get <span class="hljs-variable"><span class="hljs-variable">$ifRes</span></span> disabled] = <span class="hljs-literal"><span class="hljs-literal">false</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>= { <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$state</span></span> 2; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>= { <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$state</span></span> 3; } } <span class="hljs-built_in"><span class="hljs-built_in">log</span></span> info <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$scriptName</span></span></span><span class="hljs-string">: initial state </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$state</span></span></span><span class="hljs-string">"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$state</span></span> = 0) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>= { <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$pingNum</span></span> &gt;= 3) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>= { <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$pingNum</span></span> 0; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ([ping (<span class="hljs-variable"><span class="hljs-variable">$ip</span></span>-&gt;<span class="hljs-variable"><span class="hljs-variable">$pingNum</span></span>) count=1] = 0) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>= { <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$pingRes</span></span> [ping (<span class="hljs-variable"><span class="hljs-variable">$ip</span></span>-&gt;0) count=2]; <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$pingRes</span></span> (<span class="hljs-variable"><span class="hljs-variable">$pingRes</span></span>+[ping (<span class="hljs-variable"><span class="hljs-variable">$ip</span></span>-&gt;1) count=2]); <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$pingRes</span></span> (<span class="hljs-variable"><span class="hljs-variable">$pingRes</span></span>+[ping (<span class="hljs-variable"><span class="hljs-variable">$ip</span></span>-&gt;2) count=2]); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$pingRes</span></span> = 0) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>= { <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$FailoverLastTime</span></span> <span class="hljs-string"><span class="hljs-string">"$[/system clock get date] $[/system clock get time]"</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$FailoverTimes</span></span> ([tonum <span class="hljs-variable"><span class="hljs-variable">$FailoverTimes</span></span>] + 1) <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$state</span></span> 1; <span class="hljs-built_in"><span class="hljs-built_in">log</span></span> info <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$scriptName</span></span></span><span class="hljs-string">: state changed 0-&gt;1"</span></span>; } } <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$pingNum</span></span> (<span class="hljs-variable"><span class="hljs-variable">$pingNum</span></span> + 1); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$state</span></span> = 0) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>= { delay 15 }; } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-variable"><span class="hljs-variable">$state</span></span> = 0); } <span class="hljs-comment"><span class="hljs-comment"># endof if state = 0 if ($state = 1) do= { if ( [/interface l2tp-client get $ifMain default-route-distance] &gt; 10) do= { /interface ppp-client set $ifRes default-route-distance=1; } /interface enable $ifRes; beep frequency=2000 length=250ms; delay 500ms; beep frequency=2000 length=250ms; delay 500ms; delay 6; /interface disable $ifMain; set $routeDist ([/interface ppp-client get $ifRes default-route-distance] + 1); /interface l2tp-client set $ifMain default-route-distance=$routeDist; /interface enable $ifMain; set $state 2; log info "$scriptName: state changed 1-&gt;2"; } if ($state = 2) do= { do { if ( [len [interface find where name=$ifMain and running] ] = 1) do= { set $pingRes [ping ($ip-&gt;0) src-address=$pingSrcAddr count=2]; set $pingRes ($pingRes+[ping ($ip-&gt;1) src-address=$pingSrcAddr count=2]); set $pingRes ($pingRes+[ping ($ip-&gt;2) src-address=$pingSrcAddr count=2]); if ($pingRes &gt; 0) do= { set $state 3; log info "$scriptName: state changed 2-&gt;3"; } } if ($state = 2) do= { delay 15 }; } while ($state = 2); } # endof if state = 2 if ($state = 3) do= { /interface disable $ifRes; set $routeDist ([/interface l2tp-client get $ifMain default-route-distance] + 1); /interface ppp-client set $ifRes default-route-distance=$routeDist; set $state 0; set $FailoverLastBackTime "$[/system clock get date] $[/system clock get time]"; log info "$scriptName: state changed 3-&gt;0"; beep frequency=500 length=500ms; } # bad programming protection delay 1; } while= ( true );</span></span></code>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
     </pre></div></div></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../J252713/index.html">ハースストーンでの楽しい数学</a></li>
<li><a href="../J252717/index.html">HPハイパーコンバージド仮想化プラットフォーム</a></li>
<li><a href="../J252721/index.html">セマンティックマークアップの使用方法</a></li>
<li><a href="../J252725/index.html">Skype検閲</a></li>
<li><a href="../J252727/index.html">ブラウザーにトースト通知</a></li>
<li><a href="../J25273/index.html">天文学におけるクラウドソーシング：銀河の分類</a></li>
<li><a href="../J252731/index.html">Microsoft Azure RemoteAppに基づいたVDIの手間なし</a></li>
<li><a href="../J252733/index.html">アスタリスク：発信者IDと地域コードによるルーティング</a></li>
<li><a href="../J252737/index.html">Xpom-Xpum！ SDK-Google Chrome拡張機能とアプリケーション用のIDE</a></li>
<li><a href="../J252741/index.html">RFC2544標準テスト</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter70218013 = new Ya.Metrika({
                  id:70218013,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/70218013" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'G-FEDBM7F51Q', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Clever Geek | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <div class="company-info js-company-info" itemscope="" itemtype="http://schema.org/Organization">
      <span itemprop="name">Western Town Media (WTM)</span>
      <div itemprop="address" itemscope="" itemtype="http://schema.org/PostalAddress">
        <span itemprop="streetAddress">1968 Stoney Lonesome Road</span>
        <br>
        <span itemprop="postalCode">PA 18640</span>
        <span itemprop="addressLocality">Pittston, USA</span>
      </div>
      <span itemprop="telephone">570-362-1316</span>
    </div>
    <script type="application/ld+json">
      {
        "@context": "http://schema.org",
        "@type": "Organization",
        "address": {
          "@type": "PostalAddress",
          "addressLocality": "Pittston, USA",
          "postalCode": "PA 18640",
          "streetAddress": "1968 Stoney Lonesome Road"
        },
        "name": "Western Town Media (WTM)",
        "telephone": "570-362-1316"
      }
    </script>
  </div>
</footer>
  
</body>

</html>