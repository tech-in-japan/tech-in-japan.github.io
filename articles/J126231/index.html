<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-FEDBM7F51Q"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-FEDBM7F51Q');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>💸 👨🏻‍💻 🥟 EventMachineプロキシデーモン 🦊 🐕 🍕</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="EventMachineは、高性能でスケーラブルなネットワークアプリケーションを作成するための非常に便利なフレームワークであるという事実にもかかわらず、インターネットはその使用とテストの例が豊富にないことに満足していません。 また、たとえばハブに存在するこれらの例は、データ転送の機能を考慮していない...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="sitemap" type="application/xml" href="/sitemap.xml"/>

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

  <script>document.write('<script src="https://pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://tech-in-japan.github.io/index.html"></a>
    <div class="page-header-text">Clever Geek Handbook</div>
  </header>
  <section class="page js-page"><h1>EventMachineプロキシデーモン</h1><div class="post__text post__text-html js-mediator-article" id="post-content-body"> <a href="http://rubyeventmachine.com/">EventMachineは、</a>高性能でスケーラブルなネットワークアプリケーションを作成するための非常に便利なフレームワークであるという事実にもかかわらず、インターネットはその使用とテストの例が豊富にないことに満足していません。 また、たとえばハブに存在するこれらの例は、データ転送の機能を考慮していないため、正しく機能しません（何らかの理由で、データが一般に部分的に送信されることを考慮していないため）。 実際、この記事は、たとえば<a href="http://habrahabr.ru/blogs/ruby/106809/">RubyとEventMachineの記事</a>でEMの基本原則に精通しており、その基礎に基づいてより複雑なものを書く方法と、結果として得られたコードをテストする方法を学びたい人を対象としています。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     最近、彼らは私にテストタスクを送信しました。その本質は、EMでプロキシデーモンを書くことであり、Unixドメインソケットを介してクライアントからの接続を非同期に受け入れ、キューに入れ、これらのコマンドを抽象的なシステムに接続されたソケットにリダイレクトし、受信しますこのシステムからの応答は、それらをクライアントに送り返します。 クライアントメッセージの形式は{id：1、text： "req1"}です。これはサーバーによって応答に変換される必要があります-{id：1、text： "answ1"}。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     タスク、クライアント、および抽象システムを簡素化するために、EMを使用してエミュレートしました。これにより、組み込みのデータ転送プロトコル<a href="http://eventmachine.rubyforge.org/EventMachine/Protocols/ObjectProtocol.html">EM :: P :: ObjectProtocolの</a>使用が許可されました。これは、リアクターの1ティックではなくデータを取得できることを考慮し、送信用にデータをシリアル化します。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     クライアントコードを書くことから始めましょう。 クライアントがプロキシデーモンとの接続を確立すると、 <b>post_init</b>関数が<b>呼び出され</b>ます。この関数では、クライアントは<b>send_object</b>を使用してハッシュメッセージを送信します。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     次に、デーモンからの応答を待ち、コンソールに表示します。 複数のクライアントの接続を一度にエミュレートする必要があるため、接続の数と既に応答を受信して​​デーモンから切断されたクライアントの数に関するデータを保存する変数が導入されました。 接続の合計数は定数<b>TOTAL_CONNECTIONSに</b>格納されます。これは、クライアントの起動時に設定されます。 クライアントがサーバーから切断されると、 <b>バインド解除</b>呼び出しが<b>行われ</b>ます。 すべてのクライアントが応答を受信すると、リアクターは停止します。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     <code><font color="#0000ff">module</font> EMClient&lt;br/&gt; <font color="#0000ff">include</font> EM::P::ObjectProtocol&lt;br/&gt; &lt;br/&gt;  @@connection_number = <font color="#008000">0</font> &lt;br/&gt;  @@dissconnected = <font color="#008000">0</font> &lt;br/&gt; &lt;br/&gt; <font color="#696969">#send request as the connection has been established</font> &lt;br/&gt; <font color="#0000ff">def</font> <font color="#cc6633">post_init</font> &lt;br/&gt;    @@connection_number += <font color="#008000">1</font> &lt;br/&gt;    send_object({ <font color="#008000">'id'</font> =&gt; <font color="#0000ff">rand</font> ( <font color="#008000">10</font> ), <font color="#008000">'text'</font> =&gt; <font color="#008000">"req#{@@connection_number}"</font> })&lt;br/&gt; <font color="#0000ff">end</font> &lt;br/&gt; &lt;br/&gt; &lt;br/&gt; <font color="#0000ff">def</font> <font color="#cc6633">receive_object</font> (obj)&lt;br/&gt; <font color="#696969">#display response from server</font> &lt;br/&gt; <font color="#0000ff">p</font> obj.inspect&lt;br/&gt; <font color="#0000ff">end</font> &lt;br/&gt; &lt;br/&gt; <font color="#0000ff">def</font> <font color="#cc6633">unbind</font> &lt;br/&gt;    @@dissconnected += <font color="#008000">1</font> &lt;br/&gt; <font color="#696969">#stop reactor after all requests have been processed</font> &lt;br/&gt;    EM.stop <font color="#0000ff">if</font> @@dissconnected == TOTAL_CONNECTIONS&lt;br/&gt; <font color="#0000ff">end</font> &lt;br/&gt; <font color="#0000ff">end</font> &lt;br/&gt;</code>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
     
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     次は、抽象システムの動作をエミュレートするサーバーコードです。 そのタスクは、オブジェクトを受け取り、変換して送り返すことです。  <b>EM.add_time（）</b>を使用すると、2番目の引数によって関数に渡されるコードブロック（この場合はデーモンからの要求への応答<b>）</b>の実行を遅延させることができます。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     <code><font color="#0000ff">module</font> SocketServer&lt;br/&gt; <font color="#0000ff">include</font> EM::P::ObjectProtocol&lt;br/&gt; &lt;br/&gt; <font color="#0000ff">def</font> <font color="#cc6633">receive_object</font> (obj)&lt;br/&gt; <font color="#696969">#emulation of job on server</font> &lt;br/&gt;    EM.add_timer( <font color="#008000">1</font> + <font color="#0000ff">rand</font> ( <font color="#008000">5</font> )) <font color="#0000ff">do</font> &lt;br/&gt; <font color="#696969">#validation of obj goes here))</font> &lt;br/&gt;      obj[ <font color="#008000">'text'</font> ]. <font color="#0000ff">sub</font> !(/req/, <font color="#008000">'answ'</font> )&lt;br/&gt;      send_object(obj)&lt;br/&gt; <font color="#0000ff">end</font> &lt;br/&gt; <font color="#0000ff">p</font> <font color="#008000">"Server received object: #{obj.inspect}"</font> &lt;br/&gt; <font color="#0000ff">end</font> &lt;br/&gt; <font color="#0000ff">end</font> &lt;br/&gt;</code>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
     
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     次に、さらに興味深い部分に移り、メッセージ用のメッセージキューと抽象サーバーを備えた接続プールを作成します。 このために、 <a href="http://eventmachine.rubyforge.org/EventMachine/Queue.html">EM :: Queue</a>クラスが使用されました。このクラスには、 <b>pop（* a、＆b）</b>と<b>push（* items）の</b> 2つのメソッドがあり、キューにアイテムを追加してキューから取り出すことができます。  <b>pop</b>メソッドは、要素がキューに表示されるときに実行されるコードのブロックとして最後の引数を取ります。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     サーバーとの接続を確立するために、 <b>EMConnection</b>モジュールが<b>使用され</b>ました。このモジュールでは<b>send_request（obj、＆block）</b>メソッドが定義され、その本質はサーバーメッセージを送信し、サーバーから応答を受信したときに実行されるブロックを送信することでした。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b>ConnectionPool</b>クラスは、接続プールの作成を担当します。 初期化されると、プールサイズが決定され、キューが初期化されます。 次に、指定された接続数が<b>start_queue</b>メソッドに設定され、ワー​​カー（ <b>queue_worker_loop</b> ）が各接続に対して起動されます。これは、接続を引数としてとるprocです。 彼の仕事の本質は、キューから、サーバーに送信する必要があるオブジェクトを表す要素と、オブジェクトの受信後に実行する必要があるコードブロックを取得することです。 さらに、このコードブロックを実行した後、procはそれ自体を呼び出すため、一種の無限ループが取得されます。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     <code><font color="#0000ff">module</font> EMConnection&lt;br/&gt; <font color="#0000ff">include</font> EM::P::ObjectProtocol&lt;br/&gt; &lt;br/&gt; <font color="#0000ff">def</font> <font color="#cc6633">receive_object</font> (obj)&lt;br/&gt; <font color="#696969">#calling callback on object receiving</font> &lt;br/&gt;    @callback. <b>call</b> (obj)&lt;br/&gt; <font color="#0000ff">end</font> &lt;br/&gt; &lt;br/&gt; <font color="#0000ff">def</font> <font color="#cc6633">send_request</font> obj, &amp;block&lt;br/&gt; <font color="#696969">#sending data to server and setting callback</font> &lt;br/&gt;    send_object obj&lt;br/&gt;    @callback = block&lt;br/&gt; <font color="#0000ff">end</font> &lt;br/&gt; &lt;br/&gt; <font color="#0000ff">end</font> &lt;br/&gt; &lt;br/&gt; <font color="#696969">#simple connection pool using EM queue, default size 10</font> &lt;br/&gt; <font color="#0000ff">class</font> <font color="#cc6633">ConnectionPool</font> &lt;br/&gt; &lt;br/&gt; <font color="#0000ff">def</font> <font color="#cc6633">initialize</font> (conf)&lt;br/&gt;    @pool_size = conf[:size] || <font color="#008000">10</font> &lt;br/&gt;    @connections = []&lt;br/&gt;    @query_queue = EM:: <font color="#cc6633">Queue</font> .new&lt;br/&gt; <font color="#cc6633">start_queue</font> conf&lt;br/&gt; <font color="#0000ff">end</font> &lt;br/&gt; &lt;br/&gt; <font color="#0000ff">def</font> <font color="#cc6633">queue_worker_loop</font> &lt;br/&gt; <font color="#0000ff">proc</font> { |connection|&lt;br/&gt;      @query_queue.pop <font color="#0000ff">do</font> | <font color="#cc6633">request</font> |&lt;br/&gt;        connection. <font color="#cc6633">send_request</font> ( <font color="#cc6633">request</font> [:obj]) <font color="#0000ff">do</font> |response|&lt;br/&gt; <font color="#cc6633">request</font> [:callback].call response <font color="#696969">#if request[:callback]</font> &lt;br/&gt; <font color="#cc6633">queue_worker_loop</font> .call connection&lt;br/&gt; <font color="#0000ff">end</font> &lt;br/&gt; <font color="#0000ff">end</font> &lt;br/&gt;    }&lt;br/&gt; <font color="#0000ff">end</font> &lt;br/&gt; &lt;br/&gt; <font color="#0000ff">def</font> <font color="#cc6633">start_queue</font> (conf)&lt;br/&gt;    @pool_size.times <font color="#0000ff">do</font> &lt;br/&gt;      connection = EM.connect( <font color="#008000">'0.0.0.0'</font> , <font color="#008000">8080</font> , EMConnection)&lt;br/&gt;      @connections &lt;&lt; connection&lt;br/&gt; <font color="#cc6633">queue_worker_loop</font> .call connection&lt;br/&gt; <font color="#0000ff">end</font> &lt;br/&gt; <font color="#0000ff">end</font> &lt;br/&gt; &lt;br/&gt; <font color="#0000ff">def</font> <font color="#cc6633">request</font> (obj, &amp;block)&lt;br/&gt;    @query_queue.push :obj =&gt; obj, :callback =&gt; block&lt;br/&gt; <font color="#0000ff">end</font> &lt;br/&gt; <font color="#0000ff">end</font> &lt;br/&gt;</code>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
     
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     次に、プロキシデーモンを担当するコードに移りましょう。 その役割は、接続プールを初期化することです。もちろん、これはデーモンコードではなく行うことができますが、この方法では、プールは必要なときにのみ初期化されます。 オブジェクトをクライアントから受信すると、オブジェクトと接続プールのキューコードブロックを渡し、抽象サーバーから応答を受信すると、メッセージをクライアントに送り返し、 <b>close_connection_after_writing</b>メソッドを使用して接続を閉じます。すぐに接続を閉じます）。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     <code><font color="#0000ff">module</font> DaemonServer&lt;br/&gt; <font color="#0000ff">include</font> EM::P::ObjectProtocol&lt;br/&gt; &lt;br/&gt; <font color="#0000ff">def</font> <font color="#cc6633">post_init</font> &lt;br/&gt;    @@connections_pool ||= ConnectionPool. <b>new</b> (:size =&gt; <font color="#008000">5</font> )&lt;br/&gt; <font color="#0000ff">end</font> &lt;br/&gt; &lt;br/&gt; <font color="#0000ff">def</font> <font color="#cc6633">receive_object</font> (obj)&lt;br/&gt;    @@connections_pool.request obj <font color="#0000ff">do</font> |response|&lt;br/&gt;      send_object(response)&lt;br/&gt;      close_connection_after_writing&lt;br/&gt; <font color="#0000ff">end</font> &lt;br/&gt; <font color="#0000ff">end</font> &lt;br/&gt; <font color="#0000ff">end</font> &lt;br/&gt;</code>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
     
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     次に、サーバー、クライアント、プロキシデーモンの起動を担当するスクリプトに移りましょう。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      TCPSocketでサーバーを起動します。 ここではすべてが非常に簡単です。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     <code>EventMachine.run {&lt;br/&gt;  EventMachine.start_server <font color="#008000">"127.0.0.1"</font> , <font color="#008000">8080</font> , SocketServer&lt;br/&gt;} &lt;br/&gt;</code>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
     
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     エミュレートされたクライアントの数を設定する機会を与える必要があるため、クライアントではもう少し複雑です。これは、スクリプトの実行時にパラメーターを渡すことで実装されます。  Unixドメインソケットでのクライアントの起動は、TCPソケットの場合とは異なります。 <b>接続の</b>代わりに<b>connect_unix_domain</b>を呼び出し、関数の最初の引数としてIPアドレスとポート、ファイル名の代わりに渡します。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     <code>tc = ARGV[ <font color="#008000">0</font> ].to_i&lt;br/&gt;TOTAL_CONNECTIONS = tc &gt; <font color="#008000">0</font> ? tc : <font color="#008000">25</font> &lt;br/&gt; &lt;br/&gt;file = <font color="#cc6633">File</font> .expand_path( <font color="#008000">'../tmp/daemon.sock'</font> , <font color="#0000ff">__FILE__</font> )&lt;br/&gt; <font color="#0000ff">p</font> <font color="#008000">"Starting #{TOTAL_CONNECTIONS} client(s)"</font> &lt;br/&gt;EventMachine::run {&lt;br/&gt;  TOTAL_CONNECTIONS.times{ EM.connect_unix_domain(file, EMClient) }&lt;br/&gt;} &lt;br/&gt;</code>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
     
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     プロキシが悪魔になるには、もちろん、悪魔化（キャプテン）する必要があります。 このために、 <b>デーモン</b> gemを使用しました。 スクリプトが-dスイッチで始まる場合、デーモンを停止できるように、ログとプロセスpidを含むファイルを保存する場所を決定する追加オプションを使用して<b>Daemons.daemonize</b>メソッドを呼び出すと、 <b>スクリプト</b>が悪魔になります。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     <code>options = {&lt;br/&gt;  :app_name =&gt; <font color="#008000">'ProxyServer'</font> ,&lt;br/&gt;  :backtrace =&gt; <font color="#0000ff">true</font> ,&lt;br/&gt;  :log_output =&gt; <font color="#0000ff">true</font> ,&lt;br/&gt;  :dir_mode =&gt; :normal,&lt;br/&gt;  :dir =&gt; <font color="#cc6633">File</font> .expand_path( <font color="#008000">'../tmp'</font> , <font color="#0000ff">__FILE__</font> )&lt;br/&gt;}&lt;br/&gt; &lt;br/&gt;file = <font color="#cc6633">File</font> .expand_path( <font color="#008000">'../tmp/daemon.sock'</font> , <font color="#0000ff">__FILE__</font> )&lt;br/&gt; <font color="#cc6633">File</font> .unlink(file) <font color="#0000ff">if</font> <font color="#cc6633">File</font> .exists?(file)&lt;br/&gt; &lt;br/&gt;Daemons.daemonize(options) <font color="#0000ff">if</font> ARGV.index( <font color="#008000">'-d'</font> )&lt;br/&gt; &lt;br/&gt;EventMachine::run {&lt;br/&gt;  EventMachine::start_unix_domain_server(file, DaemonServer)&lt;br/&gt;} &lt;br/&gt;</code>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
     
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     テストを行わないコードは、たとえそれが動作していてもほとんどコストがかからないと考えています。なぜなら、それを書いた人とそれを編集する必要がある人の両方に多くの問題と頭痛を引き起こす可能性があるからです。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      EM- <a href="https://github.com/tmm1/em-spec">EMSpecに</a>基づいて作成されたプログラムをテストするための既製のソリューションがあります。 しかし、私はそれを使用しなかったので、 <a href="http://rspec.info/">rspec</a>を使用してそれなしで行う方法を示します。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     最初に、テストクライアントを作成する必要があります。 その中で、 <b>send_request（obj、＆block）</b>メソッドを定義します。これにより、プロキシ要求をデーモンに送信し、クライアントが応答を受信したときに呼び出されるコードのブロックとしてコールバックを設定できます。 また、 <b>onclose =（proc）</b>メソッドを作成します。このメソッドは、接続が閉じられたときに呼び出されるコールバックを決定します。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     <code><font color="#0000ff">module</font> TestClient&lt;br/&gt; <font color="#0000ff">include</font> EM::P::ObjectProtocol&lt;br/&gt; &lt;br/&gt; <font color="#696969">#on object received callback</font> &lt;br/&gt; <font color="#0000ff">def</font> <font color="#cc6633">receive_object</font> (obj)&lt;br/&gt;    @onresponse. <b>call</b> (obj)&lt;br/&gt; <font color="#0000ff">p</font> <font color="#008000">"Client received object: #{obj.inspect}"</font> &lt;br/&gt; <font color="#0000ff">end</font> &lt;br/&gt; &lt;br/&gt; <font color="#0000ff">def</font> <font color="#cc6633">send_request</font> obj, &amp;block&lt;br/&gt;    @onresponse = block&lt;br/&gt;    send_object obj&lt;br/&gt; <font color="#0000ff">end</font> &lt;br/&gt; &lt;br/&gt; <font color="#696969"># on disconnect callback</font> &lt;br/&gt; <font color="#0000ff">def</font> <font color="#cc6633">onclose</font> =( <font color="#0000ff">proc</font> )&lt;br/&gt;    @onclosed = <font color="#0000ff">proc</font> &lt;br/&gt; <font color="#0000ff">end</font> &lt;br/&gt; &lt;br/&gt; <font color="#0000ff">def</font> <font color="#cc6633">unbind</font> &lt;br/&gt;    @onclosed.call&lt;br/&gt; <font color="#0000ff">end</font> &lt;br/&gt; &lt;br/&gt; <font color="#0000ff">end</font> &lt;br/&gt;</code>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
     
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     これで、記述されたコードをテストできるメソッドの作成に進むことができます。 最初のメソッド<b>start_serv</b>は、サーバー、テストクライアント、およびプロキシの<b>起動</b>を担当し、引数としてブロックを取ります。これにより、クライアント変数を自由に使用でき、クライアントを操作できます。 何かがうまくいかず、クライアントがサーバーから応答を受け取らない場合、 <b>タイマー</b>メソッドが必要です。rspecは、テストがフリーズしただけでなく失敗したことを示します。 テストの基本は<b>server_test</b>メソッドです。このメソッドは上記のメソッドを使用してサーバー、クライアント、プロキシを起動し、接続が閉じられたときにリアクターを停止する必要があると判断し、クライアントからサーバーに送信される引数も取ります。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     <code><font color="#0000ff">module</font> HelperMethods&lt;br/&gt; <font color="#0000ff">def</font> <font color="#cc6633">start_serv</font> &lt;br/&gt; <font color="#cc6633">File</font> .unlink(SOCK_FILE) <font color="#0000ff">if</font> <font color="#cc6633">File</font> .exists?(SOCK_FILE)&lt;br/&gt;    EM.run {&lt;br/&gt;      EventMachine.start_server <font color="#008000">"127.0.0.1"</font> , <font color="#008000">8080</font> , SocketServer&lt;br/&gt;      EventMachine.start_unix_domain_server(SOCK_FILE, DaemonServer)&lt;br/&gt;      client = EM.connect_unix_domain(SOCK_FILE, TestClient)&lt;br/&gt; <font color="#0000ff">yield</font> client&lt;br/&gt;    }&lt;br/&gt; <font color="#0000ff">end</font> &lt;br/&gt; &lt;br/&gt; <font color="#696969"># if request takes to long it will show fail</font> &lt;br/&gt; <font color="#0000ff">def</font> <font color="#cc6633">timer</font> start&lt;br/&gt;    timeout = <font color="#008000">6</font> &lt;br/&gt;    EM.add_timer(timeout){&lt;br/&gt;      ( <font color="#cc6633">Time</font> .now-start).should be_within( <font color="#008000">0</font> ).of(timeout)&lt;br/&gt;      EM.stop&lt;br/&gt;    }&lt;br/&gt; <font color="#0000ff">end</font> &lt;br/&gt; &lt;br/&gt; <font color="#696969">#main wrapper for test starts server daemon and client</font> &lt;br/&gt; <font color="#0000ff">def</font> <font color="#cc6633">server_test</font> request&lt;br/&gt;    time = <font color="#cc6633">Time</font> .now&lt;br/&gt; <font color="#cc6633">start_serv</font> <font color="#0000ff">do</font> |client|&lt;br/&gt;      client.send_request request <font color="#0000ff">do</font> |response|&lt;br/&gt; <font color="#0000ff">yield</font> response&lt;br/&gt; <font color="#0000ff">end</font> &lt;br/&gt;      client.onclose= <font color="#0000ff">lambda</font> {EM.stop}&lt;br/&gt; <font color="#cc6633">timer</font> (time)&lt;br/&gt; <font color="#0000ff">end</font> &lt;br/&gt; <font color="#0000ff">end</font> &lt;br/&gt; <font color="#0000ff">end</font> &lt;br/&gt;</code>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
     
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     例として、このタスクが正しく実行されることをテストで確認します。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     <code>describe <font color="#008000">"on sending test request"</font> <font color="#0000ff">do</font> &lt;br/&gt; <font color="#0000ff">include</font> HelperMethods&lt;br/&gt; it <font color="#008000">"should responsend with right answer"</font> <font color="#0000ff">do</font> &lt;br/&gt;    server_test({ <font color="#008000">'id'</font> =&gt; <font color="#008000">0</font> , <font color="#008000">'text'</font> =&gt; <font color="#008000">"req1"</font> }) <font color="#0000ff">do</font> |response|&lt;br/&gt;      response[ <font color="#008000">'text'</font> ].should == <font color="#008000">"answ1"</font> &lt;br/&gt;      response[ <font color="#008000">'id'</font> ].should == <font color="#008000">0</font> &lt;br/&gt; <font color="#0000ff">end</font> &lt;br/&gt; <font color="#0000ff">end</font> &lt;br/&gt; <font color="#0000ff">end</font> &lt;br/&gt;</code>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
     
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     実際、この記事が誰かに役立つことを願っています。 すべてのコードは<a href="https://github.com/playa/em_proxy_example">githubで</a>入手できます。 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      PS最後まで読書をマスターしてくれた多くのテキストが見つかりました、ありがとう。 </div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../J126226/index.html">プログラミング以外の本を読んでいますか？</a></li>
<li><a href="../J126227/index.html">抽象化と「抽出メソッド」リファクタリングメソッドについて</a></li>
<li><a href="../J126228/index.html">Emacsでのパッケージ管理</a></li>
<li><a href="../J126229/index.html">GNU著作権およびライセンスコレクション</a></li>
<li><a href="../J126230/index.html">サウンドデザインの基礎：古代エジプトのサイバーパンク</a></li>
<li><a href="../J126233/index.html">テーブル内のレコード数はどのようにしてわかりますか？</a></li>
<li><a href="../J126235/index.html">歌手ビョークは、iPhone / iPad用の「アルバムアプリ」をリリースしました</a></li>
<li><a href="../J126236/index.html">Firefox 6.0</a></li>
<li><a href="../J126237/index.html">MPP5 PPPoEサーバーの負荷分散</a></li>
<li><a href="../J126238/index.html">私の運動。 PaintUp-マルチカラースケッチの着色</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter70218013 = new Ya.Metrika({
                  id:70218013,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/70218013" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'G-FEDBM7F51Q', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Clever Geek | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <div class="company-info js-company-info" itemscope="" itemtype="http://schema.org/Organization">
      <span itemprop="name">Western Town Media (WTM)</span>
      <div itemprop="address" itemscope="" itemtype="http://schema.org/PostalAddress">
        <span itemprop="streetAddress">1968 Stoney Lonesome Road</span>
        <br>
        <span itemprop="postalCode">PA 18640</span>
        <span itemprop="addressLocality">Pittston, USA</span>
      </div>
      <span itemprop="telephone">570-362-1316</span>
    </div>
    <script type="application/ld+json">
      {
        "@context": "http://schema.org",
        "@type": "Organization",
        "address": {
          "@type": "PostalAddress",
          "addressLocality": "Pittston, USA",
          "postalCode": "PA 18640",
          "streetAddress": "1968 Stoney Lonesome Road"
        },
        "name": "Western Town Media (WTM)",
        "telephone": "570-362-1316"
      }
    </script>
  </div>
</footer>
  
</body>

</html>